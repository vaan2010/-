<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>資產總覽</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/192/wallet.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/wallet.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000; --card-bg: #1c1c1e; --text-primary: #ffffff; --text-secondary: #8e8e93;
            --color-bank: #64d2ff; --color-stock: #bf5af2; --color-twstock: #0a84ff; --color-crypto: #ff9f0a; --color-debt: #ff453a;
            --color-up: #30d158; --color-down: #ff453a; --border-color: #2c2c2e;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; user-select: none; overflow-x: hidden; }
        body::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; }
        body { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        *::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        *::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        * { scrollbar-width: none !important; -ms-overflow-style: none !important; }
        *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        *::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        *::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow-y: auto; overflow-x: hidden; position: relative; scrollbar-width: none; -ms-overflow-style: none; -webkit-overflow-scrolling: touch; width: 100%; padding-top: 150px; }
        .main-content::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        .main-content::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        .main-content::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        
        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #1c1c1e; z-index: 999; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 2px 0 15px rgba(0,0,0,0.5); padding-top: max(20px, env(safe-area-inset-top)); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar.active { left: 0; }
        @media (min-width: 768px) {
            .sidebar-overlay { display: block !important; }
            .sidebar { position: fixed; left: -280px; z-index: 999; }
            .sidebar.active { left: 0; }
            .sidebar:not(.collapsed):not(.active) { left: 0; }
            .sidebar.collapsed { left: -280px; }
        }
        
        .content-grid { display: flex; flex-direction: column; width: 100%; max-width: 100%; overflow-x: hidden; min-height: 0; }
        .chart-section { display: flex; flex-direction: column; flex-shrink: 0; width: 100%; max-width: 100%; min-width: 0; }
        .list-section { flex: 0 1 auto; overflow-y: visible; min-height: 0; position: relative; width: 100%; max-width: 100%; min-width: 0; }
        .list-section::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
        .list-section::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
        .list-section::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
        .page-nav-arrow { display: none; }
        
        @media (min-width: 768px) {
            .list-section { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
            .list-container { position: relative; margin: 0 60px 10px 60px !important; }
            .page-nav-arrow { 
                display: flex; 
                position: absolute; 
                top: 50%; 
                transform: translateY(-50%); 
                z-index: 100; 
                width: 50px; 
                height: 50px; 
                border-radius: 50%; 
                background: transparent; 
                border: none; 
                color: rgba(255, 255, 255, 0.5); 
                font-size: 28px; 
                cursor: pointer; 
                align-items: center; 
                justify-content: center; 
                transition: all 0.3s; 
            }
            .page-nav-arrow:hover { 
                color: rgba(255, 255, 255, 0.9); 
                background: rgba(255, 255, 255, 0.05); 
                transform: translateY(-50%) scale(1.1); 
            }
            .page-nav-arrow:active { 
                transform: translateY(-50%) scale(0.95); 
            }
            .page-nav-arrow.disabled { 
                opacity: 0.15; 
                cursor: not-allowed; 
                pointer-events: none; 
            }
            .page-nav-arrow.prev { left: 5px; }
            .page-nav-arrow.next { right: 5px; }
            .hamburger-btn { display: none !important; }
            .sidebar-toggle-btn-desktop { display: block !important; }
            .sidebar.collapsed .sidebar-header, .sidebar.collapsed .sidebar-menu { opacity: 0; pointer-events: none; }
            .main-content { display: grid; grid-template-rows: auto 1fr; overflow: hidden; width: 100%; padding-top: 150px; }
            .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; overflow-y: auto; height: 100%; scrollbar-width: none; -ms-overflow-style: none; align-items: start; }
            .content-grid::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; background: transparent !important; }
            .content-grid::-webkit-scrollbar-track { display: none !important; background: transparent !important; }
            .content-grid::-webkit-scrollbar-thumb { display: none !important; background: transparent !important; }
            .chart-section { height: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
            .summary-card { text-align: center !important; padding: 0 !important; margin-bottom: 20px; width: 100%; }
            .list-section { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; }
            .list-section .page-container { width: 100%; }
            .list-section .group-header { text-align: left; }
            .list-section .page-container > div:first-child.group-header { margin-top: 0; }
            body { padding-bottom: 0; }
            .tab-bar { position: fixed; bottom: 0; width: 100%; left: 0; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 40px; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); z-index: 200; }
            .tab-bar .tab-item { width: auto; padding: 0 30px; font-size: 14px; }
            .tab-bar .tab-item i { font-size: 18px; }
            .modal { align-items: center; justify-content: center; display: flex; }
            .modal-content-wrapper { width: 500px !important; height: 80% !important; max-height: 700px; border-radius: 16px; border: 1px solid var(--border-color); position: relative !important; overflow: hidden; display: flex; flex-direction: column; }
            #chartWrapper { max-width: 100%; overflow: hidden; padding: 0 10px; flex: 0 0 auto; min-height: 320px; width: 100%; }
            #assetChart { max-width: 100% !important; width: 100% !important; height: 100% !important; min-width: 0; min-height: 0; }
            #chartWrapper .highcharts-container { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
            #chartWrapper .highcharts-root { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
            #chartWrapper svg { max-width: 100% !important; height: auto !important; }
        }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--bg-color); position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 60px; width: 100%; }
        .navbar h1 { font-size: 20px; margin: 0; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .btn-group { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; color: #0a84ff; font-size: 20px; cursor: pointer; padding: 5px; }
        .btn-icon.active { color: var(--color-up); }

        .sidebar-toggle-btn-desktop { display: none; }
        .sidebar-toggle-btn-navbar { display: none; }
        @media (min-width: 768px) {
            .sidebar-toggle-btn-desktop { display: block !important; position: fixed; top: 15px; left: 20px; z-index: 1001; }
            .sidebar.collapsed .sidebar-toggle-btn-desktop { display: none !important; }
            .sidebar-toggle-btn-navbar { display: none !important; }
            .sidebar.collapsed ~ .main-content .sidebar-toggle-btn-navbar { display: block !important; position: absolute; top: 50%; transform: translateY(-50%); left: 20px; z-index: 1001; }
            .navbar .btn-group { margin-left: 50px; }
        }
        .sidebar-header { padding: 20px 25px; border-bottom: 1px solid #2c2c2e; transition: opacity 0.3s; }
        .sidebar-header h2 { margin: 0; font-size: 24px; font-weight: 700; color: #fff; }
        .sidebar-menu { padding: 10px 0; flex: 1; overflow-y: auto; transition: opacity 0.3s; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; font-size: 17px; color: #fff; cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: #2c2c2e; }
        .menu-item i { margin-right: 15px; width: 24px; text-align: center; color: #0a84ff; font-size: 20px; }
        .menu-text { flex: 1; }
        .menu-label { padding: 15px 25px 5px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; margin-top: 10px; }

        /* chart-section 樣式在 content-grid 中定義 */
        .summary-card { padding: 5px 20px 0 20px; text-align: center; position: relative; z-index: 90; flex-shrink: 0; min-height: 0; }
        .total-label-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .total-label { color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .total-amount-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .total-amount { font-size: 40px; font-weight: 700; margin: 5px 0 3px 0; margin-left: 30px; font-family: 'Roboto', sans-serif; }
        .eye-toggle-btn { background: none; border: none; color: #0a84ff; font-size: 16px; cursor: pointer; padding: 4px; display: flex; align-items: center; justify-content: center; }
        .eye-toggle-btn:hover { opacity: 0.8; }
        
        /* 隱藏數字樣式 */
        .numbers-hidden .numbers-content {
            visibility: hidden;
            position: relative;
        }
        .numbers-hidden .numbers-content::after {
            content: '****';
            visibility: visible;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: inherit;
            font-weight: inherit;
            border-radius: inherit;
        }
        /* 只有原本有背景的元素才顯示背景 */
        .numbers-hidden .rate-badge::after,
        .numbers-hidden .pnl-badge::after {
            background-color: var(--card-bg);
        }
        .numbers-hidden .total-amount::after { font-size: 40px; }
        .numbers-hidden .pnl-badge::after { font-size: 14px; }
        .numbers-hidden .rate-badge::after { font-size: 12px; }
        .numbers-hidden .group-total::after { font-size: inherit; }
        .numbers-hidden .group-pnl::after { font-size: 11px; }
        
        /* 列表項目單獨隱藏 */
        .item-hidden .item-numbers {
            visibility: hidden;
            position: relative;
        }
        .item-hidden .item-numbers::after {
            content: '****';
            visibility: visible;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: inherit;
            font-weight: inherit;
        }
        .item-hidden .amount-val.item-numbers::after { font-size: 17px; }
        .item-hidden .amount-pnl.item-numbers::after { font-size: 11px; }
        .item-eye-btn {
            background: none;
            border: none;
            color: #0a84ff;
            font-size: clamp(10px, 1.5vw, 14px);
            cursor: pointer;
            padding: clamp(2px, 0.3vw, 4px);
            margin-left: clamp(1px, 0.3vw, 4px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
            min-width: clamp(18px, 2.5vw, 24px);
        }
        .item-eye-btn:hover {
            opacity: 1;
        }
        .item-amount-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 4px;
        }
        .pnl-badge { font-size: 14px; font-weight: 600; margin-bottom: 5px; display: inline-block; padding: 4px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        .pnl-up { color: var(--color-up); } .pnl-down { color: var(--color-down); }
        .rate-info { display: flex; justify-content: center; gap: 10px; margin-top: 3px; margin-bottom: 5px; }
        .rate-badge { display: inline-flex; align-items: center; font-size: 12px; color: var(--text-secondary); background: #1c1c1e; padding: 4px 10px; border-radius: 12px; }
        .rate-badge i { font-size: 10px; margin-right: 5px; color: #ffcc00; }

        #chartWrapper { flex: 0 0 auto; background: transparent; position: relative; min-height: 280px; max-height: 40vh; width: 100%; max-width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; z-index: 80; box-sizing: border-box; padding: 0 10px; margin: auto 0; }
        #assetChart { max-width: 100% !important; box-sizing: border-box !important; width: 100% !important; height: 100% !important; min-width: 0; min-height: 0; }
        #chartWrapper .highcharts-container { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
        #chartWrapper .highcharts-root { max-width: 100% !important; overflow: hidden !important; width: 100% !important; height: 100% !important; }
        #chartWrapper svg { max-width: 100% !important; height: auto !important; }
        #chartWrapper .highcharts-point { transition: none !important; pointer-events: auto !important; }
        #chartWrapper .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper .highcharts-series .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper svg .highcharts-point:hover { opacity: 1 !important; filter: brightness(1) !important; fill-opacity: 1 !important; }
        #chartWrapper .highcharts-point * { pointer-events: none !important; }
        #chartWrapper .highcharts-data-label { opacity: 1 !important; transition: none !important; }
        #chartWrapper .highcharts-point:hover ~ .highcharts-data-label,
        #chartWrapper .highcharts-point:hover + .highcharts-data-label,
        #chartWrapper .highcharts-point:hover .highcharts-data-label { opacity: 1 !important; }
        #chartWrapper .highcharts-data-label text { fill: #fff !important; opacity: 1 !important; }
        #chartWrapper .highcharts-point:hover ~ .highcharts-data-label text,
        #chartWrapper .highcharts-point:hover + .highcharts-data-label text,
        #chartWrapper .highcharts-point:hover .highcharts-data-label text { fill: #fff !important; opacity: 1 !important; }
        
        #customTooltip { position: absolute; background: rgba(255, 255, 255, 0.95); color: #000; padding: 10px 14px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); pointer-events: none; z-index: 200; display: none; white-space: nowrap; top: 0; left: 0; transform: translate(-50%, -100%); transition: opacity 0.15s, top 0.15s, left 0.15s; margin-top: -15px; }
        #customTooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(255,255,255,0.95) transparent transparent transparent; }
        #customTooltip.bottom { transform: translate(-50%, 0); margin-top: 20px; }
        #customTooltip.bottom::after { top: -12px; border-color: transparent transparent rgba(255,255,255,0.95) transparent; }
        .tt-header { font-size: 11px; color: #666; margin-bottom: 2px; font-weight: 500; }
        .tt-body { font-size: 15px; color: #000; font-weight: 700; display: flex; align-items: center; }
        .tt-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .chart-back-btn { position: absolute; top: 10px; left: 20px; z-index: 201; background: rgba(44, 44, 46, 0.9); color: #0a84ff; border: 1px solid #333; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: none; backdrop-filter: blur(10px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .group-header { padding: 15px 20px 8px 20px; font-size: 13px; color: var(--text-secondary); background-color: var(--bg-color); display: flex; justify-content: space-between; text-transform: uppercase; }
        .group-total { color: var(--text-primary); font-weight: 600; display: block;} .group-pnl { font-size: 11px; display: block; margin-top: 2px; text-align: right;}
        .list-container { background-color: var(--card-bg); border-radius: 12px; margin: 0 16px 10px 16px; overflow: hidden; }
        .list-item { display: flex; align-items: flex-start; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: var(--card-bg); min-width: 0; position: relative; }
        /* 總覽頁面：讓標題和金額對齊 */
        #group-overview .list-item { align-items: center; }
        .list-item:last-child { border-bottom: none; } .list-item:active { background-color: #2c2c2e; }
        .list-item:has(.item-name-row) { padding-top: 40px; }
        .list-item:has(.item-name-row) .item-icon { align-self: flex-start; margin-top: 0; }
        .item-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; flex-shrink: 0; align-self: flex-start; margin-top: 0; overflow: hidden; }
        .item-icon img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .icon-bank { color: var(--color-bank); background: rgba(100, 210, 255, 0.15); } .icon-crypto { color: var(--color-crypto); background: rgba(255, 159, 10, 0.15); } .icon-stock { color: var(--color-stock); background: rgba(191, 90, 242, 0.15); } .icon-twstock { color: var(--color-twstock); background: rgba(10, 132, 255, 0.15); } .icon-debt { color: var(--color-debt); background: rgba(255, 69, 58, 0.15); }
        .item-content { flex: 1 1 0%; min-width: 0; display: flex; flex-direction: column; justify-content: flex-start; }
        .item-name-row { display: flex; align-items: center; margin-bottom: 0; position: absolute; left: 0; right: 0; padding-left: 67px; padding-right: 50px; top: 12px; z-index: 1; }
        .item-name-row .item-name { font-size: 19px; font-weight: 500; line-height: 1.3; flex: 1; }
        .item-name-row .item-eye-wrapper { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); z-index: 3; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .item-name-row .item-eye-btn { margin: 0; }
        .item-name-row .item-balance-below-eye { font-size: 12px; color: var(--text-secondary); opacity: 0.7; white-space: nowrap; }
        .item-symbol-row { font-size: 13px; color: var(--text-secondary); opacity: 0.7; margin-top: 0; margin-bottom: 0; padding-left: 67px; padding-right: 16px; position: absolute; top: 38px; left: 0; right: 0; z-index: 1; display: flex; flex-direction: column; gap: 0; }
        .item-symbol-row .symbol-text-row { min-height: 18px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .item-symbol-row .symbol-text { font-size: 13px; color: var(--text-secondary); opacity: 0.7; display: inline-block; }
        .item-symbol-row .symbol-balance { font-size: 13px; color: var(--text-secondary); opacity: 0.7; margin-left: auto; }
        .item-symbol-row .symbol-spacer { height: 3px; visibility: hidden; }
        /* 美股：增加 symbol-spacer 的高度，增加垂直間距 */
        #group-stock .item-symbol-row .symbol-spacer { height: 6px; }
        /* 台股：比照美股，增加 symbol-spacer 的高度 */
        #group-twstock .item-symbol-row .symbol-spacer { height: 6px; }
        /* 美股：確保右側空白行與左側 symbol-spacer 對齊 */
        #group-stock .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        /* 台股：比照美股，確保右側空白行與左側 symbol-spacer 對齊 */
        #group-twstock .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        /* 加密貨幣：比照美股，確保右側空白行與左側 symbol-spacer 對齊 */
        #group-crypto .item-amount .amount-spacer { min-height: 6px; height: 6px; line-height: 6px; }
        .item-symbol-row > div { min-height: 18px; display: flex; align-items: center; }
        .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 20px; }
        /* 美股：增加更多垂直空間，避免內容溢出 */
        #group-stock .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 30px; min-height: 140px; }
        /* 台股：比照美股，增加更多垂直空間，避免內容溢出 */
        #group-twstock .list-item:has(.item-name-row) { padding-top: 50px; padding-bottom: 30px; min-height: 140px; }
        .list-item:has(.item-name-row) .item-icon { position: absolute; left: 16px; top: 20px; z-index: 2; display: flex; align-items: center; justify-content: center; }
        .item-detail-row { display: flex; flex-direction: column; margin-top: 3px; gap: 0; }
        .item-detail-row > div { min-height: 18px; display: flex; align-items: center; }
        .list-item:has(.item-name-row) .item-amount-name-row { height: 0; margin-bottom: 0; }
        .item-amount-name-row { height: 19px; margin-bottom: 3px; flex-shrink: 0; }
        .item-name { font-size: 19px; font-weight: 500; margin-bottom: 3px; line-height: 1.3; }
        .item-name .symbol-small { font-size: 13px; font-weight: 400; opacity: 0.7; margin-left: 6px; }
        .item-row { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; margin-bottom: 2px; }
        .item-row-compact { font-size: 11px; color: var(--text-secondary); line-height: 1.25; margin-bottom: 2px; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; width: 100%; }
        .item-row-compact .item-label { opacity: 0.7; flex-shrink: 0; }
        .item-row-compact span { white-space: nowrap; min-width: 0; }
        .item-row-compact .price-label { margin-right: 4px; }
        .item-row-compact > span:last-child { margin-left: auto; }
        .price-label { font-size: 11px; color: var(--text-secondary); opacity: 0.7; margin-right: 4px; flex-shrink: 0; }
        .item-amount-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 0; margin-left: 8px; flex-shrink: 0; }
        .item-amount-name-row { height: 19px; margin-bottom: 3px; }
        .item-amount { text-align: right; display: flex; flex-direction: column; justify-content: flex-start; min-width: 0; gap: 0; align-items: flex-end; }
        .item-amount > div { min-height: 18px; display: flex; align-items: center; justify-content: flex-end; width: 100%; }
        .amount-val-wrapper { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        /* 總覽和銀行分頁：讓眼睛按鈕對齊到金額中線 */
        #group-overview .amount-val-wrapper, #group-bank .amount-val-wrapper { align-items: center; }
        #group-overview .item-eye-btn, #group-bank .item-eye-btn { align-self: center; }
        .amount-val { font-size: 18px; font-weight: 500; font-family: 'Roboto', sans-serif; line-height: 1.3; margin-bottom: 3px; white-space: nowrap; }
        /* 總覽頁面：讓金額和標題對齊 */
        #group-overview .list-item { align-items: baseline; }
        #group-overview .item-content { display: flex; flex-direction: column; justify-content: flex-start; }
        #group-overview .item-amount-wrapper { align-items: flex-start; }
        #group-overview .amount-val-wrapper { align-items: baseline; }
        #group-overview .amount-val { font-size: 19px; line-height: 1.3; margin-bottom: 3px; }
        /* 銀行分頁：讓金額和標題對齊 */
        #group-bank .list-item { align-items: baseline; }
        #group-bank .item-content { display: flex; flex-direction: column; justify-content: flex-start; }
        #group-bank .item-amount-wrapper { align-items: flex-start; }
        #group-bank .amount-val-wrapper { align-items: baseline; }
        #group-bank .amount-val { font-size: 19px; line-height: 1.3; margin-bottom: 3px; }
        .amount-pnl { font-size: 11px; margin-top: 0; margin-bottom: 1px; font-weight: 500; line-height: 1.3; white-space: nowrap; text-align: right; }
        /* 美股：增加行間距 */
        #group-stock .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        /* 台股：比照美股，增加行間距 */
        #group-twstock .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        /* 加密貨幣：比照美股，增加行間距 */
        #group-crypto .item-row-compact { margin-bottom: 4px; line-height: 1.4; }
        
        .amount-spacer { font-size: 13px; line-height: 1.35; color: transparent; margin: 0; padding: 0; min-height: 1.35em; display: block; }
        .amount-spacer::before { content: '\00a0'; }
        .amount-spacer { font-size: 13px; line-height: 1.35; visibility: hidden; height: 0; }
        .amount-green { color: var(--color-up); } .amount-red { color: var(--color-down); } .sub-green { color: var(--color-up); } .sub-red { color: var(--color-down); }
        .drag-handle { display: none; color: #666; font-size: 20px; padding-left: 15px; cursor: grab; }
        /* 排序模式下，整個卡片可以拖動 */
        .list-item:has(.drag-handle) { cursor: grab; }
        .list-item:has(.drag-handle):active { cursor: grabbing; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 200; }
        .tab-item { color: var(--text-secondary); text-align: center; font-size: 10px; background: none; border: none; width: 30%; }
        .tab-item i { font-size: 20px; margin-bottom: 4px; display: block; } .tab-item.active { color: #0a84ff; }
        .fa-spin-fast { animation: fa-spin 1s infinite linear; }
        
        /* Currency Toggle Button */
        .currency-toggle-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 199;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            gap: 2px;
        }
        .currency-toggle-btn:hover {
            transform: scale(1.05);
            background: rgba(28, 28, 30, 0.9);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        .currency-toggle-btn:active {
            transform: scale(0.95);
        }
        .currency-toggle-btn i {
            font-size: 18px;
            margin: 0;
        }
        .currency-toggle-btn span {
            font-size: 11px;
            line-height: 1;
        }
        @media (max-width: 767px) {
            .currency-toggle-btn {
                bottom: 80px;
                right: 15px;
                width: 56px;
                height: 56px;
            }
        }

        /* Page Swiper */
        .page-swiper { position: relative; width: 100%; overflow: hidden; touch-action: pan-y; }
        @media (max-width: 767px) {
            .list-section.page-swiper { overflow: visible; touch-action: auto; }
        }
        .page-container { display: flex; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); will-change: transform; }
        .page-item { min-width: 100%; flex-shrink: 0; }
        .page-indicator { 
            display: flex; 
            justify-content: center;
            align-items: center;
            gap: 6px; 
            padding: 18px 20px 16px 20px; 
            position: fixed; 
            top: 60px; 
            left: 0;
            right: 0;
            z-index: 95; 
            background: linear-gradient(to bottom, var(--bg-color) 0%, var(--bg-color) 90%, transparent 100%);
            backdrop-filter: blur(10px);
            overflow-x: auto;
            overflow-y: hidden;
            touch-action: pan-x;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            scroll-behavior: smooth;
        }
        .page-indicator::before,
        .page-indicator::after {
            content: '';
            flex: 1 1 auto;
            min-width: 0;
            max-width: calc((100% - 300px) / 2);
        }
        @media (max-width: 600px) {
            .page-indicator::before,
            .page-indicator::after {
                display: none;
            }
            .page-indicator {
                justify-content: flex-start;
            }
        }
        .page-indicator::-webkit-scrollbar {
            display: none !important; /* Chrome, Safari, Opera */
            width: 0 !important;
            height: 0 !important;
            background: transparent !important;
        }
        .page-indicator::-webkit-scrollbar-track {
            display: none !important;
            background: transparent !important;
        }
        .page-indicator::-webkit-scrollbar-thumb {
            display: none !important;
            background: transparent !important;
        }
        .page-tab { 
            padding: 14px 22px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            background: rgba(142, 142, 147, 0.1);
            border: none;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            flex-shrink: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .page-tab.active { 
            color: #ffffff;
            background: #0a84ff;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(10, 132, 255, 0.3);
        }
        
        @media (min-width: 480px) {
            .page-tab { 
                padding: 16px 28px;
                font-size: 20px;
            }
            .page-tab.active { 
                font-size: 20px;
            }
        }
        .page-tab:active {
            transform: scale(0.95);
        }
        .page-tab:not(.active):hover {
            background: rgba(142, 142, 147, 0.2);
        }

        /* Calendar */
        .calendar-container { max-width: 600px; margin: 0 auto; background: var(--card-bg); border-radius: 12px; padding: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav-btn { background: transparent; border: none; color: var(--text-primary); font-size: 18px; cursor: pointer; padding: 8px; }
        .calendar-nav-btn:hover { color: #0a84ff; }
        .calendar-month-year { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .calendar-dropdown { font-size: 12px; opacity: 0.6; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px; }
        .calendar-weekday { text-align: center; font-size: 13px; color: var(--text-secondary); font-weight: 500; padding: 8px 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 15px; cursor: pointer; transition: all 0.2s; color: var(--text-primary); background: transparent; border: none; }
        .calendar-day:hover { background: rgba(142, 142, 147, 0.2); }
        .calendar-day.other-month { color: var(--text-secondary); opacity: 0.4; }
        .calendar-day.today { background: #0a84ff; color: #fff; font-weight: 600; }
        .calendar-day.selected { background: rgba(10, 132, 255, 0.2); color: #0a84ff; font-weight: 600; }
        .calendar-day.has-event { position: relative; }
        .calendar-day.has-event::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: #30d158; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow: hidden; }
        .modal-content-wrapper { width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; padding: 15px 20px; background: #1c1c1e; align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #2c2c2e; flex-shrink: 0; }
        .modal-title { font-size: 17px; font-weight: 600; }
        .modal-tabs { display: flex; padding: 10px 16px; gap: 10px; border-bottom: 1px solid #2c2c2e; background: #1c1c1e; flex-shrink: 0; }
        .modal-tab { flex: 1; text-align: center; padding: 8px; color: #8e8e93; font-size: 14px; font-weight: 600; border-radius: 8px; background: #2c2c2e; cursor: pointer; }
        .modal-tab.active { background: #3a3a3c; color: #fff; }
        .tab-content { display: none; padding-bottom: 40px; flex: 1; overflow-y: auto; } .tab-content.active { display: block; }
        .form-group { background: #1c1c1e; margin-top: 20px; border-radius: 12px; overflow: hidden; margin-left: 16px; margin-right: 16px; }
        .form-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .form-row:last-child { border-bottom: none; }
        .form-label { font-size: 16px; color: #fff; min-width: 80px; }
        .form-input { background: transparent; border: none; color: var(--text-secondary); text-align: right; font-size: 16px; outline: none; width: 100%; }
        select.form-input { appearance: none; direction: rtl; }
        .delete-btn-area { margin-top: 30px; padding: 0 16px; padding-bottom: 50px; }
        .btn-delete { width: 100%; background: #1c1c1e; color: var(--color-debt); border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 500; }
        .hint-text { color: #555; font-size: 12px; margin-top: 8px; padding: 0 20px; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #30d158; color: #000; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 14px; z-index: 2000; display: none; }
        .ai-btn-area { margin: 15px 16px 0 16px; }
        .btn-ai { width: 100%; background: linear-gradient(135deg, #0a84ff, #5e5ce6); color: #fff; border: none; padding: 12px; border-radius: 12px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-ai:disabled { background: #3a3a3c; color: #8e8e93; cursor: not-allowed; opacity: 0.6; }
        .progress-container { width: 100%; height: 4px; background: #2c2c2e; border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0a84ff, #5e5ce6); width: 0%; transition: width 0.3s ease; border-radius: 2px; }

        /* Detail View */
        #detailView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #detailView.active { transform: translateX(0); }
        .detail-header { padding: 10px 20px 20px; border-bottom: 1px solid #2c2c2e; background: #1c1c1e; flex-shrink: 0; }
        #detailView .navbar { position: relative; z-index: 1; }
        .detail-title { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .detail-subtitle { font-size: 14px; color: #8e8e93; }
        .detail-stats { display: flex; justify-content: space-between; margin-top: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-val { font-size: 18px; font-weight: 600; display: block; color: #fff; }
        .stat-lbl { font-size: 12px; color: #8e8e93; margin-top: 4px; display: block; }
        .val-green { color: var(--color-up); } .val-red { color: var(--color-down); }
        .detail-list { flex: 1; overflow-y: auto; padding: 15px; }
        .tx-item { background: #1c1c1e; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #2c2c2e; }
        .tx-header-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .tx-badge { background: #64d2ff; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .tx-date { color: #8e8e93; font-size: 13px; }
        .tx-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; }
        .tx-label { color: #8e8e93; }
        .tx-val { color: #fff; font-weight: 500; }
        .tx-pnl { font-weight: bold; font-size: 14px; }
        .tx-no-data { text-align: center; color: #666; padding: 30px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div id="migrationToast" class="toast">資料已還原</div>
    <div id="importProgressToast" class="toast" style="background: #0a84ff; display: none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                <div id="importProgressBar" style="height: 100%; background: #fff; width: 0%; transition: width 0.3s;"></div>
            </div>
            <span id="importProgressText">匯入中...</span>
        </div>
    </div>
    <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleFileImport(event)">
    <div id="refreshStockOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1999; display: none; backdrop-filter: blur(4px);"></div>
    <div id="refreshStockProgressToast" class="toast" style="background: #0a84ff; display: none; z-index: 2001;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                <div id="refreshStockProgressBar" style="height: 100%; background: #fff; width: 0%; transition: width 0.3s;"></div>
            </div>
            <span id="refreshStockProgressText">重新整理中...</span>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar & Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="sidebar">
            <button class="btn-icon sidebar-toggle-btn-desktop" id="sidebarToggleBtn" onclick="toggleSidebarCollapse()" title="收合/展開選單"><i class="fas fa-bars"></i></button>
            <div class="sidebar-header"><h2>功能選單</h2></div>
            <div class="sidebar-menu">
                <div class="menu-label">更新</div>
                <div class="menu-item" onclick="refreshAllData(); toggleSidebar();"><i class="fas fa-sync-alt"></i><span class="menu-text">立即更新</span></div>
                <div class="menu-item" onclick="refreshStockInfo(); toggleSidebar();"><i class="fas fa-redo"></i><span class="menu-text">重新整理</span></div>
                <div class="menu-label">資料管理</div>
                <div class="menu-item" onclick="exportData(); toggleSidebar();"><i class="fas fa-file-export"></i><span class="menu-text">匯出備份</span></div>
                <div class="menu-item" onclick="importData(); toggleSidebar();"><i class="fas fa-file-import"></i><span class="menu-text">匯入還原</span></div>
                <div class="menu-label">API 設定</div>
                <div class="menu-item" onclick="setApiKey('finnhub'); toggleSidebar();"><i class="fas fa-chart-line"></i><span class="menu-text">Finnhub Key (美股報價)</span></div>
                <div class="menu-item" onclick="setApiKey('fugle'); toggleSidebar();"><i class="fas fa-chart-line"></i><span class="menu-text">Fugle Key (台股報價)</span></div>
                <div class="menu-item" onclick="setApiKey('gemini'); toggleSidebar();"><i class="fas fa-robot"></i><span class="menu-text">Gemini Key (讀圖)</span></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="navbar">
                <button class="btn-icon hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h1>資產總覽</h1>
                <div class="btn-group">
                    <button class="btn-icon sidebar-toggle-btn-navbar" id="sidebarToggleBtnNavbar" onclick="toggleSidebarCollapse()" title="展開選單"><i class="fas fa-bars"></i></button>
                    <button class="btn-icon" id="sortBtn" onclick="toggleEditMode()"><i class="fas fa-sort-amount-down"></i></button>
                    <button class="btn-icon" id="addBtn" onclick="openModal()"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="page-indicator">
                <button class="page-tab active" data-page="0" onclick="switchToPage(0)">總覽</button>
                <button class="page-tab" data-page="1" onclick="switchToPage(1)">銀行</button>
                <button class="page-tab" data-page="2" onclick="switchToPage(2)">美股</button>
                <button class="page-tab" data-page="3" onclick="switchToPage(3)">台股</button>
                <button class="page-tab" data-page="4" onclick="switchToPage(4)">加密</button>
            </div>

            <div class="content-grid">
                <div class="chart-section">
                    <div class="summary-card">
                        <div class="total-label-wrapper">
                            <div class="total-label" id="summaryLabel">總淨資產</div>
                        </div>
                        <div class="total-amount-wrapper">
                            <div class="total-amount numbers-content" id="totalNetWorth">--</div>
                            <button class="eye-toggle-btn" id="toggleNumbersBtn" onclick="toggleNumbers()" title="隱藏/顯示數字">
                                <i class="fas fa-eye" id="toggleNumbersIcon"></i>
                            </button>
                        </div>
                        <div id="totalPnLBlock" style="display:none;"><div class="pnl-badge numbers-content" id="totalPnLBadge">今日: +0</div></div>
                        <div class="rate-info">
                            <div class="rate-badge numbers-content"><i class="fas fa-coins"></i><span id="rateUsdt">USDT ...</span></div>
                            <div class="rate-badge numbers-content"><i class="fas fa-exchange-alt"></i><span id="rateUsd">USD ...</span></div>
                        </div>
                    </div>

                    <div id="chartWrapper">
                        <div id="customTooltip"><div class="tt-header">類別</div><div class="tt-body"><span class="tt-dot"></span>資產: 0</div></div>
                        <div id="assetChart" style="width:100%; height:100%;"></div>
                    </div>
                    
                    <!-- Currency Toggle Button -->
                    <button id="currencyToggleBtn" class="currency-toggle-btn" onclick="event.stopPropagation(); toggleCurrency();" title="切換幣別">
                        <i class="fas fa-exchange-alt"></i>
                        <span id="currencyToggleText">TWD</span>
                    </button>
                </div>

                <div class="list-section page-swiper" id="pageSwiper">
                    <button class="page-nav-arrow prev" id="prevPageBtn" onclick="switchToPrevPage()" aria-label="上一頁">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="page-nav-arrow next" id="nextPageBtn" onclick="switchToNextPage()" aria-label="下一頁">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="page-container" id="pageContainer">
                        <div class="page-item" data-page="0">
                    <div id="assetsContainer"></div>
                        </div>
                        <div class="page-item" data-page="1">
                            <div id="assetsContainer1"></div>
                        </div>
                        <div class="page-item" data-page="2">
                            <div id="assetsContainer2"></div>
                        </div>
                        <div class="page-item" data-page="3">
                            <div id="assetsContainer3"></div>
                        </div>
                        <div class="page-item" data-page="4">
                            <div id="assetsContainer4"></div>
                        </div>
                    </div>
                    <div id="debtContainer" style="margin-top: 20px;"></div>
                    <div style="height: 60px;" class="mobile-spacer"></div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendarPage" style="display: none; padding: 20px; overflow-y: auto; height: 100%;">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div class="calendar-month-year">
                            <span id="calendarMonthYear">2025年11月</span>
                            <i class="fas fa-chevron-down calendar-dropdown"></i>
                        </div>
                        <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarTodayDate" style="text-align: center; font-size: 18px; font-weight: 600; color: var(--text-primary); margin: 15px 0;"></div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">週日</div>
                        <div class="calendar-weekday">週一</div>
                        <div class="calendar-weekday">週二</div>
                        <div class="calendar-weekday">週三</div>
                        <div class="calendar-weekday">週四</div>
                        <div class="calendar-weekday">週五</div>
                        <div class="calendar-weekday">週六</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div class="tab-bar">
                <button class="tab-item active" id="assetListTab" onclick="switchToCalendarPage(false)"><i class="fas fa-wallet"></i>資產列表</button>
                <button class="tab-item" id="calendarTabBtn" onclick="switchToCalendarPage(true)"><i class="fas fa-calendar"></i>日期</button>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView">
        <div class="navbar">
            <button class="btn-icon" onclick="closeDetailView()"><i class="fas fa-arrow-left"></i></button>
            <h1 id="detailTitleName">資產詳情</h1>
            <button class="btn-icon" onclick="editCurrentAsset()"><i class="fas fa-edit"></i></button>
        </div>
        <div class="detail-header">
            <div class="detail-title" id="dName">NVDA</div>
            <div class="detail-subtitle" id="dSymbol">NVIDIA Corp</div>
            <div class="detail-stats">
                <div class="stat-item"><span class="stat-val" id="dQty">0</span><span class="stat-lbl">持有股數</span></div>
                <div class="stat-item"><span class="stat-val" id="dPrice">0</span><span class="stat-lbl">現價 (USD)</span></div>
                <div class="stat-item"><span class="stat-val" id="dVal">0</span><span class="stat-lbl">參考市值</span></div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <div id="dDailyPnl" style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: 600;">當天損益</div>
                    <span id="dDailyPnlVal" style="font-size: 20px; font-weight: 700;">+0</span>
                </div>
                <div id="dCostPnl">
                    <div style="font-size: 18px; font-weight: 600;">持股成本損益</div>
                    <span id="dCostPnlVal" style="font-size: 24px; font-weight: 700;">+0 (0%)</span>
                <div style="font-size: 12px; color: #8e8e93; margin-top: 5px;">參考損益 (含手續費)</div>
                </div>
            </div>
        </div>
        <div class="detail-list" id="detailTxList"></div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <button class="btn-icon" onclick="closeModal()">取消</button>
                <span class="modal-title" id="modalTitle">帳戶編輯</span>
                <button class="btn-icon" style="font-weight:bold;" onclick="saveAccount()">儲存</button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('basic')" id="tabBasic">基本設定</div>
                <div class="modal-tab" onclick="switchTab('detail')" id="tabDetail">庫存明細</div>
            </div>
            <div id="contentBasic" class="tab-content active">
                <div class="ai-btn-area" id="aiArea" style="display:none;">
                    <div style="margin-bottom: 10px; padding: 0 5px;">
                        <span style="font-size: 12px; color: #8e8e93;">選擇券商 (手續費率)</span>
                        <select id="brokerSelect" class="form-input" style="background: #333; border-radius: 8px; padding: 5px; margin-top: 5px;" onchange="updateFeeDisplay()">
                            <option value="cathay">國泰證券 (1.425%)</option>
                            <option value="cathay_fixed">國泰證券 (定期定額 固定1元)</option>
                            <option value="fubon">富邦證券 (0.25%)</option>
                            <option value="custom">自訂...</option>
                        </select>
                    </div>
                    <button class="btn-ai" id="btnAI" onclick="triggerImageUpload()"><i class="fas fa-camera"></i> 匯入截圖 (AI 辨識)</button>
                    <input type="file" id="imgUpload" multiple accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                    <div id="aiStatus" style="text-align:center; color:#aaa; font-size:12px; margin-top:5px;"></div>
                    <div class="progress-container" id="aiProgress">
                        <div class="progress-bar" id="aiProgressBar"></div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row"><span class="form-label">類型</span><select id="inpType" class="form-input" onchange="handleTypeChange()"><option value="bank">銀行</option><option value="crypto">加密貨幣</option><option value="stock">美股</option><option value="twstock">台股</option><option value="debt">負債</option></select></div>
                    <div class="form-row" id="rowName"><span class="form-label">名稱</span><input type="text" id="inpName" class="form-input" placeholder="例如: NVDA"></div>
                    <div class="form-row" id="rowSymbol" style="display:none;"><span class="form-label">代碼</span><input type="text" id="inpSymbol" class="form-input" placeholder="例如: NVDA" oninput="syncNameFromSymbol(); updateAIButtonState();"></div>
                    <div class="form-row" id="rowCurrency"><span class="form-label">幣別</span><select id="inpCurrency" class="form-input"><option value="TWD">TWD (新台幣)</option><option value="USD">USD (美金)</option></select></div>
                    <div class="form-row"><span class="form-label" id="lblBalance">股數</span><input type="number" id="inpBalance" class="form-input" placeholder="0"></div>
                    <div class="form-row" id="rowCost" style="display:none;"><span class="form-label">平均成本</span><input type="number" id="inpCost" class="form-input" placeholder="0"></div>
                </div>
                <div id="symbolHint" class="hint-text" style="display:none;">* 輸入代碼，預設使用美金報價</div>
                <div class="delete-btn-area"><button id="btnDelete" class="btn-delete" onclick="deleteAccount()">刪除</button></div>
            </div>
            <div id="contentDetail" class="tab-content">
                <div class="tx-list" id="txListContainer"><div class="tx-no-data">尚未匯入明細資料</div></div>
            </div>
        </div>
    </div>

<script>
    // 1. Define Constants & Globals
    const STORAGE_KEY_DATA = 'my_assets_stable_data';
    const STORAGE_KEY_SETTINGS = 'my_assets_stable_settings';
    
    const TYPE_COLORS = { 'bank': '#64d2ff', 'stock': '#bf5af2', 'twstock': '#0a84ff', 'crypto': '#ff9f0a', 'debt': '#ff453a' };
    const TYPE_NAMES = { 'bank': '銀行', 'stock': '美股', 'twstock': '台股', 'crypto': '加密貨幣', 'debt': '負債' };

    let editingId = null;
    let chartInstance = null;
    let clickTimer = null; 
    let currentDetails = {};
    let chartLevel = 'root';
    let isEditMode = false;
    let sortables = [];
    let currentDetailAcc = null;
    
    // Page Swiper
    let currentPage = 0;
    const PAGE_TYPES = ['overview', 'bank', 'stock', 'twstock', 'crypto'];
    
    // Currency Display
    let currentDisplayCurrency = localStorage.getItem('displayCurrency') || 'TWD'; // 'TWD' or 'USD'
    const PAGE_NAMES = ['總覽', '銀行/現金', '美股', '台股', '加密貨幣'];
    let touchStartX = 0;
    let touchEndX = 0;

    // 2. Define Data Loading Functions
    function safeParseFloat(val) { let v = parseFloat(val); return isNaN(v) ? 0 : v; }
    
    function tryMigrateOldData() {
        if (localStorage.getItem(STORAGE_KEY_DATA)) return;
        const oldKeys = ['myAssets_v6', 'myAssets_v5', 'myAssets_v4'];
        let found = false;
        for (let key of oldKeys) {
            let d = localStorage.getItem(key);
            if (d) { localStorage.setItem(STORAGE_KEY_DATA, d); found = true; break; }
        }
        let oldS = localStorage.getItem('myAssets_settings_v3');
        if (oldS) localStorage.setItem(STORAGE_KEY_SETTINGS, oldS);
        if (found) {
            const t = document.getElementById('migrationToast');
            t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
        }
    }
    
    // Execute Migration Immediately
    tryMigrateOldData();

    // Load State
    let rawAccounts = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || [];
    let accounts = rawAccounts.map((a, index) => ({ 
        ...a, balance: safeParseFloat(a.balance), currentPrice: safeParseFloat(a.currentPrice), 
        dayChange: safeParseFloat(a.dayChange || 0), dayChangePercent: safeParseFloat(a.dayChangePercent || 0), 
        cost: safeParseFloat(a.cost || 0), order: (a.order!==undefined)?a.order:index, transactions: a.transactions || [] 
    }));
    let settings = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { apiKey: '', fugleKey: '', geminiKey: '', usdRate: 32.5, usdtRate: 1.0, feeRate: 0.1425 };

    // 3. Define ALL Functions (Chart, UI, Logic)

    // --- Chart ---
    function onPointClick(e) { 
        e.stopPropagation(); 
        if (clickTimer) { 
            clearTimeout(clickTimer); clickTimer = null; 
            if((chartLevel==='root' || currentPage === 0) && currentDetails[this.drilldown]){ 
                hideCustomTooltip(); 
                enterDetailLevel(this.drilldown, currentDetails[this.drilldown]);
            } 
        } else { 
            let t=this; let ex=e; 
            clickTimer=setTimeout(function(){ clickTimer=null; activeInactivePoints.clear(); if(t.sliced){ t.slice(false); t.setState('normal'); const prevPointEl = t.graphic?.element; if(prevPointEl) { prevPointEl.style.setProperty('opacity', '1', 'important'); } if(t.series.data) t.series.data.forEach(p=>{ if(p!==t) { p.setState('normal'); const pEl = p.graphic?.element; if(pEl) pEl.style.setProperty('opacity', '1', 'important'); } }); hideCustomTooltip(); } else { if(t.series.data) { t.series.data.forEach(p=>{ if(p!==t){ if(p.sliced) { p.slice(false); p.setState('inactive'); const pointEl = p.graphic?.element; if(pointEl) { const pointId = pointEl.getAttribute('data-highcharts-point-index') || pointEl.getAttribute('class') || `point-${p.index}`; activeInactivePoints.add(pointId); pointEl.style.setProperty('opacity', '0.3', 'important'); } } else { p.setState('inactive'); const pointEl = p.graphic?.element; if(pointEl) { const pointId = pointEl.getAttribute('data-highcharts-point-index') || pointEl.getAttribute('class') || `point-${p.index}`; activeInactivePoints.add(pointId); pointEl.style.setProperty('opacity', '0.3', 'important'); } } } }); } t.slice(true); t.setState('normal'); const newPointEl = t.graphic?.element; if(newPointEl) { newPointEl.style.setProperty('opacity', '1', 'important'); } showCustomTooltip(t, ex); } }, 250); 
        } 
    }
    
    function showCustomTooltip(p,e){ 
        const t=document.getElementById('customTooltip'); 
        const w=document.getElementById('chartWrapper'); 
        t.querySelector('.tt-header').innerText=p.name; 
        const formattedAmount = currentDisplayCurrency === 'USD' ? parseFloat(p.y).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : Math.round(p.y).toLocaleString();
        t.querySelector('.tt-body').innerHTML=`<span class="tt-dot" style="background-color:${p.color}"></span>資產: ${formattedAmount} ${currentDisplayCurrency}`; 
        t.className=''; t.style.display='block'; 
        let cx=e.chartX; let cy=e.chartY; 
        if(!cx&&e.clientX){const r=w.getBoundingClientRect();cx=e.clientX-r.left;cy=e.clientY-r.top;} 
        const tw=t.offsetWidth; const th=t.offsetHeight; 
        let top=cy-th-25; let left=cx; 
        if(cy<160){top=cy+30;t.classList.add('bottom');}else{t.classList.remove('bottom');} 
        if(left<tw/2)left=tw/2+10; if(left>w.offsetWidth-tw/2)left=w.offsetWidth-tw/2-10; 
        t.style.top=top+'px'; t.style.left=left+'px'; 
    }
    
    function hideCustomTooltip(){ document.getElementById('customTooltip').style.display='none'; }

    function updateChartData(animate = true) { 
        if(!Highcharts)return; 
        let groups={'bank':0,'stock':0,'twstock':0,'crypto':0}; 
        currentDetails={'bank':[],'stock':[],'twstock':[],'crypto':[]}; 
        
        accounts.forEach(acc=>{ 
            if(acc.type==='debt')return; 
            let val=calculateValue(acc); 
            if(val>0){ 
                if(groups[acc.type]!==undefined){ 
                    groups[acc.type]+=val; 
                    // 美股顯示代碼，台股顯示公司名稱
                    let displayName = acc.name;
                    if(acc.type === 'stock') {
                        let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                        displayName = sym || acc.name;
                    }
                    currentDetails[acc.type].push({name:displayName,y:currentDisplayCurrency === 'USD' ? parseFloat(val) : Math.round(val)}); 
                } 
            } 
        }); 
        
        // 根據當前分頁和圖表層級決定顯示的數據
        let chartData = [];
        let chartTitle = '';
        
        if(chartLevel === 'root' || (chartLevel === 'page' && currentPage === 0)) {
            // 總覽分頁：顯示四個類別的總覽
            chartData = [{name:TYPE_NAMES['bank'],y:Math.round(groups.bank),drilldown:'bank',color:TYPE_COLORS.bank},{name:TYPE_NAMES['stock'],y:Math.round(groups.stock),drilldown:'stock',color:TYPE_COLORS.stock},{name:TYPE_NAMES['twstock'],y:Math.round(groups.twstock),drilldown:'twstock',color:TYPE_COLORS.twstock},{name:TYPE_NAMES['crypto'],y:Math.round(groups.crypto),drilldown:'crypto',color:TYPE_COLORS.crypto}].filter(d=>d.y>0);
            chartTitle = '';
        } else if(chartLevel === 'page' && currentPage > 0) {
            // 分頁模式：顯示當前分頁類別內的資產分布
            const currentType = PAGE_TYPES[currentPage];
            chartData = currentDetails[currentType] || [];
            chartTitle = PAGE_NAMES[currentPage];
        } else if(chartLevel === 'detail') {
            // 詳細模式：已經在enterDetailLevel中處理，不在此更新
            return;
        }
        
        const animationConfig = animate ? {duration:800,easing:'easeOutQuart'} : {duration:0};
        
        if(!chartInstance){ 
            chartInstance=Highcharts.chart('assetChart',{
                chart:{type:'pie',backgroundColor:'transparent',spacing:[30,20,20,20],height:'100%',width:null,reflow:true,margin:[30,20,20,20]},
                title:{text:chartTitle,style:{color:'#fff',fontSize:'14px'},align:'center',verticalAlign:'middle',y:10},
                credits:{enabled:false},tooltip:{enabled:false},
                plotOptions:{pie:{innerSize:'55%',size:'90%',center:['50%','50%'],borderWidth:0,slicedOffset:8,animation:animationConfig,dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666',softConnector:true},states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}}}},
                series:[{name:'資產',data:chartData}]
            }); 
            disableChartHover();
        } else { 
            if(chartLevel==='root' || (chartLevel==='page' && (currentPage === 0 || currentPage > 0))){ 
                chartInstance.setTitle({text:chartTitle,style:{color:'#fff',fontSize:'14px'},align:'center',verticalAlign:'middle',y:10});
                if(chartInstance.series.length===0){ 
                    chartInstance.addSeries({name:'資產',data:chartData,type:'pie',innerSize:'55%',size:'90%',center:['50%','50%'],borderWidth:0,slicedOffset:8,animation:animationConfig,dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'},states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}}}, animate); 
                    disableChartHover();
                } else { 
                    chartInstance.series[0].setData(chartData, animate);
                    // 更新圖表大小
                    chartInstance.series[0].update({size:'90%'}, false);
                } 
            } else if(chartLevel === 'detail') {
                // 詳細模式不在此更新，由enterDetailLevel處理
            } 
        } 
    }
    
    function enterDetailLevel(cat, data) { 
        chartLevel='detail'; 
        hideCustomTooltip(); 
        
        // 切換到對應的分頁（總覽是0，所以類別分頁要+1）
        const pageIndex = PAGE_TYPES.indexOf(cat);
        if(pageIndex > 0) {
            switchToPage(pageIndex);
        }
        
        if(chartInstance.series[0])chartInstance.series[0].remove(false); 
        chartInstance.addSeries({ name:TYPE_NAMES[cat]||cat, data:data, type:'pie', innerSize:'55%', size:'90%', center:['50%','50%'], borderWidth:0, slicedOffset:8, animation:{duration:800,easing:'easeOutQuart'}, colorByPoint:true, dataLabels:{enabled:true,distance:3,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'}, states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0},inactive:{opacity:0.3}}, point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},events:{click:onPointClick}} }, true);
        chartInstance.setTitle({text:TYPE_NAMES[cat],style:{color:'#fff',fontSize:'14px'},align:'center',verticalAlign:'middle',y:10}); 
        disableChartHover();
    }
    
    let hoverCheckInterval = null;
    let activeInactivePoints = new Set();
    function disableChartHover() {
        if(!chartInstance) return;
        if(hoverCheckInterval) clearInterval(hoverCheckInterval);
        const forceResetStyle = function() {
            const points = document.querySelectorAll('#chartWrapper .highcharts-point');
            points.forEach(point => {
                const pointId = point.getAttribute('data-highcharts-point-index') || point.getAttribute('class');
                if(activeInactivePoints.has(pointId)) return;
                point.style.transition = 'none';
                const computedStyle = window.getComputedStyle(point);
                const computedOpacity = parseFloat(computedStyle.opacity);
                if(computedOpacity !== 1 && computedOpacity !== 0.3) {
                    point.style.setProperty('opacity', '1', 'important');
                }
                if(computedOpacity === 0.3) {
                    activeInactivePoints.add(pointId);
                }
                if(computedStyle.filter && computedStyle.filter !== 'none' && computedStyle.filter !== 'brightness(1)' && computedOpacity !== 0.3) {
                    point.style.setProperty('filter', 'brightness(1)', 'important');
                }
            });
            const dataLabels = document.querySelectorAll('#chartWrapper .highcharts-data-label, #chartWrapper .highcharts-data-label text');
            dataLabels.forEach(label => {
                label.style.setProperty('opacity', '1', 'important');
                if(label.tagName === 'text') {
                    label.style.setProperty('fill', '#fff', 'important');
                }
            });
        };
        setTimeout(() => {
            const points = document.querySelectorAll('#chartWrapper .highcharts-point');
            points.forEach(point => {
                const pointId = point.getAttribute('data-highcharts-point-index') || point.getAttribute('class');
                point.style.transition = 'none';
                const resetStyle = function() { 
                    const id = this.getAttribute('data-highcharts-point-index') || this.getAttribute('class');
                    const computedOpacity = parseFloat(window.getComputedStyle(this).opacity);
                    if(computedOpacity !== 0.3 && !activeInactivePoints.has(id)) {
                        this.style.setProperty('opacity', '1', 'important');
                        this.style.setProperty('filter', 'brightness(1)', 'important');
                    }
                };
                point.addEventListener('mouseenter', resetStyle, {capture: true, passive: false});
                point.addEventListener('mouseover', resetStyle, {capture: true, passive: false});
            });
            hoverCheckInterval = setInterval(forceResetStyle, 16);
        }, 100);
    }
    
    function resetChartLevel() { 
        activeInactivePoints.clear(); 
        if(chartLevel === 'detail') {
            // 從詳細模式返回，根據當前分頁決定
            chartLevel = currentPage === 0 ? 'root' : 'page';
        } else {
            chartLevel = currentPage === 0 ? 'root' : 'page';
        }
        hideCustomTooltip(); 
        while(chartInstance.series.length>0)chartInstance.series[0].remove(false); 
        updateChartData(); 
        disableChartHover(); 
    }
    
    function initChart() { 
        if(typeof Highcharts==='undefined')return; 
        Highcharts.setOptions({chart:{style:{fontFamily:'sans-serif'},events:{click:function(e){if(clickTimer){clearTimeout(clickTimer);clickTimer=null;}activeInactivePoints.clear();if(this.series[0]){this.series[0].points.forEach(p=>{p.slice(false);p.setState('normal');const pEl = p.graphic?.element;if(pEl) pEl.style.setProperty('opacity', '1', 'important');});}hideCustomTooltip();}}},title:{text:''},tooltip:{enabled:false},plotOptions:{pie:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}},point:{states:{hover:{enabled:false,halo:{size:0},opacity:1,brightness:0}}}}}}); 
        updateChartData(); 
        // 確保圖表在初始化時正確渲染，特別是手機模式
        setTimeout(() => {
            if(chartInstance) {
                const chartWrapper = document.getElementById('chartWrapper');
                if(chartWrapper) {
                    const wrapperWidth = chartWrapper.clientWidth;
                    const wrapperHeight = chartWrapper.clientHeight;
                    if(wrapperWidth > 0 && wrapperHeight > 0) {
                        chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                        chartInstance.reflow();
                        // 再次確保文字正確顯示
                        setTimeout(() => {
                            if(chartInstance) {
                                chartInstance.reflow();
                            }
                        }, 100);
                    }
                }
            }
        }, 300); 
        document.getElementById('chartWrapper').addEventListener('click',function(e){const t=e.target;if(t.tagName!=='path'&&!t.closest('.highcharts-point')&&chartInstance){if(clickTimer)clearTimeout(clickTimer);activeInactivePoints.clear();if(chartInstance.series[0]){chartInstance.series[0].points.forEach(p=>{p.slice(false);p.setState('normal');const pEl = p.graphic?.element;if(pEl) pEl.style.setProperty('opacity', '1', 'important');});}hideCustomTooltip();}}); 
    }

    // --- Calculations ---
    function calculateTWD(acc) { let val=0; if(acc.isAuto){ let p=acc.currentPrice||0; if(acc.type==='twstock')val=acc.balance*p; else if(acc.currency==='USD')val=acc.balance*p*settings.usdRate; else if(acc.type==='crypto')val=acc.balance*p*settings.usdtRate*settings.usdRate; else val=acc.balance*p*settings.usdRate; } else { if(acc.currency==='USD')val=acc.balance*settings.usdRate; else val=acc.balance; } return safeParseFloat(val); }
    function calculateUSD(acc) { let val=0; if(acc.isAuto){ let p=acc.currentPrice||0; if(acc.type==='twstock')val=acc.balance*p/settings.usdRate; else if(acc.currency==='USD')val=acc.balance*p; else if(acc.type==='crypto')val=acc.balance*p*settings.usdtRate; else val=acc.balance*p; } else { if(acc.currency==='USD')val=acc.balance; else val=acc.balance/settings.usdRate; } return safeParseFloat(val); }
    function calculateValue(acc) { return currentDisplayCurrency === 'USD' ? calculateUSD(acc) : calculateTWD(acc); }
    function calculateDailyPnL_TWD(acc) { if(!acc.isAuto||!acc.dayChange)return 0; let pnl=0; if(acc.type==='twstock')pnl=acc.balance*acc.dayChange; else if(acc.currency==='USD')pnl=acc.balance*acc.dayChange*settings.usdRate; else if(acc.type==='crypto')pnl=acc.balance*acc.dayChange*settings.usdtRate*settings.usdRate; else pnl=acc.balance*acc.dayChange*settings.usdRate; return safeParseFloat(pnl); }
    function calculateDailyPnL_USD(acc) { if(!acc.isAuto||!acc.dayChange)return 0; let pnl=0; if(acc.type==='twstock')pnl=acc.balance*acc.dayChange/settings.usdRate; else if(acc.currency==='USD')pnl=acc.balance*acc.dayChange; else if(acc.type==='crypto')pnl=acc.balance*acc.dayChange*settings.usdtRate; else pnl=acc.balance*acc.dayChange; return safeParseFloat(pnl); }
    function calculateDailyPnL(acc) { return currentDisplayCurrency === 'USD' ? calculateDailyPnL_USD(acc) : calculateDailyPnL_TWD(acc); }
    function calculateCostPnL_TWD(acc) { if(!acc.cost||acc.cost<=0||!acc.isAuto)return 0; let cur=calculateTWD(acc); let cost=acc.type==='twstock'?acc.balance*acc.cost:acc.balance*acc.cost*settings.usdRate; return safeParseFloat(cur-cost); }
    function calculateCostPnL_USD(acc) { if(!acc.cost||acc.cost<=0||!acc.isAuto)return 0; let cur=calculateUSD(acc); let cost=acc.type==='twstock'?acc.balance*acc.cost/settings.usdRate:acc.balance*acc.cost; return safeParseFloat(cur-cost); }
    function calculateCostPnL(acc) { return currentDisplayCurrency === 'USD' ? calculateCostPnL_USD(acc) : calculateCostPnL_TWD(acc); }
    function calculatePnL_TWD(acc) { if(acc.cost>0&&acc.isAuto){ return calculateCostPnL_TWD(acc); } return calculateDailyPnL_TWD(acc); }
    function calculatePnL(acc) { return currentDisplayCurrency === 'USD' ? (acc.cost>0&&acc.isAuto?calculateCostPnL_USD(acc):calculateDailyPnL_USD(acc)) : calculatePnL_TWD(acc); }
    function formatAmount(val) { 
        if(currentDisplayCurrency === 'USD') {
            return parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        } else {
            return Math.round(val).toLocaleString();
        }
    }
    function formatPnL(val) { 
        if(!val)return''; 
        const sign=val>0?'+':''; 
        const cls=val>0?'pnl-up':(val<0?'pnl-down':''); 
        const formatted = currentDisplayCurrency === 'USD' ? parseFloat(val).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',') : Math.round(val).toLocaleString();
        return `<span class="${cls}">${sign}${formatted}</span>`; 
    }

    // --- UI ---
    function toggleSidebar() { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(s.classList.contains('active')){s.classList.remove('active');o.classList.remove('active');if(window.matchMedia('(min-width: 768px)').matches){s.classList.add('collapsed');}}else{s.classList.add('active');o.classList.add('active');if(window.matchMedia('(min-width: 768px)').matches){s.classList.remove('collapsed');}} }
    function toggleSidebarCollapse() { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); const isCollapsed=s.classList.contains('collapsed'); if(isCollapsed){s.classList.remove('collapsed'); if(window.matchMedia('(min-width: 768px)').matches){s.classList.add('active'); o.classList.add('active');} localStorage.setItem('sidebarCollapsed','false');}else{s.classList.add('collapsed'); if(window.matchMedia('(min-width: 768px)').matches){s.classList.remove('active'); o.classList.remove('active');} localStorage.setItem('sidebarCollapsed','true');} }
    function initSidebarState() { if(window.matchMedia('(min-width: 768px)').matches){ const collapsed=localStorage.getItem('sidebarCollapsed')==='true'; const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(collapsed){s.classList.add('collapsed'); s.classList.remove('active'); o.classList.remove('active');}else{s.classList.remove('collapsed'); s.classList.add('active'); o.classList.add('active');} } }
    function toggleEditMode() { isEditMode=!isEditMode; document.getElementById('sortBtn').classList.toggle('active', isEditMode); document.getElementById('addBtn').style.display=isEditMode?'none':'block'; renderAssets(); }
    function toggleNumbers() {
        const body = document.body;
        const icon = document.getElementById('toggleNumbersIcon');
        const isHidden = body.classList.toggle('numbers-hidden');
        icon.classList.toggle('fa-eye', !isHidden);
        icon.classList.toggle('fa-eye-slash', isHidden);
        localStorage.setItem('numbersHidden', isHidden);
    }
    function initNumbersState() {
        const isHidden = localStorage.getItem('numbersHidden') === 'true';
        const body = document.body;
        const icon = document.getElementById('toggleNumbersIcon');
        if (isHidden) {
            body.classList.add('numbers-hidden');
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            body.classList.remove('numbers-hidden');
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    function toggleItemNumbers(itemId) {
        const key = `itemHidden_${itemId}`;
        const isHidden = localStorage.getItem(key) === 'true';
        localStorage.setItem(key, !isHidden);
        renderAssets();
    }
    function switchTab(t) { document.querySelectorAll('.modal-tab').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); document.getElementById('content'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); }
    function openModal() { if(isEditMode)return; editingId=null; window.tempTransactions=[]; document.getElementById('modalTitle').innerText='新增'; document.getElementById('inpName').value=''; document.getElementById('inpSymbol').value=''; switchTab('basic'); handleTypeChange(); document.getElementById('accountModal').style.display='block'; }
    function editAccount(id) { if(isEditMode)return; editingId=id; const a=accounts.find(x=>x.id===id); document.getElementById('modalTitle').innerText='編輯'; document.getElementById('inpType').value=a.type; document.getElementById('inpName').value=a.name; document.getElementById('inpSymbol').value=a.symbol; if(a.logo) document.getElementById('inpSymbol').setAttribute('data-logo', a.logo); document.getElementById('inpBalance').value=a.balance; document.getElementById('inpCost').value=a.cost||''; document.getElementById('inpCurrency').value=a.currency; window.tempTransactions=a.transactions||[]; renderTransactions(window.tempTransactions); switchTab('basic'); handleTypeChange(); document.getElementById('accountModal').style.display='block'; }
    function closeModal() { document.getElementById('accountModal').style.display='none'; }
    function updateBrokerOptions() {
        const t = document.getElementById('inpType').value;
        const brokerSelect = document.getElementById('brokerSelect');
        if (!brokerSelect) return;
        brokerSelect.innerHTML = '';
        if (t === 'twstock') {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (1.425%)</option><option value="cathay_fixed">國泰證券 (定期定額 固定1元)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        } else if (t === 'stock') {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (0.1%)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        } else if (t === 'crypto') {
            brokerSelect.innerHTML = '<option value="none" selected>無手續費 (0%)</option>';
        } else {
            brokerSelect.innerHTML = '<option value="cathay">國泰證券 (0.1%)</option><option value="fubon">富邦證券 (0.25%)</option><option value="custom">自訂...</option>';
        }
    }
    function handleTypeChange() { const t=document.getElementById('inpType').value; const auto=(t==='stock'||t==='twstock'||t==='crypto'); document.getElementById('rowSymbol').style.display=auto?'flex':'none'; document.getElementById('rowName').style.display=auto?'none':'flex'; document.getElementById('rowCurrency').style.display=auto?'none':'flex'; document.getElementById('rowCost').style.display=(auto && t!=='crypto')?'flex':'none'; document.getElementById('aiArea').style.display=auto?'block':'none'; document.getElementById('lblBalance').innerText=(t==='crypto')?'數量':(auto?'股數':'金額'); if(auto) { updateBrokerOptions(); syncNameFromSymbol(); updateAIButtonState(); } else { document.getElementById('btnAI').disabled=false; } }
    function updateAIButtonState() { const btnAI=document.getElementById('btnAI'); if(btnAI) btnAI.disabled=false; }
    let nameQueryTimer = null;
    async function fetchTWStockName(symbol) {
        if(!settings.fugleKey || !symbol) return null;
        // 驗證台股代號格式（通常是4位數字）
        if(!/^\d{4}$/.test(symbol)) return null;
        try {
            // 使用 Fugle quote 端點獲取股票基本資料
            const res = await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${symbol}`, {
                headers: {'X-API-KEY': settings.fugleKey}
            });
            if (!res.ok) return null;
            const j = await res.json();
            // 根據參考代碼，回應中直接有 name 欄位
            if(j && j.name) {
                return j.name;
            }
            return null;
        } catch(e) {
            console.error('Failed to fetch stock name:', e);
            return null;
        }
    }
    function cleanCompanyName(name) {
        if(!name) return name;
        // 移除常見的公司後綴（不區分大小寫）
        // 處理有逗號的情況：", INC" 或 ", INC."
        name = name.replace(/,\s*(INC|INCORPORATED|CORP|CORPORATION|LTD|LIMITED|LLC|CO|COMPANY|PLC|SA|AG|NV|BV|LP|LLP)\.?$/i, '');
        // 處理沒有逗號的情況：" INC" 或 " INC." 或 "INC"
        name = name.replace(/\s+(INC|INCORPORATED|CORP|CORPORATION|LTD|LIMITED|LLC|CO|COMPANY|PLC|SA|AG|NV|BV|LP|LLP)\.?$/i, '');
        return name.trim();
    }
    async function fetchUSStockProfile(symbol) {
        if(!settings.apiKey || !symbol) return null;
        try {
            const res = await fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${settings.apiKey}`);
            if (!res.ok) return null;
            const j = await res.json();
            // 檢查是否回傳空物件（代表查無此股）
            if (Object.keys(j).length === 0) return null;
            return {
                name: cleanCompanyName(j.name) || symbol,
                logo: j.logo || null
            };
        } catch(e) {
            console.error('Failed to fetch US stock profile:', e);
            return null;
        }
    }
    async function fetchCryptoLogo(symbol) {
        if(!symbol) return null;
        try {
            // 清理代號 (移除 USD, USDT 等後綴，CoinCap 只需要純代號)
            const cleanSymbol = symbol.replace('COINBASE:', '').replace('-USD', '').replace('-USDT', '').toUpperCase();
            // 組合 CoinCap 網址 (必須轉小寫)
            const logoUrl = `https://assets.coincap.io/assets/icons/${cleanSymbol.toLowerCase()}@2x.png`;
            // 嘗試載入圖片來驗證是否存在
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(logoUrl);
                img.onerror = () => resolve(null);
                img.src = logoUrl;
            });
        } catch(e) {
            console.error('Failed to fetch crypto logo:', e);
            return null;
        }
    }
    async function syncNameFromSymbol() { 
        const t=document.getElementById('inpType').value; 
        if(t==='stock'||t==='twstock'||t==='crypto'){ 
            const s=document.getElementById('inpSymbol').value.trim().toUpperCase(); 
            if(s) { 
                if(t==='twstock') {
                    // 台股：先顯示代號
                    document.getElementById('inpName').value = s;
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 驗證代號格式（4位數字）才查詢
                    if(/^\d{4}$/.test(s)) {
                        // 延遲查詢，避免頻繁請求（增加到800ms，確保輸入完成）
                        nameQueryTimer = setTimeout(async () => {
                            const companyName = await fetchTWStockName(s);
                            if(companyName) {
                                document.getElementById('inpName').value = companyName;
                            }
                        }, 800);
                    }
                } else if(t==='stock') { 
                    // 美股：先顯示代號
                    document.getElementById('inpName').value = s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 延遲查詢，避免頻繁請求
                    nameQueryTimer = setTimeout(async () => {
                        const profile = await fetchUSStockProfile(s);
                        if(profile && profile.name) {
                            document.getElementById('inpName').value = profile.name;
                            // 儲存 logo URL 到隱藏欄位或直接保存（稍後在 saveAccount 中處理）
                            if(profile.logo) {
                                document.getElementById('inpSymbol').setAttribute('data-logo', profile.logo);
                            }
                        }
                    }, 800);
                } else if(t==='crypto') { 
                    // 加密貨幣：先顯示代號
                    document.getElementById('inpName').value=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 清除之前的計時器
                    if(nameQueryTimer) clearTimeout(nameQueryTimer);
                    // 延遲查詢，避免頻繁請求
                    nameQueryTimer = setTimeout(async () => {
                        const logoUrl = await fetchCryptoLogo(s);
                        if(logoUrl) {
                            document.getElementById('inpSymbol').setAttribute('data-logo', logoUrl);
                        }
                    }, 800);
                } 
            } 
        } 
    }
    function saveAccount() { const t=document.getElementById('inpType').value; let s=document.getElementById('inpSymbol').value.trim().toUpperCase(); let n=document.getElementById('inpName').value.trim(); let c=document.getElementById('inpCurrency').value; const balanceInput = document.getElementById('inpBalance').value.trim(); const b = balanceInput === '' ? 0 : (parseFloat(balanceInput) || 0); const costInput = document.getElementById('inpCost').value.trim(); let cost = costInput === '' ? 0 : (parseFloat(costInput) || 0); const auto=(t==='stock'||t==='twstock'||t==='crypto'); let logoUrl = null; if(t==='stock'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入股數"); if(!cost)return alert("請輸入平均成本"); if(!n) n=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); else n=cleanCompanyName(n); logoUrl = document.getElementById('inpSymbol').getAttribute('data-logo') || null; c='USD'; } else if(t==='twstock'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入股數"); if(!cost)return alert("請輸入平均成本"); if(!n) n=s; c='TWD'; } else if(t==='crypto'){ if(!s)return alert("請輸入代碼"); if(!b)return alert("請輸入數量"); cost=0; if(!s.includes(':'))s=`COINBASE:${s}-USD`; if(!n) n=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); logoUrl = document.getElementById('inpSymbol').getAttribute('data-logo') || null; c='USD'; } if(!auto && !n)return alert("請輸入名稱"); if(!auto && balanceInput === '')return alert("請輸入金額"); const existingAcc = editingId ? accounts.find(x=>x.id===editingId) : null; const newA={ id:editingId||Date.now(), type:t, name:n, symbol:s, currency:c, balance:b, cost:cost, isAuto:auto, logo: logoUrl || (existingAcc && existingAcc.logo) || null, currentPrice:existingAcc?(existingAcc.currentPrice||0):0, dayChange:existingAcc?(existingAcc.dayChange||0):0, dayChangePercent:existingAcc?(existingAcc.dayChangePercent||0):0, order:existingAcc?(existingAcc.order||0):9999, transactions: window.tempTransactions||[] }; if(editingId)accounts[accounts.findIndex(x=>x.id===editingId)]=newA; else accounts.push(newA); saveData(); closeModal(); if(currentDetailAcc && currentDetailAcc.id === newA.id && newA.isAuto) { openDetailView(newA.id); } else if(currentDetailAcc && !newA.isAuto) { closeDetailView(); currentDetailAcc = null; } if(auto)refreshAllData(); else { renderAssets(); updateChartData(); } }
    function deleteAccount() { 
        const acc = accounts.find(x => x.id === editingId);
        if (!acc) return;
        const name = acc.name || '此資產';
        if (!confirm(`確定要刪除「${name}」嗎？`)) return;
        if (!confirm(`再次確認：確定要刪除「${name}」嗎？\n此操作無法復原！`)) return;
        accounts = accounts.filter(x => x.id !== editingId);
        saveData();
        closeModal();
        closeDetailView();
        renderAssets();
    }
    function saveData() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(accounts)); }
    function updateOrder(type,container){ let ids=Array.from(container.children).map(c=>parseInt(c.getAttribute('data-id'))); ids.forEach((id,idx)=>{ let a=accounts.find(x=>x.id===id); if(a)a.order=idx; }); saveData(); }
    function setApiKey(t) { if(t==='finnhub'){const k=prompt("Finnhub Key:", settings.apiKey);if(k)settings.apiKey=k.trim();} else if(t==='fugle'){const k=prompt("Fugle Key:", settings.fugleKey);if(k)settings.fugleKey=k.trim();} else {const k=prompt("Gemini Key:", settings.geminiKey);if(k)settings.geminiKey=k.trim();} localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); refreshAllData(); }
    function setFeeRate() { const k=prompt("手續費率 (%):", settings.feeRate); if(k)settings.feeRate=parseFloat(k); localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); }
    function updateFeeDisplay() { const s=document.getElementById('brokerSelect'); if(s.value==='custom'){ const r=prompt("自訂費率 (%):", settings.feeRate||0.1); if(r)settings.feeRate=parseFloat(r); localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); } }
    function exportData() { 
        const data = {data:accounts, settings:settings};
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `my_assets_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    function importData() { 
        const choice = confirm("選擇匯入方式：\n確定 = 貼上JSON文字\n取消 = 選擇檔案");
        const progressToast = document.getElementById('importProgressToast');
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');
        if (choice) {
            const text = prompt("貼上備份JSON:");
            if (text) {
                progressToast.style.display = 'block';
                progressBar.style.width = '30%';
                progressText.innerText = '解析JSON中...';
                try {
                    setTimeout(() => {
                        progressBar.style.width = '60%';
                        progressText.innerText = '驗證資料中...';
                        const d = JSON.parse(text);
                        if (d.data && d.settings) {
                            progressBar.style.width = '80%';
                            progressText.innerText = '寫入資料中...';
                            setTimeout(() => {
                                progressBar.style.width = '100%';
                                progressText.innerText = '完成！';
                                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(d.data));
                                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(d.settings));
                                setTimeout(() => location.reload(), 500);
                            }, 200);
                        } else {
                            progressToast.style.display = 'none';
                            progressBar.style.width = '0%';
                            alert("格式錯誤：缺少 data 或 settings");
                        }
                    }, 100);
                } catch(err) {
                    progressToast.style.display = 'none';
                    progressBar.style.width = '0%';
                    alert("解析失敗: " + err.message);
                }
            }
        } else {
            document.getElementById('importFileInput').click();
        }
    }
    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const progressToast = document.getElementById('importProgressToast');
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');
        progressToast.style.display = 'block';
        progressBar.style.width = '20%';
        progressText.innerText = '讀取檔案中...';
        const reader = new FileReader();
        reader.onload = function(e) {
            progressBar.style.width = '50%';
            progressText.innerText = '解析JSON中...';
            try {
                setTimeout(() => {
                    progressBar.style.width = '70%';
                    progressText.innerText = '驗證資料中...';
                    const d = JSON.parse(e.target.result);
                    if (d.data && d.settings) {
                        progressBar.style.width = '90%';
                        progressText.innerText = '寫入資料中...';
                        setTimeout(() => {
                            progressBar.style.width = '100%';
                            progressText.innerText = '完成！';
                            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(d.data));
                            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(d.settings));
                            setTimeout(() => location.reload(), 500);
                        }, 200);
                    } else {
                        progressToast.style.display = 'none';
                        progressBar.style.width = '0%';
                        alert("檔案格式錯誤");
                    }
                }, 100);
            } catch(err) {
                progressToast.style.display = 'none';
                progressBar.style.width = '0%';
                alert("讀取檔案失敗: " + err.message);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // Detail View
    function openDetailView(id) {
        if (isEditMode) return;
        currentDetailAcc = accounts.find(x => x.id === id);
        if (!currentDetailAcc) return;
        if (!currentDetailAcc.isAuto) { editAccount(id); return; }
        // 美股和台股：只顯示公司名稱，不顯示代碼
        let displayName = currentDetailAcc.name;
        if(currentDetailAcc.type === 'stock') {
            displayName = cleanCompanyName(currentDetailAcc.name);
        } else if(currentDetailAcc.type === 'twstock') {
            displayName = currentDetailAcc.name;
        }
        document.getElementById('dName').innerText = displayName; 
        document.getElementById('dSymbol').innerText = ''; // 清空代碼內容
        document.getElementById('dSymbol').style.display = 'none'; // 隱藏代碼
        document.getElementById('dQty').innerText = currentDetailAcc.balance;
        let price = currentDetailAcc.currentPrice || 0; let priceUnit = currentDetailAcc.type === 'twstock' ? 'TWD' : 'USD'; document.getElementById('dPrice').innerText = `${price.toLocaleString()}`;
        let val = calculateValue(currentDetailAcc); document.getElementById('dVal').innerText = formatAmount(val);
        let cost = currentDetailAcc.cost || 0; let fee = settings.feeRate || 0.1;
        
        // 當天損益
        let dailyPnL = calculateDailyPnL(currentDetailAcc);
        let dailySign = dailyPnL >= 0 ? '+' : '';
        let dailyColor = dailyPnL >= 0 ? 'var(--color-up)' : (dailyPnL < 0 ? 'var(--color-down)' : '#fff');
        document.getElementById('dDailyPnlVal').innerHTML = `<span style="color:${dailyColor}">${dailySign}${formatAmount(dailyPnL)}</span>`;
        
        // 持股成本損益
        let costPnL = calculateCostPnL(currentDetailAcc);
        let costPnlPct = (cost > 0) ? ((price - cost) / cost) * 100 : 0;
        let costSign = costPnL >= 0 ? '+' : '';
        let costColor = '#fff';
        if (cost > 0) {
            costColor = costPnL >= 0 ? 'var(--color-up)' : 'var(--color-down)';
        }
        if (cost > 0) {
            document.getElementById('dCostPnl').style.display = 'block';
            document.getElementById('dCostPnlVal').innerHTML = `<span style="color:${costColor}">${costSign}${formatAmount(costPnL)} (${costPnlPct.toFixed(2)}%)</span>`;
        } else {
            document.getElementById('dCostPnl').style.display = 'none';
        }
        const txList = document.getElementById('detailTxList'); txList.innerHTML = '';
        if (currentDetailAcc.transactions && currentDetailAcc.transactions.length > 0) {
            currentDetailAcc.transactions.forEach(tx => {
                let txPnlHtml = '';
                if (price > 0 && tx.price > 0) {
                     let txCost = tx.price * (1 + fee/100); let txProfit = (price - txCost) * tx.shares; 
                     let txProfitConverted = currentDetailAcc.type === 'twstock' ? (currentDisplayCurrency === 'USD' ? txProfit / settings.usdRate : txProfit) : (currentDisplayCurrency === 'USD' ? txProfit : txProfit * settings.usdRate);
                     let txSign = txProfitConverted >= 0 ? '+' : ''; let txColor = txProfitConverted >= 0 ? 'val-green' : 'val-red'; let txPct = ((price - txCost) / txCost) * 100;
                     txPnlHtml = `<div class="tx-row"><span class="tx-label">損益</span><span class="tx-val ${txColor}">${txSign}${formatAmount(txProfitConverted)} (${txPct.toFixed(1)}%)</span></div>`;
                }
                txList.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val">$${tx.price}</span></div>${txPnlHtml}</div>`;
            });
        } else { txList.innerHTML = '<div class="tx-no-data">無詳細交易紀錄<br>請在編輯模式匯入截圖</div>'; }
        document.getElementById('detailView').classList.add('active');
    }
    function closeDetailView() { document.getElementById('detailView').classList.remove('active'); }
    function editCurrentAsset() { if(currentDetailAcc) { closeDetailView(); editAccount(currentDetailAcc.id); } }

    // AI
    function triggerImageUpload() { if(!settings.geminiKey)return alert("請先設定 Gemini Key"); document.getElementById('imgUpload').click(); }
    async function handleImageUpload(input) {
        if(!input.files || input.files.length === 0) return;
        const status = document.getElementById('aiStatus'); 
        const progressContainer = document.getElementById('aiProgress');
        const progressBar = document.getElementById('aiProgressBar');
        status.innerText = `讀取圖片中...`; status.style.color = "#aaa";
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        try {
            const files = Array.from(input.files);
            const promises = files.map((f, idx) => new Promise((res,rej)=>{
                const r=new FileReader();
                r.onload=e=>{
                    progressBar.style.width = `${20 + (idx + 1) * 30 / files.length}%`;
                    res({inlineData:{mimeType:f.type,data:e.target.result.split(',')[1]}});
                };
                r.onerror=rej;
                r.readAsDataURL(f);
            }));
            const images = await Promise.all(promises);
            progressBar.style.width = '60%';
            status.innerText = `AI 分析中...`; status.style.color = "#0a84ff";
            const broker = document.getElementById('brokerSelect').value;
            const accountType = document.getElementById('inpType').value;
            const isTWStock = accountType === 'twstock';
            const isUSStock = accountType === 'stock';
            const isCrypto = accountType === 'crypto';
            const isFixedFee = isTWStock && broker === 'cathay_fixed'; // 台股國泰定期定額固定1元
            let fee = isCrypto ? 0 : 0.1; // 加密貨幣預設手續費為0 
            if (isTWStock && broker === 'cathay') {
                fee = 1.425; // 台股國泰一般交易1.425%
            } else if (isTWStock && broker === 'cathay_fixed') {
                fee = 0; // 台股國泰定期定額固定1元，fee設為0（會在計算時直接加1元）
            } else if (isUSStock && broker === 'cathay') {
                fee = 0.1; // 美股國泰0.1%
            } else if (broker === 'fubon') {
                fee = 0.25;
            } else if (broker === 'custom') {
                fee = settings.feeRate || 0.1;
            }
            let prompt = '';
            if(accountType === 'crypto') {
                // 加密貨幣：看圖左邊的代碼/名字和圖左邊下面的數量
                prompt = `Analyze cryptocurrency wallet/exchange screenshots. 1. Extract cryptocurrency symbol/name from the LEFT side of the image (look for crypto symbols like BTC, ETH, SOL, etc. or names like Bitcoin, Ethereum, etc.). 2. Extract the QUANTITY/AMOUNT from BELOW the symbol/name on the LEFT side. Return JSON: {"symbol": "crypto symbol/name if found", "quantity": number}`;
            } else {
                // 美股、台股：原有邏輯
                prompt = `Analyze brokerage screenshots. 1. Extract stock symbol/code if visible (look for stock ticker symbols like NVDA, TSLA, 2330, etc.). 2. Extract transaction list: [{"date": "MM/DD", "shares": number, "price": number (raw price without fee)}] 3. Calculate TOTAL shares. 4. Calculate Weighted Average Cost PER SHARE. IMPORTANT: For each transaction, Cost = Price${isFixedFee ? ' + 1' : ` * (1 + ${fee}/100)`}. Final Avg Cost = (Sum of (Shares * Cost)) / Total Shares. Return JSON: {"symbol": "stock symbol if found", "transactions": [...], "totalShares": number, "avgCost": number}`;
            }
            progressBar.style.width = '80%';
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${settings.geminiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...images] }] }) });
            progressBar.style.width = '90%';
            status.innerText = `處理結果中...`; status.style.color = "#0a84ff";
            const data = await resp.json(); if(data.error) throw new Error(data.error.message);
            if(!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0] || !data.candidates[0].content.parts[0].text) {
                throw new Error("AI 回應格式錯誤，請重試");
            }
            const txt = data.candidates[0].content.parts[0].text; 
            // 嘗試提取 JSON，使用更寬鬆的匹配
            let match = txt.match(/\{[\s\S]*\}/);
            if(!match) {
                // 如果沒有找到 JSON，嘗試尋找 JSON 陣列
                match = txt.match(/\[[\s\S]*\]/);
            }
            if(match) {
                let res;
                try {
                    res = JSON.parse(match[0]);
                } catch(parseError) {
                    // 如果解析失敗，嘗試清理文字後再解析
                    let cleanedJson = match[0].replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                    // 移除 JSON 後面的非 JSON 字符
                    cleanedJson = cleanedJson.replace(/\}[^}]*$/, '}');
                    try {
                        res = JSON.parse(cleanedJson);
                    } catch(e) {
                        throw new Error("無法解析 AI 回應的 JSON 格式，請重試或檢查圖片內容");
                    }
                }
                if(accountType === 'crypto') {
                    // 加密貨幣：處理 symbol 和 quantity
                    if(res.symbol && res.symbol.trim()) {
                        const symbolInput = document.getElementById('inpSymbol');
                        if(symbolInput && !symbolInput.value.trim()) {
                            symbolInput.value = res.symbol.trim().toUpperCase();
                            syncNameFromSymbol();
                        }
                    }
                    if(res.quantity !== undefined && res.quantity !== null) {
                        document.getElementById('inpBalance').value = parseFloat(res.quantity) || 0;
                    }
                    progressBar.style.width = '100%';
                    status.innerText = `成功! 已辨識代碼: ${res.symbol || '未找到'}，數量: ${res.quantity || 0}`; status.style.color = "#30d158"; 
                    setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 1000);
                } else if(res.transactions && res.transactions.length > 0) {
                    // 美股、台股：處理交易明細
                    // 如果有提取到股票代碼，自動填入
                    if(res.symbol && res.symbol.trim()) {
                        const symbolInput = document.getElementById('inpSymbol');
                        if(symbolInput && !symbolInput.value.trim()) {
                            symbolInput.value = res.symbol.trim().toUpperCase();
                            syncNameFromSymbol();
                        }
                    }
                    // 累積到現有交易明細
                    const existingTx = window.tempTransactions || [];
                    const newTx = res.transactions || [];
                    const allTx = [...existingTx, ...newTx];
                    
                    // 重新計算總股數和加權平均成本
                    let totalShares = 0;
                    let totalCost = 0;
                    allTx.forEach(tx => {
                        const shares = parseFloat(tx.shares) || 0;
                        const price = parseFloat(tx.price) || 0;
                        let costPerShare;
                        if (isFixedFee) {
                            costPerShare = price + 1; // 台股定期定額固定加1元
                        } else {
                            costPerShare = price * (1 + fee / 100);
                        }
                        totalShares += shares;
                        totalCost += shares * costPerShare;
                    });
                    const avgCost = totalShares > 0 ? totalCost / totalShares : 0;
                    
                    // 更新顯示
                    window.tempTransactions = allTx;
                    document.getElementById('inpBalance').value = totalShares;
                    document.getElementById('inpCost').value = avgCost.toFixed(4);
                    renderTransactions(window.tempTransactions);
                    progressBar.style.width = '100%';
                    const feeText = isFixedFee ? '固定1元' : `${fee}%`;
                    status.innerText = `成功! 已累積 ${allTx.length} 筆交易，總股數: ${totalShares}，已含 ${feeText} 手續費`; status.style.color = "#30d158"; 
                    setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 1000);
                    switchTab('detail');
                } else { 
                    throw new Error("AI 未辨識到資料，請確認圖片內容");
                }
            } else {
                throw new Error("AI 回應中未找到有效的 JSON 資料，請重試");
            }
        } catch(e) { 
            console.error(e); 
            status.innerText = "失敗: " + e.message; 
            status.style.color = "red"; 
            progressContainer.style.display = 'none'; 
            progressBar.style.width = '0%'; 
        } 
        input.value = '';
    }
    function renderTransactions(list) { const c = document.getElementById('txListContainer'); c.innerHTML = ''; if(!list || list.length === 0) { c.innerHTML = '<div class="tx-no-data">無明細</div>'; return; } list.forEach(tx => { c.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val">$${tx.price}</span></div></div>`; }); }

    // Async Updates
    async function refreshAllData(updateChart = true) { const icon=document.getElementById('refreshIcon'); if(icon) icon.classList.add('fa-spin-fast'); await updateRates(); if(settings.apiKey||settings.fugleKey)await fetchPrices(); if(updateChart) updateChartData(); setTimeout(()=>{if(icon) icon.classList.remove('fa-spin-fast');},500); }
    async function updateRates() { try{const r=await fetch('https://api.exchangerate-api.com/v4/latest/USD');const d=await r.json();if(d.rates?.TWD)settings.usdRate=d.rates.TWD;}catch(e){} if(settings.apiKey){try{const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=COINBASE:USDT-USD&token=${settings.apiKey}`);const j=await r.json();if(j.c)settings.usdtRate=j.c;}catch(e){}} localStorage.setItem(STORAGE_KEY_SETTINGS,JSON.stringify(settings)); document.getElementById('rateUsd').innerText=`USD ≈ ${settings.usdRate.toFixed(2)}`; document.getElementById('rateUsdt').innerText=`USDT ≈ ${settings.usdtRate.toFixed(3)} USD`; renderAssets(); }
    async function refreshStockInfo() {
        const stockAccounts = accounts.filter(acc => acc.type === 'stock' && acc.symbol);
        const twstockAccounts = accounts.filter(acc => acc.type === 'twstock' && acc.symbol);
        const cryptoAccounts = accounts.filter(acc => acc.type === 'crypto' && acc.symbol);
        
        if(stockAccounts.length === 0 && twstockAccounts.length === 0 && cryptoAccounts.length === 0) {
            alert('沒有需要重新整理的股票資訊');
            return;
        }
        
        // 顯示遮罩層和進度條
        const overlay = document.getElementById('refreshStockOverlay');
        const progressToast = document.getElementById('refreshStockProgressToast');
        const progressBar = document.getElementById('refreshStockProgressBar');
        const progressText = document.getElementById('refreshStockProgressText');
        overlay.style.display = 'block';
        progressToast.style.display = 'block';
        progressBar.style.width = '5%';
        progressText.innerText = '準備中...';
        
        let updated = 0;
        let total = stockAccounts.length + twstockAccounts.length + cryptoAccounts.length;
        let current = 0;
        
        // 重新整理美股資訊
        for(let acc of stockAccounts) {
            current++;
            progressBar.style.width = `${5 + (current / total) * 33}%`;
            progressText.innerText = `更新美股: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                const profile = await fetchUSStockProfile(sym);
                if(profile) {
                    if(profile.name) acc.name = profile.name;
                    if(profile.logo) acc.logo = profile.logo;
                    updated++;
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 200));
            } catch(e) {
                console.error(`Failed to refresh stock info for ${acc.symbol}:`, e);
            }
        }
        
        // 重新整理台股資訊
        for(let acc of twstockAccounts) {
            current++;
            progressBar.style.width = `${38 + ((current - stockAccounts.length) / Math.max(twstockAccounts.length, 1)) * 33}%`;
            progressText.innerText = `更新台股: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol;
                if(/^\d{4}$/.test(sym)) {
                    const companyName = await fetchTWStockName(sym);
                    if(companyName) {
                        acc.name = companyName;
                        updated++;
                    }
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 150));
            } catch(e) {
                console.error(`Failed to refresh twstock info for ${acc.symbol}:`, e);
            }
        }
        
        // 重新整理加密貨幣資訊
        for(let acc of cryptoAccounts) {
            current++;
            progressBar.style.width = `${71 + ((current - stockAccounts.length - twstockAccounts.length) / Math.max(cryptoAccounts.length, 1)) * 24}%`;
            progressText.innerText = `更新加密貨幣: ${acc.symbol} (${current}/${total})`;
            
            try {
                const sym = acc.symbol;
                const logoUrl = await fetchCryptoLogo(sym);
                if(logoUrl) {
                    acc.logo = logoUrl;
                    updated++;
                }
                // 避免請求過快，添加延遲
                await new Promise(r => setTimeout(r, 150));
            } catch(e) {
                console.error(`Failed to refresh crypto info for ${acc.symbol}:`, e);
            }
        }
        
        // 保存更新後的資料
        progressBar.style.width = '95%';
        progressText.innerText = '儲存資料中...';
        saveData();
        
        // 重新渲染列表和圖表
        progressBar.style.width = '100%';
        progressText.innerText = '完成！';
        renderAssets();
        updateChartData();
        
        // 延遲後隱藏遮罩層和進度條
        setTimeout(() => {
            overlay.style.display = 'none';
            progressToast.style.display = 'none';
            progressBar.style.width = '0%';
            alert(`已重新整理 ${updated}/${total} 個股票資訊`);
        }, 500);
    }
    async function fetchPrices() { const autos=accounts.filter(a=>a.isAuto&&a.symbol); for(let acc of autos){ try{ if(acc.type==='twstock'){ if(!settings.fugleKey)continue; await new Promise(r=>setTimeout(r,150)); const res=await fetch(`https://api.fugle.tw/marketdata/v1.0/stock/intraday/quote/${acc.symbol}`,{headers:{'X-API-KEY':settings.fugleKey}}); const j=await res.json(); if(j){ const price=j.lastPrice||(j.trade&&j.trade.price)||(j.trades&&j.trades[0]&&j.trades[0].price)||0; const changePercent=j.changePercent||(j.trade&&j.trade.changePercent)||0; const prevClose=j.previousClose||(price&&changePercent?price/(1+changePercent/100):price)||price; acc.currentPrice=price; acc.dayChangePercent=changePercent||0; acc.dayChange=(price-prevClose)||0; } } else { if(!settings.apiKey)continue; let sym=acc.symbol; if(acc.type==='crypto'){ if(acc.symbol==='USDT'||acc.symbol==='USDC'){acc.currentPrice=1;acc.dayChange=0;acc.dayChangePercent=0;continue;} if(!sym.includes(':'))sym=`COINBASE:${sym}-USD`; } await new Promise(r=>setTimeout(r,150)); const res=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${settings.apiKey}`); const j=await res.json(); if(j.c){ acc.currentPrice=j.c; acc.dayChange=j.d||0; acc.dayChangePercent=j.dp||0; } } }catch(e){} } saveData(); renderAssets(); }
    // Page Swiper Functions
    function switchToPage(pageIndex) {
        if(pageIndex < 0 || pageIndex >= PAGE_TYPES.length) return;
        currentPage = pageIndex;
        const container = document.getElementById('pageContainer');
        if(container) container.style.transform = `translateX(-${pageIndex * 100}%)`;
        
        // 更新分頁指示器
        document.querySelectorAll('.page-tab').forEach((tab, idx) => {
            tab.classList.toggle('active', idx === pageIndex);
        });
        
        // 確保選中的標籤在可見範圍內（但不居中）
        const ensureTabVisible = () => {
            const activeTab = document.querySelector(`.page-tab[data-page="${pageIndex}"]`);
            const indicator = document.querySelector('.page-indicator');
            
            if(!activeTab || !indicator) return;
            
            const tabRect = activeTab.getBoundingClientRect();
            const indicatorRect = indicator.getBoundingClientRect();
            
            // 檢查標籤是否在可見範圍內
            const isVisible = tabRect.left >= indicatorRect.left && tabRect.right <= indicatorRect.right;
            
            if(!isVisible) {
                // 如果標籤在左側被切掉，滾動到左側
                if(tabRect.left < indicatorRect.left) {
                    indicator.scrollTo({
                        left: activeTab.offsetLeft - 10,
                        behavior: 'smooth'
                    });
                }
                // 如果標籤在右側被切掉，滾動到右側
                else if(tabRect.right > indicatorRect.right) {
                    const scrollLeft = activeTab.offsetLeft + activeTab.offsetWidth - indicator.clientWidth + 10;
                    indicator.scrollTo({
                        left: Math.max(0, scrollLeft),
                        behavior: 'smooth'
                    });
                }
            }
        };
        
        // 延遲執行，確保DOM更新完成
        requestAnimationFrame(() => {
            ensureTabVisible();
            setTimeout(ensureTabVisible, 100);
        });
        
        // 更新箭頭按鈕狀態（桌面版）
        updatePageNavArrows();
        
        // 更新圖表和列表 - 切換分頁時退出 detail 模式
        chartLevel = pageIndex === 0 ? 'root' : 'page';
        
        // 如果之前在 detail 模式，清除圖表系列
        if(chartInstance && chartInstance.series.length > 0) {
            while(chartInstance.series.length > 0) {
                chartInstance.series[0].remove(false);
            }
        }
        
        updateChartData();
        renderAssets();
    }
    
    // 切換到上一頁
    function switchToPrevPage() {
        if(currentPage > 0) {
            switchToPage(currentPage - 1);
        }
    }
    
    // 切換到下一頁
    function switchToNextPage() {
        if(currentPage < PAGE_TYPES.length - 1) {
            switchToPage(currentPage + 1);
        }
    }
    
    // 更新箭頭按鈕的禁用狀態
    function updatePageNavArrows() {
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        
        if(prevBtn) {
            if(currentPage === 0) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
        }
        
        if(nextBtn) {
            if(currentPage >= PAGE_TYPES.length - 1) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }
    }
    
    function initSwiper() {
        const swiper = document.getElementById('pageSwiper');
        if(!swiper) return;
        
        swiper.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        }, { passive: true });
        
        swiper.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].clientX;
            handleSwipe();
        }, { passive: true });
        
        // 為圖表區域也添加滑動手勢支持
        const chartSection = document.querySelector('.chart-section');
        if(chartSection) {
            chartSection.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            }, { passive: true });
            
            chartSection.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].clientX;
                handleSwipe();
            }, { passive: true });
        }
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if(Math.abs(diff) > swipeThreshold) {
            if(diff > 0 && currentPage < PAGE_TYPES.length - 1) {
                // 向右滑動，切換到下一個分頁
                switchToPage(currentPage + 1);
            } else if(diff < 0 && currentPage > 0) {
                // 向左滑動，切換到上一個分頁
                switchToPage(currentPage - 1);
            }
        }
    }
    
    function renderAssets() { 
        sortables.forEach(s=>s.destroy()); 
        sortables=[]; 
        
        // 在桌面模式下，動態計算並對齊列表標題與圓餅圖中心
        if(window.matchMedia('(min-width: 768px)').matches) {
            setTimeout(() => {
                const chartWrapper = document.querySelector('#chartWrapper');
                const firstGroupHeader = document.querySelector('.list-section .page-container > div:first-child.group-header');
                if(chartWrapper && firstGroupHeader) {
                    // 取得圓餅圖的中心位置（相對於視窗）
                    const chartRect = chartWrapper.getBoundingClientRect();
                    const chartCenterY = chartRect.top + (chartRect.height / 2);
                    
                    // 取得列表標題的位置（相對於視窗）
                    const headerRect = firstGroupHeader.getBoundingClientRect();
                    const headerTopY = headerRect.top;
                    
                    // 計算需要補償的高度差：讓 group-header 的頂部與圓餅圖中心對齊
                    const offset = chartCenterY - headerTopY;
                    if(offset > 0) {
                        firstGroupHeader.style.marginTop = `${offset}px`;
                    } else {
                        firstGroupHeader.style.marginTop = '0px';
                    }
                }
            }, 300);
        }
        
        let displayAmount = 0;
        let totalDailyPnL = 0;
        
        if(currentPage === 0) {
            // 總覽分頁：計算總淨資產（包含所有資產減去負債）
            accounts.forEach(acc => {
                let val = calculateValue(acc);
                if(acc.type === 'debt') displayAmount -= val;
                else displayAmount += val;
                if(acc.isAuto) totalDailyPnL += calculateDailyPnL(acc);
            });
        } else {
            // 其他分頁：只計算該分頁類別的總額
            const currentType = PAGE_TYPES[currentPage];
            accounts.forEach(acc => {
                if(acc.type === currentType) {
                    let val = calculateValue(acc);
                    displayAmount += val;
                    if(acc.isAuto) totalDailyPnL += calculateDailyPnL(acc);
                }
            });
        }
        
        // 更新總資產顯示
        document.getElementById('totalNetWorth').innerText = formatAmount(displayAmount);
        const b = document.getElementById('totalPnLBlock');
        const bd = document.getElementById('totalPnLBadge');
        if(Math.abs(totalDailyPnL) > 1) {
            b.style.display = 'block';
            // 重置樣式，確保損益正常顯示
            bd.style.visibility = 'visible';
            bd.style.height = '';
            bd.style.margin = '';
            bd.style.padding = '';
            const s = totalDailyPnL > 0 ? '+' : '';
            const c = totalDailyPnL > 0 ? 'pnl-up' : 'pnl-down';
            bd.innerHTML = `損益: <span class="${c}">${s}${formatAmount(totalDailyPnL)}</span>`;
        } else {
            // 即使沒有損益也顯示空白區塊，保持與其他分頁對齊（完全不可見但佔位）
            b.style.display = 'block';
            bd.style.visibility = 'hidden';
            bd.style.height = '0';
            bd.style.margin = '0';
            bd.style.padding = '0';
            bd.innerHTML = '';
        }
        
        // 更新摘要標籤
        const summaryLabelEl = document.getElementById('summaryLabel');
        if(currentPage === 0) {
            if(summaryLabelEl) summaryLabelEl.innerText = '總淨資產';
        } else {
            if(summaryLabelEl) summaryLabelEl.innerText = `${PAGE_NAMES[currentPage]} 總額`;
        }
        
        // 渲染總覽分頁（第0頁）- 顯示各類別卡片（與其他分頁格式一致）
        if(currentPage === 0) {
            const c = document.getElementById('assetsContainer');
            if(c) {
                c.innerHTML = '';
                const categoryTypes = ['bank', 'stock', 'twstock', 'crypto'];
                const categoryConfig = {
                    'bank': {t:'銀行 / 現金', i:'fa-university', s:'icon-bank'},
                    'stock': {t:'美股', i:'fa-chart-line', s:'icon-stock'},
                    'twstock': {t:'台股', i:'fa-chart-line', s:'icon-twstock'},
                    'crypto': {t:'加密貨幣', i:'fa-bitcoin', s:'icon-crypto'}
                };
                
                let allItems = [];
                categoryTypes.forEach(type => {
                    const g = categoryConfig[type];
                    if(!g) return;
                    let items = accounts.filter(a => a.type === type);
                    let sum = 0;
                    let groupPnL = 0;
                    items.forEach(acc => {
                        let val = calculateValue(acc);
                        sum += val;
                        groupPnL += calculatePnL(acc);
                    });
                    // 即使沒有資產也要顯示，顯示為 0
                    allItems.push({type: type, name: g.t, icon: g.i, iconClass: g.s, sum: sum, pnl: groupPnL});
                });
                
                // 所有分類都會顯示，不需要檢查是否為空
                
                let totalSum = 0;
                let totalPnL = 0;
                let html = '';
                
                allItems.forEach(item => {
                    totalSum += item.sum;
                    totalPnL += item.pnl;
                    
                    let htmlContent = `<div class="item-name">${item.name}</div><div class="item-row">總覽</div>`;
                    let color = 'amount-green';
                    
                    // 檢查該項目是否被隱藏
                    let itemHidden = localStorage.getItem(`itemHidden_category-${item.type}`) === 'true';
                    let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
                    
                    let pnlHtml = '';
                    if(Math.abs(item.pnl) > 0.01) {
                        pnlHtml = `<div class="amount-pnl item-numbers">${formatPnL(item.pnl)}</div>`;
                    }
                    
                    let categoryClick = isEditMode ? '' : `onclick="switchToPage(${PAGE_TYPES.indexOf(item.type)})"`;
                    html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${categoryClick} data-id="category-${item.type}"><div class="item-icon ${item.iconClass}"><i class="fas ${item.icon}"></i></div><div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val-wrapper"><div class="amount-val item-numbers ${color}">${formatAmount(item.sum)}</div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers('category-${item.type}')" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div>${pnlHtml}</div></div></div>`;
                });
                
                let pHtml = totalPnL !== 0 ? `<span class="group-pnl numbers-content">${formatPnL(totalPnL)}</span>` : '';
                c.innerHTML = `<div class="group-header"><span>總覽</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(totalSum)}</span>${pHtml}</div></div><div class="list-container" id="group-overview">${html}</div>`;
                
                // 設置總覽分頁的拖曳排序（類別卡片排序）
                if(isEditMode) {
                    let el = document.getElementById('group-overview');
                    if(el) {
                        sortables.push(Sortable.create(el, {
                            animation: 150,
                            onEnd: function(evt) { 
                                // 總覽分頁的排序是類別順序，保存到 localStorage
                                let ids = Array.from(evt.from.children).map(c => {
                                    let dataId = c.getAttribute('data-id');
                                    if(dataId && dataId.startsWith('category-')) {
                                        return dataId.replace('category-', '');
                                    }
                                    return null;
                                }).filter(id => id !== null);
                                
                                // 保存類別順序到 localStorage
                                localStorage.setItem('categoryOrder', JSON.stringify(ids));
                            }
                        }));
                    }
                }
            }
        }
        
        // 渲染其他分頁（第1-4頁）
        PAGE_TYPES.forEach((type, pageIdx) => {
            if(pageIdx === 0) return; // 跳過總覽分頁
            
            const containerId = pageIdx === 1 ? 'assetsContainer1' : (pageIdx === 2 ? 'assetsContainer2' : (pageIdx === 3 ? 'assetsContainer3' : 'assetsContainer4'));
            const c = document.getElementById(containerId);
            if(!c) return;
            
            const groupConfig = {
                'bank': {t:'銀行 / 現金', i:'fa-university', s:'icon-bank'},
                'stock': {t:'美股', i:'fa-chart-line', s:'icon-stock'},
                'twstock': {t:'台股', i:'fa-chart-line', s:'icon-twstock'},
                'crypto': {t:'加密貨幣', i:'fa-bitcoin', s:'icon-crypto'}
            };
            const g = groupConfig[type];
            if(!g) return;
            
            // 分頁模式：顯示該類別內的資產列表
            c.innerHTML = '';
            let items = accounts.filter(a => a.type === type).sort((a,b) => (a.order||0) - (b.order||0));
            if(items.length === 0) {
                c.innerHTML = '<div style="text-align:center; color:#666; padding:30px 0;">暫無資產</div>';
                return;
            }
            
            let sum = 0;
            let groupPnL = 0;
            let html = '';
            
            items.forEach(acc => {
                let val = calculateValue(acc);
                let pnl = calculatePnL(acc);
                sum += val;
                groupPnL += pnl;
                
                let htmlContent = '';
                if(acc.isAuto) {
                    let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                    // 台股和美股/加密貨幣都統一格式，不使用前綴
                    let pricePrefix = '';
                    // 簡化價格顯示，去掉單位（台股和美股都統一格式），沒有資料時顯示 N/A
                    // 對於 USDT/USDC 等穩定幣，價格顯示為 1.00
                    let price = '';
                    if(acc.currentPrice) {
                        if((sym === 'USDT' || sym === 'USDC') && acc.currentPrice === 1) {
                            price = '1.00';
                        } else {
                            price = `${pricePrefix}${acc.currentPrice.toLocaleString()}`;
                        }
                    } else {
                        price = 'N/A';
                    }
                    let chg = '';
                    if(acc.dayChangePercent !== undefined && acc.dayChangePercent !== null) {
                        // 對於 USDT/USDC 等穩定幣，如果漲跌幅為 0，不顯示
                        if((sym === 'USDT' || sym === 'USDC') && acc.dayChangePercent === 0) {
                            chg = '';
                        } else {
                            let s = acc.dayChangePercent > 0 ? '+' : '';
                            let c = acc.dayChangePercent > 0 ? 'sub-green' : 'sub-red';
                            chg = `<span class="${c}">${s}${acc.dayChangePercent.toFixed(2)}%</span>`;
                        }
                    } else if(acc.currentPrice && (sym !== 'USDT' && sym !== 'USDC')) {
                        // 有價格但沒有漲跌幅，且不是穩定幣，顯示 N/A
                        chg = `<span>N/A</span>`;
                    }
                    // 計算盈虧（用於顯示在當日和成本行的右邊）
                    let dailyPnL = acc.isAuto ? calculateDailyPnL(acc) : 0;
                    let costPnL = acc.isAuto ? calculateCostPnL(acc) : 0;
                    let dailyPnLHtml = '';
                    let costPnLHtml = '';
                    
                    // 美股、台股、加密貨幣：將盈虧顯示在當日和成本行的最右邊
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        if(Math.abs(dailyPnL) > 0.01) {
                            dailyPnLHtml = `<span style="margin-left: auto;">${formatPnL(dailyPnL)}</span>`;
                        }
                        if(acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0 && Math.abs(costPnL) > 0.01) {
                            costPnLHtml = `<span style="margin-left: auto;">${formatPnL(costPnL)}</span>`;
                        }
                    }
                    
                    // 第一行：當日標籤 + 價格 + 當天漲跌幅 + 當日盈虧（美股、台股、加密貨幣）
                    // USDT/USDC 特別處理：不顯示當日和成本行
                    let line1 = '';
                    let line2 = '';
                    if(sym !== 'USDT' && sym !== 'USDC') {
                        line1 = chg ? `<div class="item-row-compact"><span class="price-label">當日</span><span>${price}</span>${chg}${dailyPnLHtml}</div>` : `<div class="item-row-compact"><span class="price-label">當日</span><span>${price}</span>${dailyPnLHtml}</div>`;
                        // 第二行：成本標籤 + 成本 + 成本百分比 + 成本盈虧（美股、台股；加密貨幣不顯示成本）
                        if(acc.type !== 'crypto' && acc.cost && acc.cost > 0) {
                            if(acc.currentPrice && acc.currentPrice > 0) {
                                let pnlPct = ((acc.currentPrice - acc.cost) / acc.cost) * 100;
                                let s = pnlPct >= 0 ? '+' : '';
                                let c = pnlPct >= 0 ? 'sub-green' : 'sub-red';
                                let costPrefix = '';
                                // 簡化：只顯示成本和百分比，加上"成本"標籤
                                // 美股、台股：line2 不包含股數，股數會放在代碼行
                                line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>${costPrefix}${acc.cost.toFixed(2)}</span><span class="${c}">${s}${pnlPct.toFixed(1)}%</span>${costPnLHtml}</div>`;
                            } else {
                                // 有成本但沒有當前價格，顯示成本和 N/A
                                let costPrefix = '';
                                line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>${costPrefix}${acc.cost.toFixed(2)}</span><span>N/A</span>${costPnLHtml}</div>`;
                            }
                        } else if(acc.type !== 'crypto') {
                            // 沒有成本時，顯示 N/A（加密貨幣不顯示）
                            line2 = `<div class="item-row-compact"><span class="price-label">成本</span><span>N/A</span></div>`;
                        }
                    }
                    // 美股、台股、加密貨幣：分開顯示公司名稱和代號
                    let displayName = acc.type === 'stock' ? cleanCompanyName(acc.name) : acc.name;
                    // 美股、台股、加密貨幣使用新佈局：第一行公司名稱，第二行代號+價格資訊
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        // 檢查該項目是否被隱藏（需要在這裡檢查，因為後面會用到 eyeIcon）
                        let itemHiddenTemp = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
                        let eyeIconTemp = itemHiddenTemp ? 'fa-eye-slash' : 'fa-eye';
                        // 第二行：代號，第三行開始：價格資訊（line1 和 line2）
                        let symbolRow = '';
                        // 美股、台股、加密貨幣：即使 displayName === sym 也要顯示代碼行（因為需要顯示股數和正確的排版）
                        if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                            // 美股、台股、加密貨幣：股數放在代碼同一行的最右邊，當日和成本往下移兩行
                            let balanceUnit = acc.type === 'crypto' ? '' : '股';
                            // USDT/USDC 特別處理：不顯示當日和成本行，所以不需要 spacer
                            let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                            // 加密貨幣沒有成本行（line2），但 line1 要顯示在 line2 的位置，所以需要兩個 spacer
                            let spacerHtml = '';
                            let displayLine1 = '';
                            let displayLine2 = '';
                            if(isStableCoin) {
                                spacerHtml = '';
                                displayLine1 = '';
                                displayLine2 = '';
                            } else if(acc.type === 'crypto') {
                                spacerHtml = '<div class="symbol-spacer"></div><div class="symbol-spacer"></div>'; // 加密貨幣需要兩個 spacer，讓 line1 顯示在 line2 的位置
                                displayLine1 = ''; // 第一個 spacer 位置留空
                                displayLine2 = line1; // line1 顯示在 line2 的位置
                            } else {
                                spacerHtml = '<div class="symbol-spacer"></div><div class="symbol-spacer"></div>'; // 美股、台股有 line1 和 line2，所以需要兩個 spacer
                                displayLine1 = line1;
                                displayLine2 = line2;
                            }
                            if(sym) {
                                symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">${sym || 'N/A'}</span><span class="symbol-balance">${acc.balance || 'N/A'}${balanceUnit}</span></div>${spacerHtml}${displayLine1}${displayLine2}</div>`;
                            } else {
                                // 沒有代碼時，也要保持排版結構，但代碼顯示 N/A
                                symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">N/A</span><span class="symbol-balance">${acc.balance || 'N/A'}${balanceUnit}</span></div>${spacerHtml}${displayLine1}${displayLine2}</div>`;
                            }
                        } else if(sym && displayName !== sym) {
                            // 其他類型：只有當 displayName !== sym 時才顯示代碼行
                            symbolRow = `<div class="item-symbol-row"><div class="symbol-text-row"><span class="symbol-text">${sym}</span></div><div class="symbol-spacer"></div>${line1}${line2}</div>`;
                        } else {
                            // 沒有代碼時，直接顯示價格資訊
                            symbolRow = `<div class="item-symbol-row">${line1}${line2}</div>`;
                        }
                        // 股數顯示位置
                        let balanceDisplay = '';
                        if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                            // 美股、台股、加密貨幣：股數已移到代碼行，眼睛下方不顯示
                            balanceDisplay = '';
                        } else {
                            // 其他類型：股數放在眼睛按鈕下方
                            balanceDisplay = `<div class="item-balance-below-eye">${acc.balance || 'N/A'}</div>`;
                        }
                        htmlContent = `<div class="item-name-row"><div class="item-name">${displayName}</div><div class="item-eye-wrapper"><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIconTemp}"></i></button>${balanceDisplay}</div></div>${symbolRow}`;
                    } else {
                        // 其他分類保持原來的佈局
                        htmlContent = `<div class="item-name">${displayName}</div>${line1}${line2}`;
                    }
                 } else {
                     // 銀行項目：移除幣別顯示，添加"帳戶"標籤
                     htmlContent = `<div class="item-name">${acc.name}</div><div class="item-row">帳戶</div>`;
                 }
                
                let color = 'amount-green';
                let hdl = isEditMode ? `<div class="drag-handle"><i class="fas fa-bars"></i></div>` : '';
                let clk = isEditMode ? '' : `onclick="openDetailView(${acc.id})"`;
                let dailyPnL = acc.isAuto ? calculateDailyPnL(acc) : 0;
                let costPnL = acc.isAuto ? calculateCostPnL(acc) : 0;
                let pnlHtml = '';
                
                if(acc.isAuto) {
                    // 美股、台股、加密貨幣：盈虧已經顯示在當日和成本行的右邊，所以右側不需要顯示盈虧
                    if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                        // USDT/USDC 特別處理：不顯示當日和成本行，所以不需要 spacer
                        let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                        let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                        if(isStableCoin) {
                            pnlHtml = '';
                        } else if(acc.type === 'crypto') {
                            // 加密貨幣只有一行（當日顯示在 line2 位置），所以只需要一個 spacer（對應第二個 symbol-spacer）
                            pnlHtml = `<div class="amount-spacer"></div>`;
                        } else {
                            // 美股、台股有 line1 和 line2，所以需要兩個 spacer
                            pnlHtml = `<div class="amount-spacer"></div><div class="amount-spacer"></div>`;
                        }
                    } else {
                        // 其他類型：保持原樣，在右側顯示盈虧
                        let hasLine3 = (acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0);
                        let pnlLines = [];
                        if(Math.abs(dailyPnL) > 0.01) {
                            pnlLines.push(formatPnL(dailyPnL));
                        }
                        if(hasLine3 && Math.abs(costPnL) > 0.01) {
                            pnlLines.push(formatPnL(costPnL));
                        }
                        if(pnlLines.length > 0) {
                            pnlHtml = pnlLines.map(value => `<div class="amount-pnl item-numbers">${value}</div>`).join('');
                        } else {
                            pnlHtml = `<div class="amount-spacer"></div><div class="amount-spacer"></div>`;
                        }
                    }
                } else {
                    pnlHtml = `<div class="amount-spacer"></div>`;
                    if(pnl !== 0) {
                        pnlHtml += `<div class="amount-pnl item-numbers">${formatPnL(pnl)}</div>`;
                    } else {
                        pnlHtml += '';
                    }
                }
                
                // 檢查該項目是否被隱藏
                let itemHidden = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
                let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
                
                // 美股和加密貨幣且有 logo 時顯示 logo，否則顯示 icon
                let iconHtml = '';
                if((acc.type === 'stock' || acc.type === 'crypto') && acc.logo) {
                    iconHtml = `<div class="item-icon ${g.s}"><img src="${acc.logo}" alt="${acc.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas ${g.i}\\'></i>';"></div>`;
                } else {
                    iconHtml = `<div class="item-icon ${g.s}"><i class="fas ${g.i}"></i></div>`;
                }
                 // 美股、台股、加密貨幣使用新佈局：第一行只顯示公司名稱，金額從第二行開始
                 if(acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') {
                     // 檢查是否為 USDT/USDC 穩定幣
                     let sym = acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT','');
                     let isStableCoin = (sym === 'USDT' || sym === 'USDC');
                     // 美股、台股、加密貨幣：現值金額往下移一行（對齊代碼+股數）
                     // USDT/USDC 特別處理：不顯示當日和成本行，所以只需要一個空白行，不需要兩個 spacer
                     let nameRowHeight = (acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') ? '19px' : '0';
                     let pnlSpacer = isStableCoin ? '' : ((acc.type === 'stock' || acc.type === 'twstock' || acc.type === 'crypto') ? '<div class="amount-spacer"></div><div class="amount-spacer"></div>' : '');
                     // 美股、台股、加密貨幣：現值金額放在第二行（對齊代碼+股數），需要 item-amount-name-row
                     html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${clk} data-id="${acc.id}">${iconHtml}<div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount-name-row" style="height: ${nameRowHeight}; margin-bottom: ${nameRowHeight === '19px' ? '3px' : '0'};"></div><div class="item-amount"><div class="amount-val item-numbers ${color}">${formatAmount(val)}</div>${pnlSpacer}${pnlHtml}</div></div>${hdl}</div>`;
                } else {
                    // 其他分類（銀行等）：眼睛按鈕放在金額右邊
                    html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${clk} data-id="${acc.id}">${iconHtml}<div class="item-content">${htmlContent}</div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val-wrapper"><div class="amount-val item-numbers ${color}">${formatAmount(val)}</div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div>${pnlHtml}</div></div>${hdl}</div>`;
                }
            });
            
            let pHtml = groupPnL !== 0 ? `<span class="group-pnl numbers-content">${formatPnL(groupPnL)}</span>` : '';
            c.innerHTML = `<div class="group-header"><span>${g.t}</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(sum)}</span>${pHtml}</div></div><div class="list-container" id="group-${type}">${html}</div>`;
            
            // 設置拖曳排序
            if(isEditMode) {
                let el = document.getElementById(`group-${type}`);
                if(el) {
                    sortables.push(Sortable.create(el, {
                        animation: 150,
                        onEnd: function(evt) { updateOrder(type, evt.from); }
                    }));
                }
            }
        });
        
        // 渲染負債（始終顯示）
        renderDebt();
        
        // 更新圖表
        updateChartData();
    }
    
    function renderDebt() {
        const debtContainer = document.getElementById('debtContainer');
        if(!debtContainer) return;
        
        let debtItems = accounts.filter(a => a.type === 'debt').sort((a,b) => (a.order||0) - (b.order||0));
        if(debtItems.length === 0) {
            debtContainer.innerHTML = '';
            return;
        }
        
        let totalDebt = 0;
        let html = '';
        
        debtItems.forEach(acc => {
            let val = calculateValue(acc);
            totalDebt += val;
            // 檢查該項目是否被隱藏
            let itemHidden = localStorage.getItem(`itemHidden_${acc.id}`) === 'true';
            let eyeIcon = itemHidden ? 'fa-eye-slash' : 'fa-eye';
            
            let debtClick = isEditMode ? '' : `onclick="openDetailView(${acc.id})"`;
            html += `<div class="list-item ${itemHidden ? 'item-hidden' : ''}" ${debtClick} data-id="${acc.id}"><div class="item-icon icon-debt"><i class="fas fa-hand-holding-usd"></i></div><div class="item-content"><div class="item-name">${acc.name}</div><div class="item-row">${acc.currency}</div></div><div class="item-amount-wrapper"><div class="item-amount"><div class="amount-val item-numbers amount-red">${formatAmount(val)}</div></div><button class="item-eye-btn" onclick="event.stopPropagation(); toggleItemNumbers(${acc.id})" title="隱藏/顯示數字"><i class="fas ${eyeIcon}"></i></button></div></div>`;
        });
        
        debtContainer.innerHTML = `<div class="group-header"><span>負債</span><div class="group-total-block"><span class="group-total numbers-content">${formatAmount(totalDebt)}</span></div></div><div class="list-container" id="group-debt">${html}</div>`;
    }

    // Currency Toggle Function
    function toggleCurrency() {
        currentDisplayCurrency = currentDisplayCurrency === 'TWD' ? 'USD' : 'TWD';
        localStorage.setItem('displayCurrency', currentDisplayCurrency);
        updateCurrencyButton();
        renderAssets();
        // 只有在詳細視圖已經打開的情況下才更新詳細視圖，不要重新打開已關閉的視圖
        const detailView = document.getElementById('detailView');
        if(currentDetailAcc && detailView && detailView.classList.contains('active')) {
            openDetailView(currentDetailAcc.id);
        }
    }
    
    function updateCurrencyButton() {
        const btn = document.getElementById('currencyToggleBtn');
        const text = document.getElementById('currencyToggleText');
        if(btn && text) {
            // 顯示當前幣別
            text.innerText = currentDisplayCurrency;
            btn.title = `當前顯示: ${currentDisplayCurrency}，點擊切換至 ${currentDisplayCurrency === 'TWD' ? 'USD' : 'TWD'}`;
        }
    }
    
    // 4. Start the app only after everything is defined
    async function init() {
        initSidebarState();
        initNumbersState();
        initSwiper();
        updateCurrencyButton();
        chartLevel = 'root';
        currentPage = 0;
        renderAssets();
        // 初始化箭頭按鈕狀態
        updatePageNavArrows();
        setTimeout(() => { 
            initChart(); 
            // 初始化時不自動居中，只在用戶切換分頁時才居中
            // 確保圖表在手機模式下正確渲染
            setTimeout(() => {
                if(chartInstance) {
                    const chartWrapper = document.getElementById('chartWrapper');
                    if(chartWrapper) {
                        const wrapperWidth = chartWrapper.clientWidth;
                        const wrapperHeight = chartWrapper.clientHeight;
                        if(wrapperWidth > 0 && wrapperHeight > 0) {
                            chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            chartInstance.reflow();
                            // 再次確保文字正確顯示
                            setTimeout(() => {
                                if(chartInstance) {
                                    chartInstance.reflow();
                                }
                            }, 100);
                        }
                    }
                }
            }, 200);
        }, 500);
        
        // 監聽窗口大小改變，重新調整圖表
        let resizeTimer;
        let lastWidth = window.innerWidth;
        let lastIsDesktop = window.innerWidth >= 768;
        
        const handleResize = () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const currentWidth = window.innerWidth;
                const currentIsDesktop = currentWidth >= 768;
                const widthChanged = Math.abs(currentWidth - lastWidth) > 50;
                const mediaQueryChanged = lastIsDesktop !== currentIsDesktop;
                
                lastWidth = currentWidth;
                lastIsDesktop = currentIsDesktop;
                
                if(chartInstance) {
                    const chartWrapper = document.getElementById('chartWrapper');
                    const assetChart = document.getElementById('assetChart');
                    if(chartWrapper && assetChart) {
                        // 觸發重排，確保CSS媒體查詢已應用
                        chartWrapper.offsetHeight;
                        assetChart.offsetHeight;
                        
                        // 獲取容器的實際寬度和高度
                        const wrapperWidth = chartWrapper.clientWidth;
                        const wrapperHeight = chartWrapper.clientHeight;
                        
                        // 如果媒體查詢改變或寬度變化較大，需要更徹底地重新渲染
                        if(mediaQueryChanged || widthChanged) {
                            // 強制清除圖表的固定尺寸
                            const svg = chartWrapper.querySelector('svg');
                            if(svg) {
                                svg.removeAttribute('width');
                                svg.removeAttribute('height');
                                svg.style.width = '100%';
                                svg.style.height = '100%';
                                svg.style.maxWidth = '100%';
                            }
                            
                            // 強制設置圖表大小
                            if(wrapperWidth > 0 && wrapperHeight > 0) {
                                chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            }
                            
                            // 強制重新計算圖表大小
                            chartInstance.reflow();
                            
                            // 多次嘗試確保更新完成
                            requestAnimationFrame(() => {
                                if(chartInstance) {
                                    const newWidth = chartWrapper.clientWidth;
                                    const newHeight = chartWrapper.clientHeight;
                                    if(newWidth > 0 && newHeight > 0) {
                                        chartInstance.setSize(newWidth, newHeight, false);
                                        chartInstance.reflow();
                                        setTimeout(() => {
                                            if(chartInstance) {
                                                const finalWidth = chartWrapper.clientWidth;
                                                const finalHeight = chartWrapper.clientHeight;
                                                if(finalWidth > 0 && finalHeight > 0) {
                                                    chartInstance.setSize(finalWidth, finalHeight, false);
                                                    chartInstance.reflow();
                                                    // 最後一次確保 SVG 尺寸正確
                                                    requestAnimationFrame(() => {
                                                        if(chartInstance) {
                                                            chartInstance.reflow();
                                                            const svg = chartWrapper.querySelector('svg');
                                                            if(svg) {
                                                                svg.style.width = '100%';
                                                                svg.style.height = '100%';
                                                                svg.style.maxWidth = '100%';
                                                            }
                                                        }
                                                    });
                                                }
                                            }
                                        }, 150);
                                    }
                                }
                            });
                        } else {
                            // 小幅度變化，簡單重新計算
                            if(wrapperWidth > 0 && wrapperHeight > 0) {
                                chartInstance.setSize(wrapperWidth, wrapperHeight, false);
                            }
                            chartInstance.reflow();
                            setTimeout(() => {
                                if(chartInstance) {
                                    const newWidth = chartWrapper.clientWidth;
                                    const newHeight = chartWrapper.clientHeight;
                                    if(newWidth > 0 && newHeight > 0) {
                                        chartInstance.setSize(newWidth, newHeight, false);
                                        chartInstance.reflow();
                                    }
                                }
                            }, 100);
                        }
                    }
                }
            }, 200);
        };
        
        window.addEventListener('resize', handleResize);
        
        // 監聽媒體查詢變化（更可靠的方式）
        if(window.matchMedia) {
            const mediaQuery = window.matchMedia('(min-width: 768px)');
            mediaQuery.addEventListener('change', () => {
                handleResize();
            });
        }
        
        await updateRates(); 
        if(settings.apiKey||settings.fugleKey) fetchPrices();
        setInterval(() => { refreshAllData(false); }, 60000);
    }
    
    // Calendar Functions
    let currentCalendarDate = new Date();
    let selectedDate = null;
    function switchToCalendarPage(showCalendar) {
        const calendarPage = document.getElementById('calendarPage');
        const contentGrid = document.querySelector('.content-grid');
        const assetListTab = document.getElementById('assetListTab');
        const calendarTabBtn = document.getElementById('calendarTabBtn');
        const pageIndicator = document.querySelector('.page-indicator');
        const navbarTitle = document.querySelector('.navbar h1');
        if(showCalendar) {
            calendarPage.style.display = 'block';
            if(contentGrid) contentGrid.style.display = 'none';
            assetListTab?.classList.remove('active');
            calendarTabBtn?.classList.add('active');
            if(pageIndicator) {
                pageIndicator.innerHTML = '';
            }
            if(navbarTitle) navbarTitle.textContent = '日期';
            const todayDateEl = document.getElementById('calendarTodayDate');
            if(todayDateEl) {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;
                const day = today.getDate();
                todayDateEl.textContent = `${year}年${month}月${day}日`;
            }
            renderCalendar();
        } else {
            calendarPage.style.display = 'none';
            if(contentGrid) contentGrid.style.display = '';
            assetListTab?.classList.add('active');
            calendarTabBtn?.classList.remove('active');
            if(pageIndicator) {
                pageIndicator.innerHTML = '<button class="page-tab active" data-page="0" onclick="switchToPage(0)">總覽</button><button class="page-tab" data-page="1" onclick="switchToPage(1)">銀行</button><button class="page-tab" data-page="2" onclick="switchToPage(2)">美股</button><button class="page-tab" data-page="3" onclick="switchToPage(3)">台股</button><button class="page-tab" data-page="4" onclick="switchToPage(4)">加密</button>';
                switchToPage(currentPage);
            }
            if(navbarTitle) navbarTitle.textContent = '資產總覽';
        }
    }
    function changeCalendarMonth(delta) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
        renderCalendar();
        const todayDateEl = document.getElementById('calendarTodayDate');
        if(todayDateEl && document.getElementById('calendarPage').style.display === 'block') {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            todayDateEl.textContent = `${year}年${month}月${day}日`;
        }
    }
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYear = document.getElementById('calendarMonthYear');
        if(!grid || !monthYear) return;
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        monthYear.textContent = `${year}年${month + 1}月`;
        grid.innerHTML = '';
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const selected = selectedDate ? new Date(selectedDate) : null;
        if(selected) selected.setHours(0, 0, 0, 0);
        for(let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            const day = date.getDate();
            const isOtherMonth = date.getMonth() !== month;
            const isToday = date.getTime() === today.getTime();
            const isSelected = selected && date.getTime() === selected.getTime();
            const dayBtn = document.createElement('button');
            dayBtn.className = 'calendar-day';
            dayBtn.textContent = day;
            if(isOtherMonth) dayBtn.classList.add('other-month');
            if(isToday) dayBtn.classList.add('today');
            if(isSelected) dayBtn.classList.add('selected');
            dayBtn.onclick = () => selectDate(date);
            grid.appendChild(dayBtn);
        }
    }
    function selectDate(date) {
        selectedDate = new Date(date);
        renderCalendar();
        console.log('Selected date:', selectedDate.toLocaleDateString('zh-TW'));
    }
    
    init();
</script>
</body>
</html>



