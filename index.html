<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>我的資產</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/192/wallet.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/wallet.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000; --card-bg: #1c1c1e; --text-primary: #ffffff; --text-secondary: #8e8e93;
            --color-bank: #64d2ff; --color-stock: #bf5af2; --color-crypto: #ff9f0a; --color-debt: #ff453a;
            --color-up: #30d158; --color-down: #ff453a; --border-color: #2c2c2e;
        }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; user-select: none; overflow-x: hidden; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow-y: auto; position: relative; }
        
        /* Sidebar */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 998; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #1c1c1e; z-index: 999; transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 2px 0 15px rgba(0,0,0,0.5); padding-top: max(20px, env(safe-area-inset-top)); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar.active { left: 0; }
        
        @media (min-width: 768px) {
            .sidebar { position: static; left: 0; box-shadow: none; }
            .sidebar-overlay { display: none !important; }
            .hamburger-btn { display: none !important; }
            .main-content { display: grid; grid-template-rows: auto 1fr; overflow: hidden; }
            .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; overflow-y: auto; height: 100%; }
            .summary-card { text-align: left !important; padding: 0 !important; margin-bottom: 20px; }
            .tab-bar { display: none !important; }
            body { padding-bottom: 0; }
            .modal { align-items: center; justify-content: center; display: flex; }
            .modal-content-wrapper { width: 500px !important; height: 80% !important; max-height: 700px; border-radius: 16px; border: 1px solid var(--border-color); position: relative !important; overflow: hidden; display: flex; flex-direction: column; }
        }

        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--bg-color); position: sticky; top: 0; z-index: 100; height: 60px; width: 100%; }
        .navbar h1 { font-size: 20px; margin: 0; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%); white-space: nowrap; }
        .btn-group { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; color: #0a84ff; font-size: 20px; cursor: pointer; padding: 5px; }
        .btn-icon.active { color: var(--color-up); }

        .sidebar-header { padding: 20px 25px; border-bottom: 1px solid #2c2c2e; }
        .sidebar-header h2 { margin: 0; font-size: 24px; font-weight: 700; color: #fff; }
        .sidebar-menu { padding: 10px 0; flex: 1; overflow-y: auto; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; font-size: 17px; color: #fff; cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: #2c2c2e; }
        .menu-item i { margin-right: 15px; width: 24px; text-align: center; color: #0a84ff; font-size: 20px; }
        .menu-text { flex: 1; }
        .menu-label { padding: 15px 25px 5px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; margin-top: 10px; }

        .summary-card { padding: 10px 20px 0 20px; text-align: center; position: relative; z-index: 90; }
        .total-label { color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .total-amount { font-size: 40px; font-weight: 700; margin: 5px 0 5px 0; font-family: 'Roboto', sans-serif; }
        .pnl-badge { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: inline-block; padding: 4px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); }
        .pnl-up { color: var(--color-up); } .pnl-down { color: var(--color-down); }
        .rate-info { display: flex; justify-content: center; gap: 10px; margin-top: 5px; margin-bottom: 10px; }
        .rate-badge { display: inline-flex; align-items: center; font-size: 12px; color: var(--text-secondary); background: #1c1c1e; padding: 4px 10px; border-radius: 12px; }
        .rate-badge i { font-size: 10px; margin-right: 5px; color: #ffcc00; }

        #chartWrapper { margin: 0; background: transparent; position: relative; height: 320px; width: 100%; display: flex; justify-content: center; align-items: center; overflow: visible; z-index: 80; }
        
        #customTooltip { position: absolute; background: rgba(255, 255, 255, 0.95); color: #000; padding: 10px 14px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); pointer-events: none; z-index: 200; display: none; white-space: nowrap; top: 0; left: 0; transform: translate(-50%, -100%); transition: opacity 0.15s, top 0.15s, left 0.15s; margin-top: -15px; }
        #customTooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: rgba(255,255,255,0.95) transparent transparent transparent; }
        #customTooltip.bottom { transform: translate(-50%, 0); margin-top: 20px; }
        #customTooltip.bottom::after { top: -12px; border-color: transparent transparent rgba(255,255,255,0.95) transparent; }
        .tt-header { font-size: 11px; color: #666; margin-bottom: 2px; font-weight: 500; }
        .tt-body { font-size: 15px; color: #000; font-weight: 700; display: flex; align-items: center; }
        .tt-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .chart-back-btn { position: absolute; top: 10px; left: 20px; z-index: 201; background: rgba(44, 44, 46, 0.9); color: #0a84ff; border: 1px solid #333; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: none; backdrop-filter: blur(10px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .group-header { padding: 15px 20px 8px 20px; font-size: 13px; color: var(--text-secondary); background-color: var(--bg-color); display: flex; justify-content: space-between; text-transform: uppercase; }
        .group-total { color: var(--text-primary); font-weight: 600; display: block;} .group-pnl { font-size: 11px; display: block; margin-top: 2px; text-align: right;}
        .list-container { background-color: var(--card-bg); border-radius: 12px; margin: 0 16px 10px 16px; overflow: hidden; }
        .list-item { display: flex; align-items: flex-start; padding: 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: var(--card-bg); }
        .list-item:last-child { border-bottom: none; } .list-item:active { background-color: #2c2c2e; }
        .item-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; flex-shrink: 0; align-self: flex-start; margin-top: 0; }
        .icon-bank { color: var(--color-bank); background: rgba(100, 210, 255, 0.15); } .icon-crypto { color: var(--color-crypto); background: rgba(255, 159, 10, 0.15); } .icon-stock { color: var(--color-stock); background: rgba(191, 90, 242, 0.15); } .icon-debt { color: var(--color-debt); background: rgba(255, 69, 58, 0.15); }
        .item-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: flex-start; }
        .item-name { font-size: 17px; font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        .item-row { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.35; margin-bottom: 0; }
        .item-amount { text-align: right; margin-left: 10px; display: flex; flex-direction: column; justify-content: flex-start; }
        .amount-val { font-size: 17px; font-weight: 500; font-family: 'Roboto', sans-serif; line-height: 1.2; margin-bottom: 2px; }
        .amount-pnl { font-size: 12px; margin-top: 0; margin-bottom: 0; font-weight: 500; line-height: 1.35; }
        .amount-spacer { font-size: 13px; line-height: 1.35; color: transparent; margin: 0; padding: 0; min-height: 1.35em; display: block; }
        .amount-spacer::before { content: '\00a0'; }
        .amount-spacer { font-size: 13px; line-height: 1.35; visibility: hidden; height: 0; }
        .amount-green { color: var(--color-up); } .amount-red { color: var(--color-down); } .sub-green { color: var(--color-up); } .sub-red { color: var(--color-down); }
        .drag-handle { display: none; color: #666; font-size: 20px; padding-left: 15px; cursor: grab; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); z-index: 200; }
        .tab-item { color: var(--text-secondary); text-align: center; font-size: 10px; background: none; border: none; width: 30%; }
        .tab-item i { font-size: 20px; margin-bottom: 4px; display: block; } .tab-item.active { color: #0a84ff; }
        .fa-spin-fast { animation: fa-spin 1s infinite linear; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow: hidden; }
        .modal-content-wrapper { width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; padding: 15px 20px; background: #1c1c1e; align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #2c2c2e; flex-shrink: 0; }
        .modal-title { font-size: 17px; font-weight: 600; }
        .modal-tabs { display: flex; padding: 10px 16px; gap: 10px; border-bottom: 1px solid #2c2c2e; background: #1c1c1e; flex-shrink: 0; }
        .modal-tab { flex: 1; text-align: center; padding: 8px; color: #8e8e93; font-size: 14px; font-weight: 600; border-radius: 8px; background: #2c2c2e; cursor: pointer; }
        .modal-tab.active { background: #3a3a3c; color: #fff; }
        .tab-content { display: none; padding-bottom: 40px; flex: 1; overflow-y: auto; } .tab-content.active { display: block; }
        .form-group { background: #1c1c1e; margin-top: 20px; border-radius: 12px; overflow: hidden; margin-left: 16px; margin-right: 16px; }
        .form-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .form-row:last-child { border-bottom: none; }
        .form-label { font-size: 16px; color: #fff; min-width: 80px; }
        .form-input { background: transparent; border: none; color: var(--text-secondary); text-align: right; font-size: 16px; outline: none; width: 100%; }
        select.form-input { appearance: none; direction: rtl; }
        .delete-btn-area { margin-top: 30px; padding: 0 16px; padding-bottom: 50px; }
        .btn-delete { width: 100%; background: #1c1c1e; color: var(--color-debt); border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 500; }
        .hint-text { color: #555; font-size: 12px; margin-top: 8px; padding: 0 20px; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #30d158; color: #000; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 14px; z-index: 2000; display: none; }
        .ai-btn-area { margin: 15px 16px 0 16px; }
        .btn-ai { width: 100%; background: linear-gradient(135deg, #0a84ff, #5e5ce6); color: #fff; border: none; padding: 12px; border-radius: 12px; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-ai:disabled { background: #3a3a3c; color: #8e8e93; cursor: not-allowed; opacity: 0.6; }
        .progress-container { width: 100%; height: 4px; background: #2c2c2e; border-radius: 2px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0a84ff, #5e5ce6); width: 0%; transition: width 0.3s ease; border-radius: 2px; }

        /* Detail View */
        #detailView { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #detailView.active { transform: translateX(0); }
        .detail-header { padding: 30px 20px 20px; border-bottom: 1px solid #2c2c2e; background: #1c1c1e; flex-shrink: 0; }
        .detail-title { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .detail-subtitle { font-size: 14px; color: #8e8e93; }
        .detail-stats { display: flex; justify-content: space-between; margin-top: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-val { font-size: 18px; font-weight: 600; display: block; color: #fff; }
        .stat-lbl { font-size: 12px; color: #8e8e93; margin-top: 4px; display: block; }
        .val-green { color: var(--color-up); } .val-red { color: var(--color-down); }
        .detail-list { flex: 1; overflow-y: auto; padding: 15px; }
        .tx-item { background: #1c1c1e; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #2c2c2e; }
        .tx-header-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .tx-badge { background: #64d2ff; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .tx-date { color: #8e8e93; font-size: 13px; }
        .tx-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; }
        .tx-label { color: #8e8e93; }
        .tx-val { color: #fff; font-weight: 500; }
        .tx-pnl { font-weight: bold; font-size: 14px; }
        .tx-no-data { text-align: center; color: #666; padding: 30px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div id="migrationToast" class="toast">資料已還原</div>
    <div id="importProgressToast" class="toast" style="background: #0a84ff; display: none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                <div id="importProgressBar" style="height: 100%; background: #fff; width: 0%; transition: width 0.3s;"></div>
            </div>
            <span id="importProgressText">匯入中...</span>
        </div>
    </div>
    <input type="file" id="importFileInput" accept=".json" style="display:none;" onchange="handleFileImport(event)">

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar & Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header"><h2>設定</h2></div>
            <div class="sidebar-menu">
                <div class="menu-label">API 設定</div>
                <div class="menu-item" onclick="setApiKey('finnhub'); toggleSidebar();"><i class="fas fa-chart-line"></i><span class="menu-text">Finnhub Key (報價)</span></div>
                <div class="menu-item" onclick="setApiKey('gemini'); toggleSidebar();"><i class="fas fa-robot"></i><span class="menu-text">Gemini Key (讀圖)</span></div>
                <div class="menu-label">資料管理</div>
                <div class="menu-item" onclick="exportData(); toggleSidebar();"><i class="fas fa-file-export"></i><span class="menu-text">匯出備份</span></div>
                <div class="menu-item" onclick="importData(); toggleSidebar();"><i class="fas fa-file-import"></i><span class="menu-text">匯入還原</span></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="navbar">
                <button class="btn-icon hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h1>我的資產</h1>
                <div class="btn-group">
                    <button class="btn-icon" id="sortBtn" onclick="toggleEditMode()"><i class="fas fa-sort-amount-down"></i></button>
                    <button class="btn-icon" id="addBtn" onclick="openModal()"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="content-grid">
                <div class="chart-section">
                    <div class="summary-card">
                        <div class="total-label">總淨資產 (TWD)</div>
                        <div class="total-amount" id="totalNetWorth">NT$ --</div>
                        <div id="totalPnLBlock" style="display:none;"><div class="pnl-badge" id="totalPnLBadge">今日: +0</div></div>
                        <div class="rate-info">
                            <div class="rate-badge"><i class="fas fa-coins"></i><span id="rateUsdt">USDT ...</span></div>
                            <div class="rate-badge"><i class="fas fa-exchange-alt"></i><span id="rateUsd">USD ...</span></div>
                        </div>
                    </div>

                    <div id="chartWrapper">
                        <div id="customTooltip"><div class="tt-header">類別</div><div class="tt-body"><span class="tt-dot"></span>資產: 0</div></div>
                        <button class="chart-back-btn" id="chartBackBtn" onclick="resetChartLevel()"><i class="fas fa-chevron-left"></i> 返回總覽</button>
                        <div id="assetChart" style="width:100%; height:100%;"></div>
                    </div>
                </div>

                <div class="list-section">
                    <div id="assetsContainer"></div>
                    <div style="height: 60px;" class="mobile-spacer"></div>
                </div>
            </div>

            <div class="tab-bar">
                <button class="tab-item active"><i class="fas fa-wallet"></i>資產列表</button>
                <button class="tab-item" id="refreshBtn" onclick="refreshAllData()"><i id="refreshIcon" class="fas fa-sync-alt"></i>立即更新</button>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView">
        <div class="navbar">
            <button class="btn-icon" onclick="closeDetailView()"><i class="fas fa-arrow-left"></i></button>
            <h1 id="detailTitleName">資產詳情</h1>
            <button class="btn-icon" onclick="editCurrentAsset()"><i class="fas fa-edit"></i></button>
        </div>
        <div class="detail-header">
            <div class="detail-title" id="dName">NVDA</div>
            <div class="detail-subtitle" id="dSymbol">NVIDIA Corp</div>
            <div class="detail-stats">
                <div class="stat-item"><span class="stat-val" id="dQty">0</span><span class="stat-lbl">持有股數</span></div>
                <div class="stat-item"><span class="stat-val" id="dPrice">$0</span><span class="stat-lbl">現價 (USD)</span></div>
                <div class="stat-item"><span class="stat-val" id="dVal">NT$0</span><span class="stat-lbl">參考市值</span></div>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <div id="dDailyPnl" style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: 600;">當天損益</div>
                    <span id="dDailyPnlVal" style="font-size: 20px; font-weight: 700;">+0</span>
                </div>
                <div id="dCostPnl">
                    <div style="font-size: 18px; font-weight: 600;">持股成本損益</div>
                    <span id="dCostPnlVal" style="font-size: 24px; font-weight: 700;">+0 (0%)</span>
                    <div style="font-size: 12px; color: #8e8e93; margin-top: 5px;">參考損益 (含手續費)</div>
                </div>
            </div>
        </div>
        <div class="detail-list" id="detailTxList"></div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <button class="btn-icon" onclick="closeModal()">取消</button>
                <span class="modal-title" id="modalTitle">帳戶編輯</span>
                <button class="btn-icon" style="font-weight:bold;" onclick="saveAccount()">儲存</button>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('basic')" id="tabBasic">基本設定</div>
                <div class="modal-tab" onclick="switchTab('detail')" id="tabDetail">庫存明細</div>
            </div>
            <div id="contentBasic" class="tab-content active">
                <div class="ai-btn-area" id="aiArea" style="display:none;">
                    <div style="margin-bottom: 10px; padding: 0 5px;">
                        <span style="font-size: 12px; color: #8e8e93;">選擇券商 (手續費率)</span>
                        <select id="brokerSelect" class="form-input" style="background: #333; border-radius: 8px; padding: 5px; margin-top: 5px;" onchange="updateFeeDisplay()">
                            <option value="cathay">國泰證券 (0.1%)</option>
                            <option value="fubon">富邦證券 (0.25%)</option>
                            <option value="custom">自訂...</option>
                        </select>
                    </div>
                    <button class="btn-ai" id="btnAI" onclick="triggerImageUpload()"><i class="fas fa-camera"></i> 匯入截圖 (AI 辨識)</button>
                    <input type="file" id="imgUpload" multiple accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                    <div id="aiStatus" style="text-align:center; color:#aaa; font-size:12px; margin-top:5px;"></div>
                    <div class="progress-container" id="aiProgress">
                        <div class="progress-bar" id="aiProgressBar"></div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-row"><span class="form-label">類型</span><select id="inpType" class="form-input" onchange="handleTypeChange()"><option value="bank">銀行</option><option value="crypto">加密貨幣</option><option value="stock">投資理財</option><option value="debt">負債</option></select></div>
                    <div class="form-row" id="rowName"><span class="form-label">名稱</span><input type="text" id="inpName" class="form-input" placeholder="例如: NVDA"></div>
                    <div class="form-row" id="rowSymbol" style="display:none;"><span class="form-label">代碼</span><input type="text" id="inpSymbol" class="form-input" placeholder="例如: NVDA" oninput="syncNameFromSymbol(); updateAIButtonState();"></div>
                    <div class="form-row" id="rowCurrency"><span class="form-label">幣別</span><select id="inpCurrency" class="form-input"><option value="TWD">TWD (新台幣)</option><option value="USD">USD (美金)</option></select></div>
                    <div class="form-row"><span class="form-label" id="lblBalance">股數</span><input type="number" id="inpBalance" class="form-input" placeholder="0"></div>
                    <div class="form-row" id="rowCost" style="display:none;"><span class="form-label">平均成本</span><input type="number" id="inpCost" class="form-input" placeholder="0 (USD)"></div>
                </div>
                <div id="symbolHint" class="hint-text" style="display:none;">* 輸入代碼，預設使用美金報價</div>
                <div class="delete-btn-area"><button id="btnDelete" class="btn-delete" onclick="deleteAccount()">刪除</button></div>
            </div>
            <div id="contentDetail" class="tab-content">
                <div class="tx-list" id="txListContainer"><div class="tx-no-data">尚未匯入明細資料</div></div>
            </div>
        </div>
    </div>

<script>
    // 1. Define Constants & Globals
    const STORAGE_KEY_DATA = 'my_assets_stable_data';
    const STORAGE_KEY_SETTINGS = 'my_assets_stable_settings';
    
    const TYPE_COLORS = { 'bank': '#64d2ff', 'stock': '#bf5af2', 'crypto': '#ff9f0a', 'debt': '#ff453a' };
    const TYPE_NAMES = { 'bank': '銀行', 'stock': '投資理財', 'crypto': '加密貨幣', 'debt': '負債' };

    let editingId = null;
    let chartInstance = null;
    let clickTimer = null; 
    let currentDetails = {};
    let chartLevel = 'root';
    let isEditMode = false;
    let sortables = [];
    let currentDetailAcc = null;

    // 2. Define Data Loading Functions
    function safeParseFloat(val) { let v = parseFloat(val); return isNaN(v) ? 0 : v; }
    
    function tryMigrateOldData() {
        if (localStorage.getItem(STORAGE_KEY_DATA)) return;
        const oldKeys = ['myAssets_v6', 'myAssets_v5', 'myAssets_v4'];
        let found = false;
        for (let key of oldKeys) {
            let d = localStorage.getItem(key);
            if (d) { localStorage.setItem(STORAGE_KEY_DATA, d); found = true; break; }
        }
        let oldS = localStorage.getItem('myAssets_settings_v3');
        if (oldS) localStorage.setItem(STORAGE_KEY_SETTINGS, oldS);
        if (found) {
            const t = document.getElementById('migrationToast');
            t.style.display='block'; setTimeout(()=>t.style.display='none',3000);
        }
    }
    
    // Execute Migration Immediately
    tryMigrateOldData();

    // Load State
    let rawAccounts = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || [];
    let accounts = rawAccounts.map((a, index) => ({ 
        ...a, balance: safeParseFloat(a.balance), currentPrice: safeParseFloat(a.currentPrice), 
        dayChange: safeParseFloat(a.dayChange || 0), dayChangePercent: safeParseFloat(a.dayChangePercent || 0), 
        cost: safeParseFloat(a.cost || 0), order: (a.order!==undefined)?a.order:index, transactions: a.transactions || [] 
    }));
    let settings = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { apiKey: '', geminiKey: '', usdRate: 32.5, usdtRate: 1.0, feeRate: 0.1425 };

    // 3. Define ALL Functions (Chart, UI, Logic)

    // --- Chart ---
    function onPointClick(e) { 
        e.stopPropagation(); 
        if (clickTimer) { 
            clearTimeout(clickTimer); clickTimer = null; 
            if(chartLevel==='root'&&currentDetails[this.drilldown]){ hideCustomTooltip(); enterDetailLevel(this.drilldown, currentDetails[this.drilldown]); } 
        } else { 
            let t=this; let ex=e; 
            clickTimer=setTimeout(function(){ clickTimer=null; if(t.sliced){ t.slice(false); hideCustomTooltip(); } else { if(t.series.data) t.series.data.forEach(p=>{ if(p!==t&&p.sliced)p.slice(false); }); t.slice(true); showCustomTooltip(t, ex); } }, 250); 
        } 
    }
    
    function showCustomTooltip(p,e){ 
        const t=document.getElementById('customTooltip'); 
        const w=document.getElementById('chartWrapper'); 
        t.querySelector('.tt-header').innerText=p.name; 
        t.querySelector('.tt-body').innerHTML=`<span class="tt-dot" style="background-color:${p.color}"></span>資產: ${Math.round(p.y).toLocaleString()} TWD`; 
        t.className=''; t.style.display='block'; 
        let cx=e.chartX; let cy=e.chartY; 
        if(!cx&&e.clientX){const r=w.getBoundingClientRect();cx=e.clientX-r.left;cy=e.clientY-r.top;} 
        const tw=t.offsetWidth; const th=t.offsetHeight; 
        let top=cy-th-25; let left=cx; 
        if(cy<160){top=cy+30;t.classList.add('bottom');}else{t.classList.remove('bottom');} 
        if(left<tw/2)left=tw/2+10; if(left>w.offsetWidth-tw/2)left=w.offsetWidth-tw/2-10; 
        t.style.top=top+'px'; t.style.left=left+'px'; 
    }
    
    function hideCustomTooltip(){ document.getElementById('customTooltip').style.display='none'; }

    function updateChartData() { 
        if(!Highcharts)return; 
        let groups={'bank':0,'stock':0,'crypto':0}; 
        currentDetails={'bank':[],'stock':[],'crypto':[]}; 
        
        accounts.forEach(acc=>{ 
            if(acc.type==='debt')return; 
            let val=calculateTWD(acc); 
            if(val>0){ 
                if(groups[acc.type]!==undefined){ 
                    groups[acc.type]+=val; 
                    currentDetails[acc.type].push({name:acc.name,y:Math.round(val)}); 
                } 
            } 
        }); 
        
        let rootData=[{name:TYPE_NAMES['bank'],y:Math.round(groups.bank),drilldown:'bank',color:TYPE_COLORS.bank},{name:TYPE_NAMES['stock'],y:Math.round(groups.stock),drilldown:'stock',color:TYPE_COLORS.stock},{name:TYPE_NAMES['crypto'],y:Math.round(groups.crypto),drilldown:'crypto',color:TYPE_COLORS.crypto}].filter(d=>d.y>0); 
        
        if(!chartInstance){ 
            chartInstance=Highcharts.chart('assetChart',{
                chart:{type:'pie',backgroundColor:'transparent',spacing:[30,0,20,0],height:'100%'},
                title:{text:null},credits:{enabled:false},tooltip:{enabled:false},
                plotOptions:{pie:{innerSize:'60%',size:'60%',center:['50%','50%'],borderWidth:0,slicedOffset:10,animation:{duration:800,easing:'easeOutQuart'},dataLabels:{enabled:true,distance:5,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666',softConnector:true},states:{hover:{enabled:false},inactive:{opacity:1}},point:{events:{click:onPointClick}}}},
                series:[{name:'資產',data:rootData}]
            }); 
        } else { 
            if(chartLevel==='root'){ 
                if(chartInstance.series.length===0){ 
                    chartInstance.addSeries({name:'資產',data:rootData,type:'pie',innerSize:'60%',size:'60%',center:['50%','50%'],borderWidth:0,slicedOffset:10,animation:{duration:800,easing:'easeOutQuart'},dataLabels:{enabled:true,distance:5,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'},states:{hover:{enabled:false}},point:{events:{click:onPointClick}}}); 
                } else { 
                    chartInstance.series[0].setData(rootData); 
                } 
            } 
        } 
    }
    
    function enterDetailLevel(cat, data) { 
        chartLevel='detail'; document.getElementById('chartBackBtn').style.display='block'; hideCustomTooltip(); 
        if(chartInstance.series[0])chartInstance.series[0].remove(false); 
        chartInstance.addSeries({ name:TYPE_NAMES[cat]||cat, data:data, type:'pie', innerSize:'60%', size:'60%', center:['50%','50%'], borderWidth:0, slicedOffset:10, animation:{duration:800,easing:'easeOutQuart'}, colorByPoint:true, dataLabels:{enabled:true,distance:5,format:'{point.name}<br><span style="opacity:0.7">{point.percentage:.1f}%</span>',style:{color:'#fff',textOutline:'none',fontWeight:'normal',fontSize:'12px',pointerEvents:'none'},connectorColor:'#666'}, states:{hover:{enabled:false}}, point:{events:{click:onPointClick}} }, true); 
        chartInstance.setTitle({text:TYPE_NAMES[cat],style:{color:'#fff',fontSize:'14px'},align:'center',verticalAlign:'middle',y:10}); 
    }
    
    function resetChartLevel() { chartLevel='root'; document.getElementById('chartBackBtn').style.display='none'; chartInstance.setTitle({text:''}); hideCustomTooltip(); while(chartInstance.series.length>0)chartInstance.series[0].remove(false); updateChartData(); }
    
    function initChart() { 
        if(typeof Highcharts==='undefined')return; 
        Highcharts.setOptions({chart:{style:{fontFamily:'sans-serif'},events:{click:function(e){if(clickTimer){clearTimeout(clickTimer);clickTimer=null;}if(this.series[0])this.series[0].points.forEach(p=>p.slice(false));hideCustomTooltip();}}},title:{text:''},tooltip:{enabled:false}}); 
        updateChartData(); 
        document.getElementById('chartWrapper').addEventListener('click',function(e){const t=e.target;if(!t.tagName==='path'&&!t.closest('#chartBackBtn')&&chartInstance){if(clickTimer)clearTimeout(clickTimer);if(chartInstance.series[0])chartInstance.series[0].points.forEach(p=>p.slice(false));hideCustomTooltip();}}); 
    }

    // --- Calculations ---
    function calculateTWD(acc) { let val=0; if(acc.isAuto){ let p=acc.currentPrice||0; if(acc.currency==='USD')val=acc.balance*p*settings.usdRate; else if(acc.type==='crypto')val=acc.balance*p*settings.usdtRate*settings.usdRate; else val=acc.balance*p*settings.usdRate; } else { if(acc.currency==='USD')val=acc.balance*settings.usdRate; else val=acc.balance; } return safeParseFloat(val); }
    function calculateDailyPnL_TWD(acc) { if(!acc.isAuto||!acc.dayChange)return 0; let pnl=0; if(acc.currency==='USD')pnl=acc.balance*acc.dayChange*settings.usdRate; else if(acc.type==='crypto')pnl=acc.balance*acc.dayChange*settings.usdtRate*settings.usdRate; else pnl=acc.balance*acc.dayChange*settings.usdRate; return safeParseFloat(pnl); }
    function calculateCostPnL_TWD(acc) { if(!acc.cost||acc.cost<=0||!acc.isAuto)return 0; let cur=calculateTWD(acc); let cost=acc.balance*acc.cost*settings.usdRate; return safeParseFloat(cur-cost); }
    function calculatePnL_TWD(acc) { if(acc.cost>0&&acc.isAuto){ return calculateCostPnL_TWD(acc); } return calculateDailyPnL_TWD(acc); }
    function formatPnL(val) { if(!val)return''; const sign=val>0?'+':''; const cls=val>0?'pnl-up':(val<0?'pnl-down':''); return `<span class="${cls}">${sign}${Math.round(val).toLocaleString()} TWD</span>`; }

    // --- UI ---
    function toggleSidebar() { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebarOverlay'); if(s.classList.contains('active')){s.classList.remove('active');o.classList.remove('active');}else{s.classList.add('active');o.classList.add('active');} }
    function toggleEditMode() { isEditMode=!isEditMode; document.getElementById('sortBtn').classList.toggle('active', isEditMode); document.getElementById('addBtn').style.display=isEditMode?'none':'block'; renderAssets(); }
    function switchTab(t) { document.querySelectorAll('.modal-tab').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); document.getElementById('content'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active'); }
    function openModal() { if(isEditMode)return; editingId=null; window.tempTransactions=[]; document.getElementById('modalTitle').innerText='新增'; document.getElementById('inpName').value=''; document.getElementById('inpSymbol').value=''; switchTab('basic'); handleTypeChange(); document.getElementById('accountModal').style.display='block'; }
    function editAccount(id) { if(isEditMode)return; editingId=id; const a=accounts.find(x=>x.id===id); document.getElementById('modalTitle').innerText='編輯'; document.getElementById('inpType').value=a.type; document.getElementById('inpName').value=a.name; document.getElementById('inpSymbol').value=a.symbol; document.getElementById('inpBalance').value=a.balance; document.getElementById('inpCost').value=a.cost||''; document.getElementById('inpCurrency').value=a.currency; window.tempTransactions=a.transactions||[]; renderTransactions(window.tempTransactions); switchTab('basic'); handleTypeChange(); document.getElementById('accountModal').style.display='block'; }
    function closeModal() { document.getElementById('accountModal').style.display='none'; }
    function handleTypeChange() { const t=document.getElementById('inpType').value; const auto=(t==='stock'||t==='crypto'); const isStock=(t==='stock'); document.getElementById('rowSymbol').style.display=auto?'flex':'none'; document.getElementById('rowName').style.display=isStock?'none':'flex'; document.getElementById('rowCurrency').style.display=auto?'none':'flex'; document.getElementById('rowCost').style.display=auto?'flex':'none'; document.getElementById('aiArea').style.display=auto?'block':'none'; document.getElementById('lblBalance').innerText=auto?'股數':'金額'; if(isStock) { syncNameFromSymbol(); updateAIButtonState(); } else if(auto) { updateAIButtonState(); } else { document.getElementById('btnAI').disabled=false; } }
    function updateAIButtonState() { const t=document.getElementById('inpType').value; if(t==='stock'||t==='crypto'){ const symbol=document.getElementById('inpSymbol').value.trim(); const btnAI=document.getElementById('btnAI'); if(btnAI) btnAI.disabled=!symbol; } }
    function syncNameFromSymbol() { const t=document.getElementById('inpType').value; if(t==='stock'){ const s=document.getElementById('inpSymbol').value.trim().toUpperCase(); if(s) document.getElementById('inpName').value=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); } }
    function saveAccount() { const t=document.getElementById('inpType').value; let s=document.getElementById('inpSymbol').value.trim().toUpperCase(); let n=document.getElementById('inpName').value; let c=document.getElementById('inpCurrency').value; const b=parseFloat(document.getElementById('inpBalance').value)||0; const cost=parseFloat(document.getElementById('inpCost').value)||0; const auto=(t==='stock'||t==='crypto'); if(t==='stock'){ if(!s)return alert("代碼?"); n=s.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); c='USD'; } else if(t==='crypto'){if(!s.includes(':'))s=`COINBASE:${s}-USD`;c='USD';} if(!n)return alert("名稱?"); const newA={ id:editingId||Date.now(), type:t, name:n, symbol:s, currency:c, balance:b, cost:cost, isAuto:auto, currentPrice:editingId?(accounts.find(x=>x.id===editingId).currentPrice||0):0, dayChange:editingId?(accounts.find(x=>x.id===editingId).dayChange||0):0, dayChangePercent:editingId?(accounts.find(x=>x.id===editingId).dayChangePercent||0):0, order:editingId?(accounts.find(x=>x.id===editingId).order||0):9999, transactions: window.tempTransactions||[] }; if(editingId)accounts[accounts.findIndex(x=>x.id===editingId)]=newA; else accounts.push(newA); saveData(); closeModal(); if(currentDetailAcc && currentDetailAcc.id === newA.id) openDetailView(newA.id); if(auto)refreshAllData(); else { renderAssets(); updateChartData(); } }
    function deleteAccount() { 
        const acc = accounts.find(x => x.id === editingId);
        if (!acc) return;
        const name = acc.name || '此資產';
        if (!confirm(`確定要刪除「${name}」嗎？`)) return;
        if (!confirm(`再次確認：確定要刪除「${name}」嗎？\n此操作無法復原！`)) return;
        accounts = accounts.filter(x => x.id !== editingId);
        saveData();
        closeModal();
        closeDetailView();
        renderAssets();
    }
    function saveData() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(accounts)); }
    function updateOrder(type,container){ let ids=Array.from(container.children).map(c=>parseInt(c.getAttribute('data-id'))); ids.forEach((id,idx)=>{ let a=accounts.find(x=>x.id===id); if(a)a.order=idx; }); saveData(); }
    function setApiKey(t) { if(t==='finnhub'){const k=prompt("Finnhub Key:", settings.apiKey);if(k)settings.apiKey=k.trim();} else {const k=prompt("Gemini Key:", settings.geminiKey);if(k)settings.geminiKey=k.trim();} localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); refreshAllData(); }
    function setFeeRate() { const k=prompt("手續費率 (%):", settings.feeRate); if(k)settings.feeRate=parseFloat(k); localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); }
    function updateFeeDisplay() { const s=document.getElementById('brokerSelect'); if(s.value==='custom'){ const r=prompt("自訂費率 (%):", settings.feeRate||0.1); if(r)settings.feeRate=parseFloat(r); localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings)); } }
    function exportData() { 
        const data = {data:accounts, settings:settings};
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `my_assets_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    function importData() { 
        const choice = confirm("選擇匯入方式：\n確定 = 貼上JSON文字\n取消 = 選擇檔案");
        const progressToast = document.getElementById('importProgressToast');
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');
        if (choice) {
            const text = prompt("貼上備份JSON:");
            if (text) {
                progressToast.style.display = 'block';
                progressBar.style.width = '30%';
                progressText.innerText = '解析JSON中...';
                try {
                    setTimeout(() => {
                        progressBar.style.width = '60%';
                        progressText.innerText = '驗證資料中...';
                        const d = JSON.parse(text);
                        if (d.data && d.settings) {
                            progressBar.style.width = '80%';
                            progressText.innerText = '寫入資料中...';
                            setTimeout(() => {
                                progressBar.style.width = '100%';
                                progressText.innerText = '完成！';
                                localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(d.data));
                                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(d.settings));
                                setTimeout(() => location.reload(), 500);
                            }, 200);
                        } else {
                            progressToast.style.display = 'none';
                            progressBar.style.width = '0%';
                            alert("格式錯誤：缺少 data 或 settings");
                        }
                    }, 100);
                } catch(err) {
                    progressToast.style.display = 'none';
                    progressBar.style.width = '0%';
                    alert("解析失敗: " + err.message);
                }
            }
        } else {
            document.getElementById('importFileInput').click();
        }
    }
    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const progressToast = document.getElementById('importProgressToast');
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');
        progressToast.style.display = 'block';
        progressBar.style.width = '20%';
        progressText.innerText = '讀取檔案中...';
        const reader = new FileReader();
        reader.onload = function(e) {
            progressBar.style.width = '50%';
            progressText.innerText = '解析JSON中...';
            try {
                setTimeout(() => {
                    progressBar.style.width = '70%';
                    progressText.innerText = '驗證資料中...';
                    const d = JSON.parse(e.target.result);
                    if (d.data && d.settings) {
                        progressBar.style.width = '90%';
                        progressText.innerText = '寫入資料中...';
                        setTimeout(() => {
                            progressBar.style.width = '100%';
                            progressText.innerText = '完成！';
                            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(d.data));
                            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(d.settings));
                            setTimeout(() => location.reload(), 500);
                        }, 200);
                    } else {
                        progressToast.style.display = 'none';
                        progressBar.style.width = '0%';
                        alert("檔案格式錯誤");
                    }
                }, 100);
            } catch(err) {
                progressToast.style.display = 'none';
                progressBar.style.width = '0%';
                alert("讀取檔案失敗: " + err.message);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // Detail View
    function openDetailView(id) {
        if (isEditMode) return;
        currentDetailAcc = accounts.find(x => x.id === id);
        if (!currentDetailAcc) return;
        if (!currentDetailAcc.isAuto) { editAccount(id); return; }
        document.getElementById('dName').innerText = currentDetailAcc.name; document.getElementById('dSymbol').innerText = currentDetailAcc.symbol; document.getElementById('dQty').innerText = currentDetailAcc.balance;
        let price = currentDetailAcc.currentPrice || 0; document.getElementById('dPrice').innerText = `$${price.toLocaleString()}`;
        let valTWD = calculateTWD(currentDetailAcc); document.getElementById('dVal').innerText = `NT$ ${Math.round(valTWD).toLocaleString()}`;
        let cost = currentDetailAcc.cost || 0; let fee = settings.feeRate || 0.1;
        
        // 當天損益
        let dailyPnL = calculateDailyPnL_TWD(currentDetailAcc);
        let dailySign = dailyPnL >= 0 ? '+' : '';
        let dailyColor = dailyPnL >= 0 ? 'var(--color-up)' : (dailyPnL < 0 ? 'var(--color-down)' : '#fff');
        document.getElementById('dDailyPnlVal').innerHTML = `<span style="color:${dailyColor}">${dailySign}NT$ ${Math.round(dailyPnL).toLocaleString()}</span>`;
        
        // 持股成本損益
        let costPnL = calculateCostPnL_TWD(currentDetailAcc);
        let costPnLUSD = (price - cost) * currentDetailAcc.balance;
        let costPnLTWD = costPnLUSD * settings.usdRate;
        let costPnlPct = (cost > 0) ? ((price - cost) / cost) * 100 : 0;
        let costSign = costPnLTWD >= 0 ? '+' : '';
        let costColor = '#fff';
        if (cost > 0) {
            costColor = costPnLTWD >= 0 ? 'var(--color-up)' : 'var(--color-down)';
        }
        if (cost > 0) {
            document.getElementById('dCostPnl').style.display = 'block';
            document.getElementById('dCostPnlVal').innerHTML = `<span style="color:${costColor}">${costSign}NT$ ${Math.round(costPnLTWD).toLocaleString()} (${costPnlPct.toFixed(2)}%)</span>`;
        } else {
            document.getElementById('dCostPnl').style.display = 'none';
        }
        const txList = document.getElementById('detailTxList'); txList.innerHTML = '';
        if (currentDetailAcc.transactions && currentDetailAcc.transactions.length > 0) {
            currentDetailAcc.transactions.forEach(tx => {
                let txPnlHtml = '';
                if (price > 0 && tx.price > 0) {
                     let txCost = tx.price * (1 + fee/100); let txProfit = (price - txCost) * tx.shares; let txProfitTWD = txProfit * settings.usdRate; let txSign = txProfitTWD >= 0 ? '+' : ''; let txColor = txProfitTWD >= 0 ? 'val-green' : 'val-red'; let txPct = ((price - txCost) / txCost) * 100;
                     txPnlHtml = `<div class="tx-row"><span class="tx-label">損益</span><span class="tx-val ${txColor}">${txSign}NT$ ${Math.round(txProfitTWD).toLocaleString()} (${txPct.toFixed(1)}%)</span></div>`;
                }
                txList.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val">$${tx.price}</span></div>${txPnlHtml}</div>`;
            });
        } else { txList.innerHTML = '<div class="tx-no-data">無詳細交易紀錄<br>請在編輯模式匯入截圖</div>'; }
        document.getElementById('detailView').classList.add('active');
    }
    function closeDetailView() { document.getElementById('detailView').classList.remove('active'); }
    function editCurrentAsset() { if(currentDetailAcc) { closeDetailView(); editAccount(currentDetailAcc.id); } }

    // AI
    function triggerImageUpload() { if(!settings.geminiKey)return alert("請先設定 Gemini Key"); document.getElementById('imgUpload').click(); }
    async function handleImageUpload(input) {
        if(!input.files || input.files.length === 0) return;
        const status = document.getElementById('aiStatus'); 
        const progressContainer = document.getElementById('aiProgress');
        const progressBar = document.getElementById('aiProgressBar');
        status.innerText = `讀取圖片中...`; status.style.color = "#aaa";
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        try {
            const files = Array.from(input.files);
            const promises = files.map((f, idx) => new Promise((res,rej)=>{
                const r=new FileReader();
                r.onload=e=>{
                    progressBar.style.width = `${20 + (idx + 1) * 30 / files.length}%`;
                    res({inlineData:{mimeType:f.type,data:e.target.result.split(',')[1]}});
                };
                r.onerror=rej;
                r.readAsDataURL(f);
            }));
            const images = await Promise.all(promises);
            progressBar.style.width = '60%';
            status.innerText = `AI 分析中...`; status.style.color = "#0a84ff";
            const broker = document.getElementById('brokerSelect').value;
            let fee = 0.1; if (broker === 'fubon') fee = 0.25; else if (broker === 'custom') fee = settings.feeRate || 0.1;
            const prompt = `Analyze brokerage screenshots. 1. Extract transaction list: [{"date": "MM/DD", "shares": number, "price": number (raw price without fee)}] 2. Calculate TOTAL shares. 3. Calculate Weighted Average Cost PER SHARE. IMPORTANT: For each transaction, Cost = Price * (1 + ${fee}/100). Final Avg Cost = (Sum of (Shares * Cost)) / Total Shares. Return JSON: {"transactions": [...], "totalShares": number, "avgCost": number}`;
            progressBar.style.width = '80%';
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${settings.geminiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...images] }] }) });
            progressBar.style.width = '90%';
            status.innerText = `處理結果中...`; status.style.color = "#0a84ff";
            const data = await resp.json(); if(data.error) throw new Error(data.error.message);
            const txt = data.candidates[0].content.parts[0].text; const match = txt.match(/\{[\s\S]*\}/);
            if(match) {
                const res = JSON.parse(match[0]);
                if(res.transactions && res.transactions.length > 0) {
                    // 累積到現有交易明細
                    const existingTx = window.tempTransactions || [];
                    const newTx = res.transactions || [];
                    const allTx = [...existingTx, ...newTx];
                    
                    // 重新計算總股數和加權平均成本
                    let totalShares = 0;
                    let totalCost = 0;
                    allTx.forEach(tx => {
                        const shares = parseFloat(tx.shares) || 0;
                        const price = parseFloat(tx.price) || 0;
                        const costPerShare = price * (1 + fee / 100);
                        totalShares += shares;
                        totalCost += shares * costPerShare;
                    });
                    const avgCost = totalShares > 0 ? totalCost / totalShares : 0;
                    
                    // 更新顯示
                    window.tempTransactions = allTx;
                    document.getElementById('inpBalance').value = totalShares;
                    document.getElementById('inpCost').value = avgCost.toFixed(4);
                    renderTransactions(window.tempTransactions);
                    progressBar.style.width = '100%';
                    status.innerText = `成功! 已累積 ${allTx.length} 筆交易，總股數: ${totalShares}，已含 ${fee}% 手續費`; status.style.color = "#30d158"; 
                    setTimeout(() => { progressContainer.style.display = 'none'; progressBar.style.width = '0%'; }, 1000);
                    switchTab('detail');
                } else { throw new Error("No data"); }
            }
        } catch(e) { 
            console.error(e); 
            status.innerText = "失敗: " + e.message; 
            status.style.color = "red"; 
            progressContainer.style.display = 'none'; 
            progressBar.style.width = '0%'; 
        } 
        input.value = '';
    }
    function renderTransactions(list) { const c = document.getElementById('txListContainer'); c.innerHTML = ''; if(!list || list.length === 0) { c.innerHTML = '<div class="tx-no-data">無明細</div>'; return; } list.forEach(tx => { c.innerHTML += `<div class="tx-item"><div class="tx-header-row"><div><span class="tx-badge">整股</span> <span class="tx-date">${tx.date}</span></div></div><div class="tx-row"><span class="tx-label">股數</span><span class="tx-val">${tx.shares}</span></div><div class="tx-row"><span class="tx-label">成交價</span><span class="tx-val">$${tx.price}</span></div></div>`; }); }

    // Async Updates
    async function refreshAllData() { const icon=document.getElementById('refreshIcon'); icon.classList.add('fa-spin-fast'); await updateRates(); if(settings.apiKey)await fetchPrices(); if(chartLevel==='root')updateChartData(); setTimeout(()=>{icon.classList.remove('fa-spin-fast');},500); }
    async function updateRates() { try{const r=await fetch('https://api.exchangerate-api.com/v4/latest/USD');const d=await r.json();if(d.rates?.TWD)settings.usdRate=d.rates.TWD;}catch(e){} if(settings.apiKey){try{const r=await fetch(`https://finnhub.io/api/v1/quote?symbol=COINBASE:USDT-USD&token=${settings.apiKey}`);const j=await r.json();if(j.c)settings.usdtRate=j.c;}catch(e){}} localStorage.setItem(STORAGE_KEY_SETTINGS,JSON.stringify(settings)); document.getElementById('rateUsd').innerText=`USD ≈ ${settings.usdRate.toFixed(2)}`; document.getElementById('rateUsdt').innerText=`USDT ≈ ${settings.usdtRate.toFixed(3)} USD`; renderAssets(); }
    async function fetchPrices() { if(!settings.apiKey)return; const autos=accounts.filter(a=>a.isAuto&&a.symbol); for(let acc of autos){ try{ let sym=acc.symbol; if(acc.type==='crypto'){ if(acc.symbol==='USDT'||acc.symbol==='USDC'){acc.currentPrice=1;acc.dayChange=0;acc.dayChangePercent=0;continue;} if(!sym.includes(':'))sym=`COINBASE:${sym}-USD`; } await new Promise(r=>setTimeout(r,150)); const res=await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${settings.apiKey}`); const j=await res.json(); if(j.c){ acc.currentPrice=j.c; acc.dayChange=j.d||0; acc.dayChangePercent=j.dp||0; } }catch(e){} } saveData(); renderAssets(); }
    function renderAssets() { const c=document.getElementById('assetsContainer'); c.innerHTML=''; sortables.forEach(s=>s.destroy()); sortables=[]; const groups=[{key:'bank',t:'銀行 / 現金',i:'fa-university',s:'icon-bank'},{key:'stock',t:'投資理財 (美股)',i:'fa-chart-line',s:'icon-stock'},{key:'crypto',t:'加密貨幣 (USD)',i:'fa-bitcoin',s:'icon-crypto'},{key:'debt',t:'負債',i:'fa-hand-holding-usd',s:'icon-debt'}]; let net=0; let totalDailyPnL=0; groups.forEach(g=>{ let items=accounts.filter(a=>a.type===g.key).sort((a,b)=>(a.order||0)-(b.order||0)); if(items.length===0)return; let sum=0; let groupPnL=0; let html=''; items.forEach(acc=>{ let val=calculateTWD(acc); let pnl=calculatePnL_TWD(acc); if(g.key==='debt')net-=val; else net+=val; sum+=val; groupPnL+=pnl; totalDailyPnL+=pnl; let htmlContent=''; if(acc.isAuto){ let sym=acc.symbol.replace('COINBASE:','').replace('OKEX:','').replace('-USD','').replace('-USDT',''); let price=acc.currentPrice?`$${acc.currentPrice.toLocaleString()} USD`:'--'; let chg=''; if(acc.dayChangePercent){ let s=acc.dayChangePercent>0?'+':''; let c=acc.dayChangePercent>0?'sub-green':'sub-red'; chg=`<span class="${c}">${s}${acc.dayChangePercent.toFixed(2)}%</span>`; } let line1=chg || '--'; if(!acc.dayChangePercent) chg='--'; let line2=`${price} • ${acc.balance}`; let line3=''; if(acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0){ let pnlPct=((acc.currentPrice - acc.cost) / acc.cost) * 100; let s=pnlPct>=0?'+':''; let c=pnlPct>=0?'sub-green':'sub-red'; line3=`成本 $${acc.cost.toFixed(2)} <span class="${c}">${s}${pnlPct.toFixed(2)}%</span>`; } htmlContent=`<div class="item-name">${acc.name}</div><div class="item-row">${line1}</div><div class="item-row">${line2}</div>${line3?`<div class="item-row">${line3}</div>`:''}`; } else { htmlContent=`<div class="item-name">${acc.name}</div><div class="item-row">${acc.currency}</div>`; } let color=g.key==='debt'?'amount-red':'amount-green'; let hdl=isEditMode?`<div class="drag-handle"><i class="fas fa-bars"></i></div>`:''; let clk=isEditMode?`onclick="openDetailView(${acc.id})"`:`onclick="openDetailView(${acc.id})"`; let dailyPnL=acc.isAuto?calculateDailyPnL_TWD(acc):0; let costPnL=acc.isAuto?calculateCostPnL_TWD(acc):0; let pnlHtml=''; if(acc.isAuto){ let hasLine3=(acc.cost && acc.cost > 0 && acc.currentPrice && acc.currentPrice > 0); if(Math.abs(dailyPnL)>0.01){ pnlHtml+=`<div class="amount-pnl" style="font-size:11px;">當天 ${formatPnL(dailyPnL)}</div>`; } else { pnlHtml+=`<div class="amount-spacer"></div>`; } pnlHtml+=`<div class="amount-spacer"></div>`; if(hasLine3){ if(Math.abs(costPnL)>0.01){ pnlHtml+=`<div class="amount-pnl">成本 ${formatPnL(costPnL)}</div>`; } else { pnlHtml+=`<div class="amount-spacer"></div>`; } } } else { pnlHtml=`<div class="amount-spacer"></div>`; if(pnl!==0){ pnlHtml+=`<div class="amount-pnl">${formatPnL(pnl)}</div>`; } else { pnlHtml+='<div class="item-sub">TWD</div>'; } } html+=`<div class="list-item" ${clk} data-id="${acc.id}"><div class="item-icon ${g.s}"><i class="fas ${g.i}"></i></div><div class="item-content">${htmlContent}</div><div class="item-amount"><div class="amount-val ${color}">${Math.round(val).toLocaleString()}</div>${pnlHtml}</div>${hdl}</div>`; }); let pHtml=groupPnL!==0?`<span class="group-pnl">${formatPnL(groupPnL)}</span>`:''; let cid=`group-${g.key}`; c.innerHTML+=`<div class="group-header"><span>${g.t}</span><div class="group-total-block"><span class="group-total">${Math.round(sum).toLocaleString()}</span>${pHtml}</div></div><div class="list-container" id="${cid}">${html}</div>`; }); if(isEditMode){ groups.forEach(g=>{ let el=document.getElementById(`group-${g.key}`); if(el)sortables.push(Sortable.create(el,{handle:'.drag-handle',animation:150,onEnd:function(evt){updateOrder(g.key,evt.from);}})); }); document.querySelectorAll('.drag-handle').forEach(el=>el.style.display='block'); } document.getElementById('totalNetWorth').innerText=`NT$ ${Math.round(net).toLocaleString()}`; const b=document.getElementById('totalPnLBlock'); const bd=document.getElementById('totalPnLBadge'); if(Math.abs(totalDailyPnL)>1){ b.style.display='block'; const s=totalDailyPnL>0?'+':''; const c=totalDailyPnL>0?'pnl-up':'pnl-down'; bd.innerHTML=`損益: <span class="${c}">${s}NT$ ${Math.round(totalDailyPnL).toLocaleString()} TWD</span>`; } else { b.style.display='none'; } updateChartData(); }

    // 4. Start the app only after everything is defined
    async function init() {
        renderAssets();
        setTimeout(() => { initChart(); }, 500);
        await updateRates(); 
        if(settings.apiKey) fetchPrices();
        setInterval(() => { refreshAllData(); }, 60000);
    }
    
    init();
</script>
</body>
</html>
