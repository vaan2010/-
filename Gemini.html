<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Sweet Trip üå∏</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Zen Maru Gothic -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Sortable.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        girl: { bg: '#fff0f5', card: '#ffffff', primary: '#fb7185', secondary: '#e879f9', accent: '#38bdf8', text: '#881337' }
                    },
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(180deg, #fff0f5 0%, #fff5f5 100%); color: #881337; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .nav-item.active { color: #fb7185; font-weight: bold; }
        .nav-item.active i { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .soft-shadow { box-shadow: 0 4px 15px rgba(251, 113, 133, 0.15); }
        
        .edit-input { background: #fff; border: 2px solid #fbcfe8; border-radius: 12px; padding: 6px 10px; width: 100%; color: #881337; transition: all 0.3s; font-size: 14px; }
        .edit-input:focus { outline: none; border-color: #fb7185; box-shadow: 0 0 0 3px rgba(251, 113, 133, 0.2); }
        
        .btn-gradient { background: linear-gradient(90deg, #fb7185, #e879f9); color: white; box-shadow: 0 4px 10px rgba(251, 113, 133, 0.3); }
        .btn-delete { color: #f43f5e; background: #ffe4e6; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* ÊãñÊãâÊâãÊääÊ®£Âºè - Èö®ÊôÇÂèØË¶ã */
        .drag-handle { cursor: grab; color: #fbcfe8; padding: 10px 8px; touch-action: none; display: flex; align-items: center; justify-content: center; }
        .drag-handle:active { cursor: grabbing; color: #fb7185; }
        .sortable-ghost { opacity: 0.4; background: #fff0f5; border: 2px dashed #fb7185; }
        
        /* Icon ÈÅ∏ÊìáÂô®Ê®£Âºè */
        .icon-option { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; border: 1px solid #fce7f3; color: #db2777; }
        .icon-option.selected { background: #db2777; color: white; border-color: #db2777; }
    </style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md px-6 py-4 flex justify-between items-center soft-shadow z-10 rounded-b-3xl">
        <div id="header-info" class="flex-1"></div>
        <div class="flex gap-3">
            <button onclick="addNewDay()" id="add-day-header-btn" class="hidden w-10 h-10 rounded-full bg-pink-500 text-white flex items-center justify-center shadow-sm active:scale-90 transition-transform hover:bg-pink-600">
                <i class="fas fa-plus"></i>
            </button>
            <button onclick="toggleEditMode()" id="edit-toggle-btn" class="w-10 h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center shadow-sm active:scale-90 transition-transform">
                <i class="fas fa-pen"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="flex-1 overflow-y-auto p-4 pb-28 no-scrollbar relative">
        
        <!-- PLAN SECTION -->
        <section id="view-plan" class="view-section block">
            
            <!-- Logistics -->
            <div class="mb-6 space-y-4">
                <div class="bg-white rounded-3xl p-5 soft-shadow relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-pink-400"><i class="fas fa-plane mr-1"></i> Ëà™Áè≠Ë≥áË®ä</h3>
                        <button id="add-flight-btn" onclick="addFlight()" class="hidden text-xs bg-pink-100 text-pink-500 px-2 py-1 rounded-full">+ Êñ∞Â¢û</button>
                    </div>
                    <div id="flight-container" class="space-y-3"></div>
                </div>

                <div class="bg-white rounded-3xl p-5 soft-shadow relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xs font-bold text-pink-400"><i class="fas fa-bed mr-1"></i> ‰ΩèÂÆøÂÆâÊéí</h3>
                        <button id="add-hotel-btn" onclick="addHotel()" class="hidden text-xs bg-pink-100 text-pink-500 px-2 py-1 rounded-full">+ Êñ∞Â¢û</button>
                    </div>
                    <div id="hotel-container" class="space-y-3"></div>
                </div>
            </div>

            <!-- Itinerary -->
            <div id="itinerary-container" class="space-y-8 pl-1 mt-6"></div>
            
            <div id="add-day-btn" class="hidden mt-8 mb-8 text-center">
                <button onclick="addNewDay()" class="bg-white border-2 border-dashed border-pink-300 text-pink-400 px-6 py-3 rounded-2xl font-bold w-full hover:bg-pink-50 transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i> Êñ∞Â¢û‰∏ÄÂ§© (Day)
                </button>
            </div>
        </section>

        <!-- GUIDE SECTION -->
        <section id="view-guide" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6 text-pink-600"><i class="fas fa-star mr-2 text-yellow-400"></i>Ê∑±Â∫¶Â∞éË¶Ω</h2>
            <div id="guide-container"></div>
            <div id="add-guide-btn" class="hidden mb-8">
                <button onclick="addNewGuide()" class="bg-white border-2 border-dashed border-pink-300 text-pink-400 px-6 py-3 rounded-2xl font-bold w-full">+ Êñ∞Â¢ûÂ∞éË¶ΩÊñáÁ´†</button>
            </div>
        </section>

        <!-- WALLET SECTION -->
        <section id="view-wallet" class="view-section hidden">
            <div class="btn-gradient rounded-3xl p-6 mb-6 text-white relative overflow-hidden">
                <div class="absolute -right-4 -top-4 bg-white/20 w-24 h-24 rounded-full blur-xl"></div>
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <span class="text-xs font-bold opacity-80">ESTIMATED (TWD)</span>
                    <div class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full">
                        <span class="text-xs">ÂåØÁéá</span>
                        <input type="number" id="exchange-rate" value="0.22" class="w-10 bg-transparent text-white text-xs text-center font-bold focus:outline-none" onchange="updateWalletUI()">
                    </div>
                </div>
                <div class="text-4xl font-bold mb-1 relative z-10">NT$ <span id="total-twd">0</span></div>
                <div class="text-sm opacity-90 relative z-10">¬• <span id="total-jpy">0</span> JPY</div>
            </div>

            <div class="bg-white rounded-3xl p-5 soft-shadow mb-6">
                <h3 class="text-sm font-bold text-pink-500 mb-3">‚ú® Êñ∞Â¢ûÊ∂àË≤ª</h3>
                <div class="space-y-3">
                    <input type="text" id="expense-desc" placeholder="Ë≤∑‰∫Ü‰ªÄÈ∫ºÂë¢Ôºü" class="edit-input text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="expense-math" placeholder="ÈáëÈ°ç" class="edit-input text-sm flex-1 font-mono">
                        <button onclick="calculateInput()" class="text-pink-400 bg-pink-50 w-10 rounded-xl"><i class="fas fa-calculator"></i></button>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <label class="flex items-center gap-2 text-xs text-pink-500 bg-pink-50 px-4 py-2 rounded-full cursor-pointer">
                            <i class="fas fa-camera"></i> ÊãçÁÖßÂ≠òË≠â
                            <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoPreview(this)">
                        </label>
                        <span id="photo-name" class="text-xs text-pink-300 truncate max-w-[100px]"></span>
                    </div>
                    <button onclick="addExpense()" class="w-full btn-gradient py-3 rounded-xl mt-2 text-sm font-bold active:scale-95 transition-transform">Ë®ò‰∏ã‰∏ÄÁ≠Ü</button>
                </div>
            </div>
            <div id="expense-list" class="space-y-3 pb-10"></div>
        </section>

        <!-- LISTS SECTION -->
        <section id="view-lists" class="view-section hidden">
            <div class="flex bg-pink-100 p-1 rounded-2xl mb-6">
                <button onclick="switchListTab('checklist')" id="tab-btn-checklist" class="flex-1 py-2 text-xs font-bold rounded-xl bg-white shadow-sm text-pink-600">Ë°åÂâçÊ∫ñÂÇô</button>
                <button onclick="switchListTab('memo')" id="tab-btn-memo" class="flex-1 py-2 text-xs font-bold rounded-xl text-pink-400">ÂÇôÂøòÈåÑ</button>
            </div>
            <div id="content-checklist">
                <div id="checklist-container" class="space-y-2"></div>
                <div class="mt-4 flex gap-2">
                    <input type="text" id="new-check-item" placeholder="ÈÇÑÊúâ‰ªÄÈ∫ºË¶ÅÂ∏∂Ôºü (Enter Êñ∞Â¢û)" class="edit-input text-sm flex-1" onkeydown="if(event.key==='Enter') addCheckItem()">
                    <button onclick="addCheckItem()" class="text-pink-500 px-2 bg-white rounded-full w-10 h-10 shadow-sm"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div id="content-memo" class="hidden">
                <textarea id="memo-area" class="w-full h-64 bg-white p-4 rounded-3xl soft-shadow text-sm leading-relaxed resize-none focus:outline-none text-pink-800" placeholder="Èö®ÊâãË®ò‰∏ãÂèØÊÑõÁöÑ‰∫ãÁâ©..."></textarea>
                <div id="memo-links-preview" class="mt-4 flex flex-wrap gap-2"></div>
            </div>
        </section>

        <!-- INFO SECTION -->
        <section id="view-info" class="view-section hidden">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-sky-50 p-4 rounded-3xl flex flex-col items-center justify-center text-sky-600 h-32 border border-sky-100">
                    <i class="fas fa-cloud-sun text-3xl mb-2"></i><span class="text-sm font-bold">Â§©Ê∞£È†êÂ†±</span>
                </a>
                <div class="bg-rose-50 p-4 rounded-3xl flex flex-col items-center justify-center text-rose-600 h-32 border border-rose-100">
                    <i class="fas fa-heart-pulse text-3xl mb-2"></i><span class="text-sm font-bold">Á∑äÊÄ• 119</span>
                </div>
            </div>
            
            <div class="bg-slate-800 text-slate-200 rounded-3xl p-5 soft-shadow mt-6 mb-6">
                <h3 class="text-sm font-bold mb-3 text-white"><i class="fas fa-sync-alt mr-2"></i>Ë≥áÊñôÂÇô‰ªΩ</h3>
                <div class="flex gap-2 mb-3">
                    <button onclick="exportData()" class="flex-1 bg-slate-600 py-2 rounded-lg text-xs font-bold">Áî¢Áîü‰ª£Á¢º</button>
                    <button onclick="importData()" class="flex-1 bg-slate-100 text-slate-800 py-2 rounded-lg text-xs font-bold">ËÆÄÂèñË¶ÜËìã</button>
                </div>
                <textarea id="data-area" class="w-full h-24 bg-slate-900 border border-slate-700 rounded-lg p-2 text-[10px] text-slate-300 font-mono break-all" placeholder="Âú®Ê≠§Ë≤º‰∏ä‰ª£Á¢º..."></textarea>
                <button onclick="copyToClipboard()" id="copy-btn" class="w-full mt-2 border border-slate-600 text-slate-400 py-1 rounded-lg text-xs hidden">Ë§áË£Ω‰ª£Á¢º</button>
            </div>
            
            <div class="text-center mt-8">
                <button onclick="resetData()" class="text-xs text-gray-300 underline">ÈáçÁΩÆÊâÄÊúâË≥áÊñô (Debug)</button>
            </div>
        </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t border-pink-100 pb-safe pt-2 px-4 z-50 h-[70px] rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <div class="grid grid-cols-5 h-full">
            <button onclick="switchTab('plan')" class="nav-item active flex flex-col items-center"><i class="fas fa-calendar-heart text-xl mb-1"></i><span class="text-[10px]">Ë°åÁ®ã</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex flex-col items-center text-pink-300"><i class="fas fa-book-open text-xl mb-1"></i><span class="text-[10px]">Â∞éË¶Ω</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex flex-col items-center text-pink-300"><div class="btn-gradient w-12 h-12 rounded-full flex items-center justify-center -mt-6 shadow-lg border-4 border-white"><i class="fas fa-wallet text-white text-lg"></i></div></button>
            <button onclick="switchTab('lists')" class="nav-item flex flex-col items-center text-pink-300"><i class="fas fa-clipboard-check text-xl mb-1"></i><span class="text-[10px]">Ê∏ÖÂñÆ</span></button>
            <button onclick="switchTab('info')" class="nav-item flex flex-col items-center text-pink-300"><i class="fas fa-info-circle text-xl mb-1"></i><span class="text-[10px]">Ë≥áË®ä</span></button>
        </div>
    </nav>

    <script>
        // --- ICONS LIST ---
        const ICON_OPTIONS = [
            'fa-heart', 'fa-star', 'fa-plane', 'fa-train', 'fa-bus', 'fa-walking', 
            'fa-utensils', 'fa-coffee', 'fa-shopping-bag', 'fa-camera', 'fa-landmark', 
            'fa-map-marker-alt', 'fa-ticket-alt', 'fa-music', 'fa-spa', 'fa-tree'
        ];

        // --- DEFAULT DATA ---
        const defaultData = {
            meta: { title: "TOKYO TRIP", startDate: "2025-04-01", endDate: "2025-04-06" },
            flights: [
                { type: "ÂéªÁ®ã", code: "JL096", time: "10:00", note: "T2 Âá∫Áôº" },
                { type: "ÂõûÁ®ã", code: "JL099", time: "18:00", note: "T3 Â†±Âà∞" }
            ],
            hotels: [
                { name: "Muji Hotel Ginza", dates: "4/1 - 4/3", address: "ÈäÄÂ∫ß 3-3-5", link: "https://maps.google.com/?q=Muji+Hotel+Ginza" }
            ],
            itinerary: [
                { 
                    day: "Day 1", title: "ÊäµÈÅîËàáÈäÄÂ∫ß", 
                    events: [
                        { startTime: "14:00", endTime: "15:30", title: "ÊàêÁî∞Ê©üÂ†¥ÊäµÈÅî", links: [], images: [], desc: "È†òÂèñ JR Pass", highlight: false },
                        { startTime: "18:30", endTime: "20:00", title: "ÊôöÈ§êÈ†êÁ¥Ñ", links: ["https://google.com"], images: [], desc: "ÁáíËÇâ Toraji", highlight: true }
                    ]
                }
            ],
            guides: [
                { title: "Ê∑∫ËçâÂØ∫ÁöÑÁßòÂØÜ", content: "Ê∑∫ËçâÂØ∫ÊòØÊù±‰∫¨ÈÉΩÂÖßÊúÄÂè§ËÄÅÁöÑÂØ∫Âªü...", icon: "fa-torii-gate", images: [], links: [] }
            ]
        };

        // --- INIT ---
        let appData;
        try {
            const saved = JSON.parse(localStorage.getItem('travel_data'));
            appData = saved || defaultData;
            // Migration check
            if(!Array.isArray(appData.hotels)) appData.hotels = [appData.hotels || defaultData.hotels[0]];
            if(!Array.isArray(appData.flights)) appData.flights = defaultData.flights;
            // ÈÅ∑ÁßªËàäÁöÑlinkÊ†ºÂºèÂà∞linksÊï∏ÁµÑ
            if (appData.itinerary) {
                appData.itinerary.forEach(day => {
                    if (day.events) {
                        day.events.forEach(evt => {
                            if (evt.link && !evt.links) {
                                evt.links = [evt.link];
                                delete evt.link;
                            }
                            if (!evt.links) evt.links = [];
                            if (!evt.images) evt.images = [];
                        });
                    }
                });
            }
            // ÈÅ∑ÁßªÂ∞éË¶ΩÊï∏Êìö
            if (appData.guides) {
                appData.guides.forEach(guide => {
                    if (!guide.links) guide.links = [];
                    if (!guide.images) guide.images = [];
                    if (!guide.icon) guide.icon = 'fa-heart';
                });
            }
            save(); // ‰øùÂ≠òÈÅ∑ÁßªÂæåÁöÑÊï∏Êìö
        } catch (e) {
            appData = defaultData;
        }

        let isEditMode = false;
        let expandedDays = new Set(); // ËøΩËπ§Â±ïÈñãÁöÑË°åÁ®ã

        // --- RENDER ---
        function renderAll() {
            renderHeader();
            renderLogistics();
            renderPlan();
            renderGuide();
            // ÁÑ°Ë´ñÊòØÂê¶Á∑®ËºØÊ®°ÂºèÈÉΩË¶ÅÂàùÂßãÂåñÊãñÁßª
            setTimeout(initSortables, 100);
        }

        function renderHeader() {
            const container = document.getElementById('header-info');
            if (isEditMode) {
                container.innerHTML = `
                    <input oninput="updateMeta('title', this.value)" value="${appData.meta.title}" class="edit-input font-bold text-xl mb-2 text-center">
                    <div class="flex gap-2 items-center">
                        <input type="date" onchange="updateMeta('startDate', this.value)" value="${appData.meta.startDate}" class="edit-input text-xs w-1/2 text-center">
                        <span class="text-pink-300">to</span>
                        <input type="date" onchange="updateMeta('endDate', this.value)" value="${appData.meta.endDate}" class="edit-input text-xs w-1/2 text-center">
                    </div>`;
            } else {
                let start = appData.meta.startDate ? appData.meta.startDate.replace(/-/g, '.') : 'TBD';
                let end = appData.meta.endDate ? appData.meta.endDate.substring(5).replace(/-/g, '.') : 'TBD';
                container.innerHTML = `
                    <h1 class="text-2xl font-bold tracking-wide text-pink-600 mb-1">${appData.meta.title}</h1>
                    <div class="flex items-center gap-2 text-sm text-pink-400"><i class="far fa-calendar-alt"></i> ${start} - ${end}</div>`;
            }
        }

        function renderLogistics() {
            const fContainer = document.getElementById('flight-container');
            fContainer.innerHTML = '';
            appData.flights.forEach((f, i) => {
                if(isEditMode) {
                    fContainer.innerHTML += `
                        <div class="bg-pink-50 p-2 rounded-xl border border-pink-100 relative">
                            <button onclick="deleteFlight(${i})" class="absolute top-1 right-1 text-red-400"><i class="fas fa-times"></i></button>
                            <div class="flex gap-2 mb-1"><input value="${f.type}" oninput="updateFlight(${i}, 'type', this.value)" class="edit-input w-16 text-center text-xs"><input value="${f.code}" oninput="updateFlight(${i}, 'code', this.value)" class="edit-input flex-1 text-xs font-bold"></div>
                            <div class="flex gap-2"><input value="${f.time}" oninput="updateFlight(${i}, 'time', this.value)" class="edit-input w-16 text-center text-xs"><input value="${f.note}" oninput="updateFlight(${i}, 'note', this.value)" class="edit-input flex-1 text-xs"></div>
                        </div>`;
                } else {
                    fContainer.innerHTML += `
                        <div class="flex justify-between items-center border-b border-pink-50 last:border-0 pb-1 last:pb-0">
                            <div class="flex items-center gap-2"><span class="text-xs bg-pink-100 text-pink-500 px-2 py-0.5 rounded">${f.type}</span><span class="font-bold text-pink-800">${f.code}</span></div>
                            <div class="text-right"><div class="text-sm font-bold text-pink-600">${f.time}</div><div class="text-[10px] text-gray-400">${f.note}</div></div>
                        </div>`;
                }
            });

            const hContainer = document.getElementById('hotel-container');
            hContainer.innerHTML = '';
            appData.hotels.forEach((h, i) => {
                if(isEditMode) {
                    hContainer.innerHTML += `
                        <div class="bg-pink-50 p-2 rounded-xl border border-pink-100 relative">
                            <button onclick="deleteHotel(${i})" class="absolute top-1 right-1 text-red-400"><i class="fas fa-times"></i></button>
                            <input value="${h.name}" oninput="updateHotel(${i}, 'name', this.value)" class="edit-input mb-1 font-bold" placeholder="È£ØÂ∫óÂêçÁ®±">
                            <div class="flex gap-2 mb-1"><input value="${h.dates}" oninput="updateHotel(${i}, 'dates', this.value)" class="edit-input w-1/3 text-xs" placeholder="Êó•Êúü"><input value="${h.address}" oninput="updateHotel(${i}, 'address', this.value)" class="edit-input flex-1 text-xs" placeholder="Âú∞ÂùÄ"></div>
                            <input value="${h.link}" oninput="updateHotel(${i}, 'link', this.value)" class="edit-input text-xs text-blue-400" placeholder="Âú∞ÂúñÈÄ£Áµê">
                        </div>`;
                } else {
                    hContainer.innerHTML += `
                        <div class="flex justify-between items-start border-b border-pink-50 last:border-0 pb-2 last:pb-0">
                            <div><h4 class="font-bold text-pink-800 text-sm">${h.name}</h4><p class="text-xs text-pink-400 mt-0.5"><span class="bg-pink-50 px-1 rounded mr-1">${h.dates}</span> <i class="fas fa-map-marker-alt"></i> ${h.address}</p></div>
                            ${h.link ? `<a href="${formatUrl(h.link)}" target="_blank" class="text-pink-300 hover:text-pink-500"><i class="fas fa-location-arrow"></i></a>` : ''}
                        </div>`;
                }
            });
        }

        function toggleDayExpand(dIndex) {
            if (expandedDays.has(dIndex)) {
                expandedDays.delete(dIndex);
            } else {
                expandedDays.add(dIndex);
            }
            renderPlan();
        }

        function renderPlan() {
            const planDiv = document.getElementById('itinerary-container');
            planDiv.innerHTML = '';
            
            appData.itinerary.forEach((day, dIndex) => {
                const isExpanded = expandedDays.has(dIndex);
                const eventCount = day.events ? day.events.length : 0;
                
                const dayCard = document.createElement('div');
                dayCard.className = "mb-4";
                
                if (isEditMode) {
                    dayCard.innerHTML = `
                        <div class="bg-white rounded-2xl p-4 soft-shadow">
                            <div class="flex items-center gap-2 mb-4">
                                <button onclick="deleteDay(${dIndex})" class="btn-delete"><i class="fas fa-times"></i></button>
                                <input oninput="updateDay(${dIndex}, 'day', this.value)" value="${day.day}" class="edit-input w-24 font-bold text-center">
                                <input oninput="updateDay(${dIndex}, 'title', this.value)" value="${day.title}" class="edit-input flex-1 font-bold">
                            </div>
                            <div id="day-events-${dIndex}" class="space-y-4"></div>
                            <div onclick="addEvent(${dIndex})" class="text-center py-2 mt-4 border-2 border-dashed border-pink-200 rounded-xl text-pink-300 text-xs cursor-pointer hover:bg-pink-50">
                                <i class="fas fa-plus mr-1"></i> Êñ∞Â¢ûË°åÁ®ã
                            </div>
                        </div>`;
                } else {
                    // Âç°ÁâáÂºèÈ°ØÁ§∫
                    dayCard.innerHTML = `
                        <div class="bg-white rounded-2xl p-4 soft-shadow cursor-pointer hover:shadow-lg transition-all" onclick="event.stopPropagation(); toggleDayExpand(${dIndex})">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="font-bold text-xl text-pink-800 mb-1">${day.day}</h3>
                                    <p class="text-sm text-pink-400 mb-2">${day.title}</p>
                                    <div class="flex items-center gap-2 text-xs text-pink-300">
                                        <i class="fas fa-calendar-check"></i>
                                        <span>${eventCount} ÂÄãË°åÁ®ã</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'} text-pink-300"></i>
                                </div>
                            </div>
                        </div>
                        <div id="day-events-${dIndex}" class="${isExpanded ? 'block' : 'hidden'} mt-4 space-y-4"></div>`;
                }

                const eventsList = document.getElementById(`day-events-${dIndex}`);
                if (!eventsList) {
                    const tempDiv = document.createElement('div');
                    dayCard.appendChild(tempDiv);
                    planDiv.appendChild(dayCard);
                    return;
                }
                
                eventsList.className = isEditMode ? "sortable-events space-y-4" : "sortable-events space-y-4";
                eventsList.dataset.dayIndex = dIndex;

                day.events.forEach((evt, eIndex) => {
                    // Á¢∫‰øùÊï∏ÊìöÁµêÊßãÂÖºÂÆπ
                    if (!evt.links) evt.links = evt.link ? [evt.link] : [];
                    if (!evt.images) evt.images = [];
                    
                    const evtDiv = document.createElement('div');
                    evtDiv.className = "mb-4 group relative";
                    
                    if (isEditMode) {
                        let linksHTML = '';
                        (evt.links || []).forEach((link, lIdx) => {
                            linksHTML += `<div class="flex gap-2 items-center mb-1">
                                <input oninput="updateEventLink(${dIndex}, ${eIndex}, ${lIdx}, this.value)" value="${link}" class="edit-input text-xs text-blue-400 flex-1" placeholder="ÈÄ£Áµê URL">
                                <button onclick="deleteEventLink(${dIndex}, ${eIndex}, ${lIdx})" class="text-red-300"><i class="fas fa-times"></i></button>
                            </div>`;
                        });
                        
                        let imagesHTML = '';
                        (evt.images || []).forEach((img, imgIdx) => {
                            imagesHTML += `<div class="relative inline-block mr-2 mb-2">
                                <img src="${img}" class="w-20 h-20 object-cover rounded-lg border border-pink-200">
                                <button onclick="deleteEventImage(${dIndex}, ${eIndex}, ${imgIdx})" class="absolute -top-1 -right-1 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fas fa-times"></i></button>
                            </div>`;
                        });
                        
                        evtDiv.innerHTML = `
                            <div class="bg-white p-3 rounded-2xl border border-pink-100 shadow-sm flex gap-2 items-start">
                                <div class="drag-handle mt-2"><i class="fas fa-grip-vertical"></i></div>
                                <div class="flex-1 space-y-2">
                                    <div class="flex gap-2">
                                        <input oninput="updateEvent(${dIndex}, ${eIndex}, 'startTime', this.value)" value="${evt.startTime || ''}" class="edit-input w-16 text-xs text-center" placeholder="ÈñãÂßã">
                                        <span class="text-gray-300 self-center">-</span>
                                        <input oninput="updateEvent(${dIndex}, ${eIndex}, 'endTime', this.value)" value="${evt.endTime || ''}" class="edit-input w-16 text-xs text-center" placeholder="ÁµêÊùü">
                                        <div class="flex-1 flex justify-end items-center gap-2">
                                            <label class="cursor-pointer text-yellow-400 text-lg"><input type="checkbox" ${evt.highlight ? 'checked' : ''} onchange="updateEvent(${dIndex}, ${eIndex}, 'highlight', this.checked)" class="hidden peer"><i class="far fa-star peer-checked:fas peer-checked:text-yellow-400 text-gray-200"></i></label>
                                            <button onclick="deleteEvent(${dIndex}, ${eIndex})" class="text-red-300"><i class="fas fa-trash-alt"></i></button>
                                        </div>
                                    </div>
                                    <input oninput="updateEvent(${dIndex}, ${eIndex}, 'title', this.value)" value="${evt.title || ''}" class="edit-input font-bold" placeholder="Ê®ôÈ°å" id="evt-title-${dIndex}-${eIndex}">
                                    <div class="space-y-1">
                                        <div class="text-xs text-pink-400 font-bold mb-1">ÈÄ£ÁµêÔºö</div>
                                        ${linksHTML}
                                        <button onclick="addEventLink(${dIndex}, ${eIndex})" class="text-xs text-pink-400 bg-pink-50 px-2 py-1 rounded-full"><i class="fas fa-plus mr-1"></i> Êñ∞Â¢ûÈÄ£Áµê</button>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="text-xs text-pink-400 font-bold mb-1">ÂúñÁâáÔºö</div>
                                        <div class="flex flex-wrap gap-2">
                                            ${imagesHTML}
                                            <label class="w-20 h-20 border-2 border-dashed border-pink-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-pink-50">
                                                <i class="fas fa-camera text-pink-300"></i>
                                                <input type="file" accept="image/*" multiple class="hidden" onchange="handleEventImages(event, ${dIndex}, ${eIndex})">
                                            </label>
                                        </div>
                                    </div>
                                    <input oninput="updateEvent(${dIndex}, ${eIndex}, 'desc', this.value)" value="${evt.desc || ''}" class="edit-input text-xs text-gray-500" placeholder="ÂÇôË®ª... (Enter Êñ∞Â¢û)" onkeydown="handleEnterKey(event, ${dIndex}, ${eIndex})" id="evt-desc-${dIndex}-${eIndex}">
                                </div>
                            </div>`;
                    } else {
                        const highlightClass = evt.highlight ? 'border-l-4 border-yellow-400 bg-yellow-50/50' : 'bg-white';
                        const icon = evt.highlight ? '<i class="fas fa-star text-yellow-400 mr-2"></i>' : '';
                        const timeDisplay = evt.endTime ? `${evt.startTime} - ${evt.endTime}` : evt.startTime;
                        
                        // ÂúñÁâáÂçÄÂüü - Â¶ÇÊûúÊúâÂúñÁâáÔºåÈ°ØÁ§∫Âú®Á¨¨‰∏ÄÂºµ
                        let imageSection = '';
                        if (evt.images && evt.images.length > 0) {
                            imageSection = `<div class="w-full h-48 mb-3 rounded-xl overflow-hidden">
                                <img src="${evt.images[0]}" onclick="viewImage('${evt.images[0]}')" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform">
                            </div>`;
                            // Â¶ÇÊûúÊúâÂ§öÂºµÂúñÁâáÔºåÈ°ØÁ§∫Á∏ÆÂúñ
                            if (evt.images.length > 1) {
                                let thumbnails = '';
                                evt.images.slice(1, 4).forEach((img, idx) => {
                                    thumbnails += `<img src="${img}" onclick="viewImage('${img}')" class="w-16 h-16 object-cover rounded-lg border border-pink-200 cursor-pointer hover:scale-110 transition-transform">`;
                                });
                                if (evt.images.length > 4) {
                                    thumbnails += `<div class="w-16 h-16 bg-pink-100 rounded-lg border border-pink-200 flex items-center justify-center text-xs text-pink-400 font-bold">+${evt.images.length - 4}</div>`;
                                }
                                imageSection += `<div class="flex gap-2 mb-3">${thumbnails}</div>`;
                            }
                        }
                        
                        // ÈÄ£ÁµêÂçÄÂüü - ÂûÇÁõ¥ÊéíÂàó
                        let linksHTML = '';
                        if (evt.links && evt.links.length > 0) {
                            linksHTML = '<div class="space-y-2 mb-3">';
                            evt.links.forEach(link => {
                                const isXHS = isXiaohongshuUrl(link);
                                if (isXHS) {
                                    linksHTML += `<a href="${formatUrl(link)}" target="_blank" rel="noopener noreferrer" class="block w-full bg-red-50 border border-red-200 rounded-lg px-4 py-3 hover:bg-red-100 transition-colors">
                                        <div class="flex items-center gap-2">
                                            <img src="https://sns-img-qc.xhscdn.com/static/img/logo-red.png" class="w-5 h-5" onerror="this.style.display='none'">
                                            <span class="text-sm text-red-600 font-medium flex-1">Â∞èÁ¥ÖÊõ∏ÈÄ£Áµê</span>
                                            <i class="fas fa-external-link-alt text-xs text-red-400"></i>
                                        </div>
                                    </a>`;
                                } else {
                                    const domain = link.replace(/^https?:\/\//, '').split('/')[0];
                                    linksHTML += `<a href="${formatUrl(link)}" target="_blank" rel="noopener noreferrer" class="block w-full bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 hover:bg-blue-100 transition-colors">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-link text-blue-500"></i>
                                            <span class="text-sm text-blue-600 font-medium flex-1 truncate">${domain}</span>
                                            <i class="fas fa-external-link-alt text-xs text-blue-400"></i>
                                        </div>
                                    </a>`;
                                }
                            });
                            linksHTML += '</div>';
                        }
                        
                        evtDiv.innerHTML = `
                            <div class="mb-4">
                                <div class="flex items-start gap-3">
                                    <div class="drag-handle pt-2 opacity-30 hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing">
                                        <i class="fas fa-grip-vertical text-pink-300"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-xs font-bold text-pink-400 mb-2">${timeDisplay}</div>
                                        <div class="${highlightClass} rounded-2xl p-4 soft-shadow transition-all hover:shadow-lg">
                                            ${imageSection}
                                            <div class="flex items-center mb-2">
                                                <h3 class="font-bold text-pink-900 text-lg flex-1 flex items-center gap-2">${icon}${evt.title || ''}</h3>
                                            </div>
                                            ${evt.desc ? `<p class="text-sm text-pink-600 mb-3 leading-relaxed">${evt.desc}</p>` : ''}
                                            ${linksHTML}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    }
                    eventsList.appendChild(evtDiv);
                });
            });
        }

        function renderGuide() {
            const container = document.getElementById('guide-container');
            container.innerHTML = '';
            appData.guides.forEach((guide, index) => {
                // Á¢∫‰øùÊï∏ÊìöÁµêÊßãÂÖºÂÆπ
                if (!guide.images) guide.images = [];
                if (!guide.links) guide.links = [];
                
                const div = document.createElement('article');
                div.className = "bg-white rounded-3xl overflow-hidden soft-shadow mb-6";
                if (isEditMode) {
                    // Render Icon Selector (Á∏ÆÂ∞èÊîæÂú®Âè≥‰∏äËßí)
                    let iconSelectorHTML = `<div class="flex flex-wrap gap-1">`;
                    ICON_OPTIONS.forEach(icon => {
                        const isSelected = guide.icon === icon ? 'selected' : '';
                        iconSelectorHTML += `<div onclick="updateGuide(${index}, 'icon', '${icon}')" class="icon-option ${isSelected}" style="width:28px;height:28px;font-size:12px;"><i class="fas ${icon}"></i></div>`;
                    });
                    iconSelectorHTML += `</div>`;

                    let linksHTML = '';
                    (guide.links || []).forEach((link, lIdx) => {
                        linksHTML += `<div class="flex gap-2 items-center mb-1">
                            <input oninput="updateGuideLink(${index}, ${lIdx}, this.value)" value="${link}" class="edit-input text-xs text-blue-400 flex-1" placeholder="ÈÄ£Áµê URL">
                            <button onclick="deleteGuideLink(${index}, ${lIdx})" class="text-red-300"><i class="fas fa-times"></i></button>
                        </div>`;
                    });
                    
                    let imagesHTML = '';
                    (guide.images || []).forEach((img, imgIdx) => {
                        imagesHTML += `<div class="relative inline-block mr-2 mb-2">
                            <img src="${img}" class="w-24 h-24 object-cover rounded-lg border border-pink-200">
                            <button onclick="deleteGuideImage(${index}, ${imgIdx})" class="absolute -top-1 -right-1 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fas fa-times"></i></button>
                        </div>`;
                    });

                    div.innerHTML = `
                        <div class="p-5 bg-pink-50">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-xs font-bold text-pink-400">ÊñáÁ´† #${index + 1}</span>
                                <div class="flex items-center gap-2">
                                    <div class="text-xs text-pink-400 font-bold mr-2">ÂúñÁ§∫:</div>
                                    ${iconSelectorHTML}
                                    <button onclick="deleteGuide(${index})" class="btn-delete ml-2"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <input placeholder="Ê®ôÈ°å" oninput="updateGuide(${index}, 'title', this.value)" value="${guide.title || ''}" class="edit-input mb-3 font-bold">
                            <div class="space-y-2 mb-3">
                                <div class="text-xs text-pink-400 font-bold">ÈÄ£ÁµêÔºö</div>
                                ${linksHTML}
                                <button onclick="addGuideLink(${index})" class="text-xs text-pink-400 bg-pink-50 px-2 py-1 rounded-full"><i class="fas fa-plus mr-1"></i> Êñ∞Â¢ûÈÄ£Áµê</button>
                            </div>
                            <div class="space-y-2 mb-3">
                                <div class="text-xs text-pink-400 font-bold">ÂúñÁâáÔºö</div>
                                <div class="flex flex-wrap gap-2">
                                    ${imagesHTML}
                                    <label class="w-24 h-24 border-2 border-dashed border-pink-300 rounded-lg flex items-center justify-center cursor-pointer hover:bg-pink-50">
                                        <i class="fas fa-camera text-pink-300"></i>
                                        <input type="file" accept="image/*" multiple class="hidden" onchange="handleGuideImages(event, ${index})">
                                    </label>
                                </div>
                            </div>
                            <textarea placeholder="ÂÖßÊñá..." oninput="updateGuide(${index}, 'content', this.value)" class="edit-input h-32 text-sm leading-relaxed">${guide.content || ''}</textarea>
                        </div>`;
                } else {
                    // È°ØÁ§∫Ê®°ÂºèÔºöÂç°ÁâáÂºè‰ΩàÂ±Ä
                    // ÂúñÁâáÂçÄÂüü
                    let imageSection = '';
                    if (guide.images && guide.images.length > 0) {
                        imageSection = `<div class="w-full h-56 mb-4 rounded-xl overflow-hidden">
                            <img src="${guide.images[0]}" onclick="viewImage('${guide.images[0]}')" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform">
                        </div>`;
                        // Â¶ÇÊûúÊúâÂ§öÂºµÂúñÁâáÔºåÈ°ØÁ§∫Á∏ÆÂúñ
                        if (guide.images.length > 1) {
                            let thumbnails = '';
                            guide.images.slice(1, 5).forEach((img, idx) => {
                                thumbnails += `<img src="${img}" onclick="viewImage('${img}')" class="w-20 h-20 object-cover rounded-lg border border-pink-200 cursor-pointer hover:scale-110 transition-transform">`;
                            });
                            if (guide.images.length > 5) {
                                thumbnails += `<div class="w-20 h-20 bg-pink-100 rounded-lg border border-pink-200 flex items-center justify-center text-xs text-pink-400 font-bold">+${guide.images.length - 5}</div>`;
                            }
                            imageSection += `<div class="flex gap-2 mb-4">${thumbnails}</div>`;
                        }
                    } else {
                        // Ê≤íÊúâÂúñÁâáÊôÇÈ°ØÁ§∫ÂúñÊ®ôËÉåÊôØ
                        imageSection = `<div class="w-full h-40 bg-gradient-to-br from-pink-100 to-purple-100 rounded-xl mb-4 flex items-center justify-center">
                            <i class="fas ${guide.icon || 'fa-heart'} text-6xl text-pink-300 opacity-50"></i>
                        </div>`;
                    }
                    
                    // ÈÄ£ÁµêÂçÄÂüü - ÂûÇÁõ¥ÊéíÂàó
                    let linksHTML = '';
                    if (guide.links && guide.links.length > 0) {
                        linksHTML = '<div class="space-y-2 mb-4">';
                        guide.links.forEach(link => {
                            const isXHS = isXiaohongshuUrl(link);
                            if (isXHS) {
                                linksHTML += `<a href="${formatUrl(link)}" target="_blank" rel="noopener noreferrer" class="block w-full bg-red-50 border border-red-200 rounded-lg px-4 py-3 hover:bg-red-100 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <img src="https://sns-img-qc.xhscdn.com/static/img/logo-red.png" class="w-5 h-5" onerror="this.style.display='none'">
                                        <span class="text-sm text-red-600 font-medium flex-1">Â∞èÁ¥ÖÊõ∏ÈÄ£Áµê</span>
                                        <i class="fas fa-external-link-alt text-xs text-red-400"></i>
                                    </div>
                                </a>`;
                            } else {
                                const domain = link.replace(/^https?:\/\//, '').split('/')[0];
                                linksHTML += `<a href="${formatUrl(link)}" target="_blank" rel="noopener noreferrer" class="block w-full bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 hover:bg-blue-100 transition-colors">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-link text-blue-500"></i>
                                        <span class="text-sm text-blue-600 font-medium flex-1 truncate">${domain}</span>
                                        <i class="fas fa-external-link-alt text-xs text-blue-400"></i>
                                    </div>
                                </a>`;
                            }
                        });
                        linksHTML += '</div>';
                    }
                    
                    div.innerHTML = `
                        <div class="bg-white rounded-2xl overflow-hidden soft-shadow">
                            <div class="p-5">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fas ${guide.icon || 'fa-heart'} text-pink-400"></i>
                                    <h3 class="text-xl font-bold text-pink-900">${guide.title || ''}</h3>
                                </div>
                                ${imageSection}
                                ${linksHTML}
                                <div class="text-sm text-pink-800 leading-7 whitespace-pre-line">${guide.content || ''}</div>
                            </div>
                        </div>`;
                }
                container.appendChild(div);
            });
        }

        // --- HELPERS ---
        function formatUrl(url) {
            if (!url) return '';
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                return 'https://' + url;
            }
            return url;
        }

        function isXiaohongshuUrl(url) {
            if (!url) return false;
            return url.includes('xiaohongshu.com') || url.includes('xhslink.com') || url.includes('xhs');
        }

        function getXiaohongshuPreview(url) {
            // Â∞èÁ¥ÖÊõ∏È†êË¶ΩÂúñAPIÔºà‰ΩøÁî®Á¨¨‰∏âÊñπÊúçÂãôÊàñÁõ¥Êé•‰ΩøÁî®Â∞èÁ¥ÖÊõ∏ÁöÑOGÂúñÁâáÔºâ
            // ÈÄôË£°‰ΩøÁî®‰∏ÄÂÄãÈÄöÁî®ÁöÑÈ†êË¶ΩÊúçÂãô
            return `https://api.xiaohongshu.com/api/sns/web/v1/feed?source_note_id=${url}`;
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    let w = img.width, h = img.height;
                    if (w > maxWidth) {
                        h *= maxWidth / w;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initSortables() {
            // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÁèæÊúâÁöÑSortableÂØ¶‰æã
            document.querySelectorAll('.sortable-events').forEach(el => {
                if (el.sortableInstance) {
                    el.sortableInstance.destroy();
                }
            });
            
            // ÂàùÂßãÂåñË°åÁ®ãÊãñÁßª - ÁÑ°Ë´ñÁ∑®ËºØÊ®°ÂºèËàáÂê¶ÈÉΩÂèØ‰ª•ÊãñÁßª
            document.querySelectorAll('.sortable-events').forEach(el => {
                el.sortableInstance = new Sortable(el, {
                    group: 'itinerary-events',
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    disabled: false, // ÂßãÁµÇÂïüÁî®ÊãñÁßª
                    onEnd: function (evt) {
                        const fromDay = parseInt(evt.from.dataset.dayIndex);
                        const toDay = parseInt(evt.to.dataset.dayIndex);
                        const movedItem = appData.itinerary[fromDay].events.splice(evt.oldIndex, 1)[0];
                        appData.itinerary[toDay].events.splice(evt.newIndex, 0, movedItem);
                        save();
                        setTimeout(renderPlan, 0); 
                    }
                });
            });
            
            // ÂàùÂßãÂåñÊ∏ÖÂñÆÊãñÁßª
            const checkListEl = document.getElementById('checklist-container');
            if(checkListEl) {
                if (checkListEl.sortableInstance) {
                    checkListEl.sortableInstance.destroy();
                }
                checkListEl.sortableInstance = new Sortable(checkListEl, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function (evt) {
                        const movedItem = checklist.splice(evt.oldIndex, 1)[0];
                        checklist.splice(evt.newIndex, 0, movedItem);
                        localStorage.setItem('travel_checklist', JSON.stringify(checklist));
                    }
                });
            }
        }

        // --- LOGIC ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-toggle-btn');
            const addDayBtn = document.getElementById('add-day-btn');
            const addGuideBtn = document.getElementById('add-guide-btn');
            const addFlightBtn = document.getElementById('add-flight-btn');
            const addHotelBtn = document.getElementById('add-hotel-btn');
            const addDayHeaderBtn = document.getElementById('add-day-header-btn');
            
            if (isEditMode) {
                btn.innerHTML = '<i class="fas fa-check text-white"></i>';
                btn.className = "w-10 h-10 rounded-full btn-gradient flex items-center justify-center shadow-lg transform scale-110";
                addDayBtn.classList.remove('hidden'); addGuideBtn.classList.remove('hidden');
                addFlightBtn.classList.remove('hidden'); addHotelBtn.classList.remove('hidden');
                if (addDayHeaderBtn) addDayHeaderBtn.classList.add('hidden');
            } else {
                btn.innerHTML = '<i class="fas fa-pen"></i>';
                btn.className = "w-10 h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center shadow-sm active:scale-90 transition-transform";
                addDayBtn.classList.add('hidden'); addGuideBtn.classList.add('hidden');
                addFlightBtn.classList.add('hidden'); addHotelBtn.classList.add('hidden');
                if (addDayHeaderBtn) addDayHeaderBtn.classList.remove('hidden');
            }
            renderAll();
        }

        function save() { localStorage.setItem('travel_data', JSON.stringify(appData)); }
        function resetData() { if(confirm("ÈáçÁΩÆË≥áÊñôÔºü")) { appData = defaultData; save(); location.reload(); } }

        function updateMeta(key, val) { appData.meta[key] = val; save(); }
        function addFlight() { appData.flights.push({ type: "ÂñÆÁ®ã", code: "", time: "", note: "" }); save(); renderLogistics(); }
        function updateFlight(i, key, val) { appData.flights[i][key] = val; save(); }
        function deleteFlight(i) { appData.flights.splice(i, 1); save(); renderLogistics(); }
        function addHotel() { appData.hotels.push({ name: "", dates: "", address: "", link: "" }); save(); renderLogistics(); }
        function updateHotel(i, key, val) { appData.hotels[i][key] = val; save(); }
        function deleteHotel(i) { appData.hotels.splice(i, 1); save(); renderLogistics(); }
        function updateDay(idx, key, val) { appData.itinerary[idx][key] = val; save(); }
        function addNewDay() { appData.itinerary.push({ day: `Day ${appData.itinerary.length + 1}`, title: "Êñ∞ÁöÑ‰∏ÄÂ§©", events: [] }); save(); renderPlan(); }
        function deleteDay(idx) { if(confirm("Âà™Èô§ÈÄôÊï¥Â§©Ôºü")) { appData.itinerary.splice(idx, 1); save(); renderPlan(); } }
        function updateEvent(dIdx, eIdx, key, val) { 
            if (!appData.itinerary[dIdx].events[eIdx].links) appData.itinerary[dIdx].events[eIdx].links = [];
            if (!appData.itinerary[dIdx].events[eIdx].images) appData.itinerary[dIdx].events[eIdx].images = [];
            appData.itinerary[dIdx].events[eIdx][key] = val; 
            save(); 
        }
        function addEvent(dIdx) { 
            appData.itinerary[dIdx].events.push({ startTime: "", endTime: "", title: "", links: [], images: [], desc: "", highlight: false }); 
            save(); 
            renderPlan(); 
        }
        function deleteEvent(dIdx, eIdx) { appData.itinerary[dIdx].events.splice(eIdx, 1); save(); renderPlan(); }
        function handleEnterKey(event, dIdx, eIdx) {
            if (event.key === 'Enter') {
                event.preventDefault();
                appData.itinerary[dIdx].events.splice(eIdx + 1, 0, { startTime: "", endTime: "", title: "", links: [], images: [], desc: "", highlight: false });
                save(); renderPlan();
                setTimeout(() => { const next = document.getElementById(`evt-title-${dIdx}-${eIdx + 1}`); if(next) next.focus(); }, 50);
            }
        }
        // Ë°åÁ®ã‰∫ã‰ª∂ÈÄ£ÁµêÂíåÂúñÁâáËôïÁêÜ
        function addEventLink(dIdx, eIdx) {
            if (!appData.itinerary[dIdx].events[eIdx].links) appData.itinerary[dIdx].events[eIdx].links = [];
            appData.itinerary[dIdx].events[eIdx].links.push("");
            save(); renderPlan();
        }
        function updateEventLink(dIdx, eIdx, lIdx, val) {
            if (!appData.itinerary[dIdx].events[eIdx].links) appData.itinerary[dIdx].events[eIdx].links = [];
            appData.itinerary[dIdx].events[eIdx].links[lIdx] = val;
            save();
        }
        function deleteEventLink(dIdx, eIdx, lIdx) {
            appData.itinerary[dIdx].events[eIdx].links.splice(lIdx, 1);
            save(); renderPlan();
        }
        function handleEventImages(event, dIdx, eIdx) {
            const files = Array.from(event.target.files);
            if (!appData.itinerary[dIdx].events[eIdx].images) appData.itinerary[dIdx].events[eIdx].images = [];
            let processed = 0;
            files.forEach(file => {
                compressImage(file, (base64) => {
                    appData.itinerary[dIdx].events[eIdx].images.push(base64);
                    processed++;
                    if (processed === files.length) {
                        save(); renderPlan();
                    }
                });
            });
        }
        function deleteEventImage(dIdx, eIdx, imgIdx) {
            appData.itinerary[dIdx].events[eIdx].images.splice(imgIdx, 1);
            save(); renderPlan();
        }
        // Â∞éË¶ΩËôïÁêÜÂáΩÊï∏
        function updateGuide(idx, key, val) { 
            if (!appData.guides[idx].links) appData.guides[idx].links = [];
            if (!appData.guides[idx].images) appData.guides[idx].images = [];
            appData.guides[idx][key] = val; 
            save(); 
            renderGuide(); 
        }
        function addNewGuide() { 
            appData.guides.push({ title: "", content: "", icon: "fa-heart", images: [], links: [] }); 
            save(); 
            renderGuide(); 
        }
        function deleteGuide(idx) { if(confirm("Âà™Èô§Ôºü")) { appData.guides.splice(idx, 1); save(); renderGuide(); } }
        function addGuideLink(idx) {
            if (!appData.guides[idx].links) appData.guides[idx].links = [];
            appData.guides[idx].links.push("");
            save(); renderGuide();
        }
        function updateGuideLink(idx, lIdx, val) {
            if (!appData.guides[idx].links) appData.guides[idx].links = [];
            appData.guides[idx].links[lIdx] = val;
            save();
        }
        function deleteGuideLink(idx, lIdx) {
            appData.guides[idx].links.splice(lIdx, 1);
            save(); renderGuide();
        }
        function handleGuideImages(event, idx) {
            const files = Array.from(event.target.files);
            if (!appData.guides[idx].images) appData.guides[idx].images = [];
            let processed = 0;
            files.forEach(file => {
                compressImage(file, (base64) => {
                    appData.guides[idx].images.push(base64);
                    processed++;
                    if (processed === files.length) {
                        save(); renderGuide();
                    }
                });
            });
        }
        function deleteGuideImage(idx, imgIdx) {
            appData.guides[idx].images.splice(imgIdx, 1);
            save(); renderGuide();
        }

        // --- LISTS & WALLET ---
        let checklist = JSON.parse(localStorage.getItem('travel_checklist')) || [{text: 'Ë≠∑ÁÖß', checked: false, highlight: false}];
        let expenses = JSON.parse(localStorage.getItem('travel_expenses')) || [];
        let currentPhotoBase64 = null;

        function initWalletAndLists() {
            const savedRate = localStorage.getItem('travel_rate');
            if(savedRate) document.getElementById('exchange-rate').value = savedRate;
            renderExpenses(); renderChecklist();
            const savedMemo = localStorage.getItem('travel_memo');
            if(savedMemo) { document.getElementById('memo-area').value = savedMemo; parseMemoLinks(savedMemo); }
            document.getElementById('memo-area').addEventListener('input', (e) => { localStorage.setItem('travel_memo', e.target.value); parseMemoLinks(e.target.value); });
        }
        function renderChecklist() {
            const c = document.getElementById('checklist-container'); c.innerHTML = '';
            checklist.forEach((item, i) => {
                const starClass = item.highlight ? 'text-yellow-400' : 'text-gray-200';
                const bgClass = item.highlight ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-white';
                c.innerHTML += `
                    <div class="flex items-center p-4 rounded-2xl mb-2 ${bgClass} soft-shadow group">
                        <div class="drag-handle mr-2 text-gray-300"><i class="fas fa-grip-vertical"></i></div>
                        <div onclick="toggleCheck(${i})" class="flex-1 flex items-center cursor-pointer">
                            <i class="fas ${item.checked?'fa-check-circle text-pink-300':'fa-circle text-pink-100'} mr-3 text-lg"></i>
                            <span class="${item.checked?'line-through text-gray-400':'font-medium text-pink-800'}">${item.text}</span>
                        </div>
                        <button onclick="toggleCheckStar(${i})" class="mr-3 ${starClass}"><i class="fas fa-star"></i></button>
                        <button onclick="deleteCheck(${i})" class="text-pink-200 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
            });
            localStorage.setItem('travel_checklist', JSON.stringify(checklist));
            initSortables();
        }
        function toggleCheck(i) { checklist[i].checked = !checklist[i].checked; renderChecklist(); }
        function toggleCheckStar(i) { checklist[i].highlight = !checklist[i].highlight; renderChecklist(); }
        function addCheckItem() { const v = document.getElementById('new-check-item').value; if(v){ checklist.push({text:v, checked:false, highlight:false}); document.getElementById('new-check-item').value=''; renderChecklist(); } }
        function deleteCheck(i) { checklist.splice(i, 1); renderChecklist(); }

        function calculateInput() { const input = document.getElementById('expense-math'); try { input.value = Math.round(Function('"use strict";return (' + input.value.replace(/[^0-9+\-*/().]/g, '') + ')')()); } catch(e){} }
        function handlePhotoPreview(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxWidth = 300; let w = img.width, h = img.height; if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h); currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6); document.getElementById('photo-name').innerText = input.files[0].name; }; img.src = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
        function addExpense() { const desc = document.getElementById('expense-desc').value; const amount = parseFloat(document.getElementById('expense-math').value); if(!desc || isNaN(amount)) return alert('Ë´ãËº∏ÂÖ•È†ÖÁõÆËàáÈáëÈ°ç'); expenses.unshift({ id: Date.now(), desc, amount, photo: currentPhotoBase64, date: new Date().toLocaleDateString() }); try { localStorage.setItem('travel_expenses', JSON.stringify(expenses)); document.getElementById('expense-desc').value = ''; document.getElementById('expense-math').value = ''; document.getElementById('expense-photo').value = ''; document.getElementById('photo-name').innerText = ''; currentPhotoBase64 = null; renderExpenses(); } catch(e) { alert('Á©∫ÈñìÂ∑≤Êªø'); expenses.shift(); } }
        function renderExpenses() { const list = document.getElementById('expense-list'); const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.22; let totalJPY = 0; list.innerHTML = ''; expenses.forEach(item => { totalJPY += item.amount; list.innerHTML += `<div class="bg-white p-4 rounded-2xl flex items-center justify-between soft-shadow mb-2"><div class="flex items-center gap-3">${item.photo ? `<img src="${item.photo}" class="w-12 h-12 rounded-xl object-cover border border-pink-100" onclick="viewImage('${item.photo}')">` : '<div class="w-12 h-12 bg-pink-50 rounded-xl flex items-center justify-center"><i class="fas fa-shopping-bag text-pink-300"></i></div>'}<div><div class="font-bold text-pink-800">${item.desc}</div><div class="text-xs text-pink-300">${item.date}</div></div></div><div class="text-right"><div class="font-bold text-pink-600">¬•${item.amount}</div><div class="text-xs text-gray-400">‚âà NT$${Math.round(item.amount*rate)}</div></div><button onclick="deleteExpense(${item.id})" class="ml-2 text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button></div>`; }); document.getElementById('total-jpy').innerText = totalJPY.toLocaleString(); document.getElementById('total-twd').innerText = Math.round(totalJPY * rate).toLocaleString(); }
        function deleteExpense(id) { if(confirm('Âà™Èô§Ôºü')) { expenses = expenses.filter(e=>e.id!==id); localStorage.setItem('travel_expenses', JSON.stringify(expenses)); renderExpenses(); } }
        function updateWalletUI() { localStorage.setItem('travel_rate', document.getElementById('exchange-rate').value); renderExpenses(); }
        function viewImage(src) { const w = window.open(""); w.document.write('<img src="'+src+'" style="width:100%">'); }
        function parseMemoLinks(t) { const m = t.match(/(https?:\/\/[^\s]+)/g); const c = document.getElementById('memo-links-preview'); c.innerHTML = ''; if(m) m.forEach(u => c.innerHTML += `<a href="${u}" target="_blank" class="text-xs bg-sky-50 text-sky-500 px-3 py-1 rounded-full border border-sky-100 truncate max-w-full block"><i class="fas fa-link mr-1"></i> ${u.substring(0,30)}...</a>`); }
        function exportData() { const d = { appData, expenses, checklist, memo: localStorage.getItem('travel_memo'), rate: localStorage.getItem('travel_rate') }; document.getElementById('data-area').value = JSON.stringify(d); document.getElementById('copy-btn').classList.remove('hidden'); alert('‰ª£Á¢ºÂ∑≤Áî¢Áîü'); }
        function importData() { const v = document.getElementById('data-area').value.trim(); if(!v) return alert('Ë´ãË≤º‰∏ä‰ª£Á¢º'); if(confirm('Á¢∫ÂÆöË¶ÜËìãÔºü')) { try { const d = JSON.parse(v); if(d.appData) localStorage.setItem('travel_data', JSON.stringify(d.appData)); if(d.expenses) localStorage.setItem('travel_expenses', JSON.stringify(d.expenses)); if(d.checklist) localStorage.setItem('travel_checklist', JSON.stringify(d.checklist)); if(d.memo) localStorage.setItem('travel_memo', d.memo); if(d.rate) localStorage.setItem('travel_rate', d.rate); location.reload(); } catch(e) { alert('‰ª£Á¢ºÈåØË™§'); } } }
        function copyToClipboard() { const a = document.getElementById('data-area'); a.select(); navigator.clipboard.writeText(a.value).then(()=>alert('Â∑≤Ë§áË£Ω')); }
        function switchListTab(tab) {
            const checklistDiv = document.getElementById('content-checklist');
            const memoDiv = document.getElementById('content-memo');
            const checklistBtn = document.getElementById('tab-btn-checklist');
            const memoBtn = document.getElementById('tab-btn-memo');
            
            if (tab === 'checklist') {
                checklistDiv.classList.remove('hidden');
                memoDiv.classList.add('hidden');
                checklistBtn.classList.add('bg-white', 'shadow-sm', 'text-pink-600');
                checklistBtn.classList.remove('text-pink-400');
                memoBtn.classList.remove('bg-white', 'shadow-sm', 'text-pink-600');
                memoBtn.classList.add('text-pink-400');
            } else {
                checklistDiv.classList.add('hidden');
                memoDiv.classList.remove('hidden');
                memoBtn.classList.add('bg-white', 'shadow-sm', 'text-pink-600');
                memoBtn.classList.remove('text-pink-400');
                checklistBtn.classList.remove('bg-white', 'shadow-sm', 'text-pink-600');
                checklistBtn.classList.add('text-pink-400');
            }
        }
        function switchTab(id) { document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('block')); document.getElementById('view-'+id).classList.remove('hidden'); document.getElementById('view-'+id).classList.add('block'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.add('text-pink-300')); const m = {'plan':0,'guide':1,'wallet':2,'lists':3,'info':4}; const btn = document.querySelectorAll('.nav-item')[m[id]]; btn.classList.add('active'); btn.classList.remove('text-pink-300'); document.getElementById('app-content').scrollTop = 0; }

        window.onload = function() { 
            renderAll(); 
            initWalletAndLists();
            // ÂàùÂßãÂåñÊôÇÈ°ØÁ§∫Êñ∞Â¢ûÊåâÈàïÔºàÈùûÁ∑®ËºØÊ®°ÂºèÔºâ
            const addDayHeaderBtn = document.getElementById('add-day-header-btn');
            if (addDayHeaderBtn && !isEditMode) {
                addDayHeaderBtn.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
